<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>OpenNotes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="icon" type="image/png" href="resources/favicon.png">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <style>
    :root{
      --bg: #f8f9fa;
      --panel: #ffffff;
      --panel-2: #e9ecef;
      --text: #212529;
      --muted: #6c757d;
      --accent: #96bfea;
      --accent-2: #b9d9f9;
      --shadow:0 10px 30px rgba(0,0,0,0.1);
      --radius:16px;
      --radius-sm:12px;
      --radius-lg:22px;
      --gap:14px;
      --gap-lg:22px;
      --dark-header: #12171d;
      --footer-bg: #1e252e;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:"Noto Sans", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      display: flex;
      flex-direction: column;
    }

    .material-symbols-outlined {
      font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
      font-size: 24px;
      display: flex;
    }
    
    /* Redesigned Header */
    .title-section{
      height: 50vh;
      background: var(--dark-header);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      z-index: 1;
    }
    .title-logo {
        width: 75vw;
        height: auto;
        max-width: 600px;
    }
    .logo-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-bottom: 20px;
    }
    .logo-container p {
        color: rgba(255,255,255,0.8);
        font-size: 14px;
        margin-top: 10px;
        display: flex;
        align-items: center;
        gap: 6px;
    }
    .logo-container p img {
        height: 23.4px;
        width: auto;
    }
    .line {
      width: 33vw;
      height: 2px;
      background: rgba(255,255,255,0.8);
      margin: 20px auto;
    }
    @media (max-width: 860px){
      .title-logo { width: 90vw; }
    }

    /* Controls */
    .controls{
      display:flex; align-items:center; justify-content:space-between;
      gap:var(--gap); flex-wrap:wrap;
      background:var(--panel);
      border-bottom-left-radius: 40px;
      border-bottom-right-radius: 40px;
      padding:10px 18px;
      box-shadow:0 4px 12px rgba(0,0,0,0.08);
      position: relative;
      z-index: 2;
    }

    .left, .right{display:flex; align-items:center; gap:8px}
    .chip{
      background:var(--panel-2);
      padding:8px 10px; border-radius:999px; color:var(--text);
      display:flex; align-items:center; gap:8px; border:1px solid rgba(0,0,0,0.06);
      cursor:pointer;
    }
    .chip:hover{
      background: rgba(125,211,252,0.1);
    }
    .chip select{
      background:transparent; color:var(--text); border:none; outline:none;
      font:inherit; appearance:none; padding-right:18px; cursor:pointer;
    }
    .chip .dot{
      width:8px; height:8px; border-radius:50%; background:var(--accent);
      box-shadow:0 0 12px var(--accent);
    }

    /* Expanding search */
    .search{
      display:flex; align-items:center; gap:8px;
      background:var(--panel-2); border-radius:999px;
      padding:8px 12px; border:1px solid rgba(0,0,0,0.06);
      transition: box-shadow .2s ease;
    }
    .search:hover{ box-shadow:0 0 0 2px rgba(125,211,252,0.25) inset; }
    .search svg{width:18px; height:18px; opacity:0.9}
    .search input{
      width:110px; background:transparent; border:none; outline:none; color:var(--text);
      transition: width .25s ease; font:inherit;
    }
    .search input::placeholder{ color:var(--muted) }
    .search:focus-within input{ width:240px }

    /* Toggle buttons */
    .toggle{
      display:flex; gap:8px; background:var(--panel-2); padding:6px;
      border-radius:999px; border:1px solid rgba(0,0,0,0.06);
    }
    .btn{
      background:transparent; color:var(--text); border:none; border-radius:999px;
      padding:8px 12px; display:flex; align-items:center; gap:8px;
      cursor:pointer; transition: background .2s, transform .1s, box-shadow .2s;
    }
    .btn:hover{ background:rgba(0,0,0,0.06) }
    .btn:active{ transform: translateY(1px) }
    .btn svg{width:18px; height:18px}
    .btn.active{
      background:linear-gradient(90deg, rgba(125,211,252,0.18), rgba(167,243,208,0.15));
      box-shadow:0 0 0 2px rgba(125,211,252,0.18) inset;
    }

    /* Main content */
    .wrap{ padding:18px; z-index: 0; position:relative; margin-top: 36px; margin-bottom: 36px; flex: 1; }
    .grid{
      display:grid; grid-template-columns:repeat(auto-fill, minmax(240px, 1fr));
      gap:18px; align-items:stretch;
    }
    .list{ display:flex; flex-direction:column; gap:12px }

    /* Card / Item */
    .card {
      position: relative;
      transition: transform .2s ease, box-shadow .2s ease;
      z-index: 0;
      background:var(--panel);
      border-radius:var(--radius);
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      overflow: hidden;
      cursor: pointer;
    }
    .card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.15);
      z-index: 10;
    }

    .thumb{
      background:var(--panel-2);
      height:180px; display:flex; align-items:center; justify-content:center;
      overflow:hidden; position:relative;
    }
    .thumb canvas, .thumb img, .thumb iframe, .thumb embed{
      width:100%; height:100%; object-fit:cover; border-radius:12px;
    }
    .fmt-badge{
      position:absolute; bottom:10px; left:10px; padding:6px 10px;
      font-size:12px; font-weight:600; border-radius:999px;
      background:rgba(255,255,255,0.55); color:var(--text); border:1px solid rgba(0,0,0,0.1);
      backdrop-filter: blur(4px);
    }
    .fmt-pdf{ box-shadow:0 0 0 2px rgba(125,211,252,0.35) inset }
    .fmt-docx{ box-shadow:0 0 0 2px rgba(167,243,208,0.35) inset }

    .body{ padding:12px 14px 14px }
    .title-line{
      font-weight:600; font-size:16px; margin:6px 0 6px; line-height:1.2;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .meta{
      display:flex; align-items:center; gap:8px; color:var(--muted); font-size:12px;
    }
    .meta .dot{ width:4px; height:4px; border-radius:50%; background:var(--muted) }

    .stats{
      margin-top:10px; display:flex; align-items:center; gap:12px; color:var(--muted); font-size:12px;
    }
    .stat{ display:inline-flex; align-items:center; gap:6px }
    .stat svg{ width:16px; height:16px; opacity:0.85 }

    .download-btn {
      background: var(--accent);
      color: #fff;
      border: none;
      padding: 6px;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    .download-btn svg {
      width: 18px;
      height: 18px;
      fill: #fff;
    }

    /* List view item */
    .row{
      display:grid; grid-template-columns:86px 1fr auto; gap:14px;
      align-items:center; background:var(--panel); border:1px solid rgba(0,0,0,0.06);
      border-radius:var(--radius); padding:10px; box-shadow:0 4px 12px rgba(0,0,0,0.05);
      transition: transform .2s, box-shadow .2s;
      cursor: pointer;
    }
    .row:hover{ transform: translateY(-1px) }
    .row .thumb{ height:66px; border-radius:12px }
    .row .main{
      display:grid; grid-template-columns: minmax(200px, 2fr) repeat(4, minmax(90px, 1fr));
      gap:10px; align-items:center;
    }
    .row .main .cell{ display:flex; align-items:center; gap:6px; min-width:0 }
    .row .title-line{ margin:0; font-size:15px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis }
    .row .right-end{ display:flex; align-items:center; gap:8px }

    /* Overlay viewer */
    .overlay{
      position:fixed; inset:0; background:rgba(255,255,255,0.72); backdrop-filter: blur(8px);
      display:none; z-index:1000; padding:20px;
      opacity:0; transition: opacity .2s ease;
    }
    .overlay.open{
      display:block;
      opacity:1;
    }
    .viewer{
      background:rgba(255,255,255,0.85);
      border:1px solid rgba(0,0,0,0.08);
      box-shadow:var(--shadow);
      border-radius:var(--radius-lg);
      height:100%; display:grid;
      grid-template-columns: 1fr minmax(280px, 360px);
      overflow:hidden;
      backdrop-filter: blur(16px);
    }
    .viewer .left{
      padding:12px; background:var(--panel-2); border-right:1px solid rgba(0,0,0,0.06);
    }
    .docframe{
      width:100%; height:100%; border:none; border-radius:12px; background:var(--panel-2);
    }
    .viewer .right{
      padding:16px; display:flex; flex-direction:column; gap:10px;
    }
    .viewer .right .title{ justify-content:flex-start; padding:0; font-size:22px }
    .kv{ color:var(--muted); font-size:13px; display:flex; gap:8px; align-items:center }
    .kv strong{ color:var(--text); font-weight:600 }
    .back{
      position:absolute; bottom:26px; left:26px; z-index:1001;
      background:rgba(255,255,255,0.4); color:var(--text); border:1px solid rgba(0,0,0,0.18);
      padding:8px 12px; border-radius:999px; display:flex; align-items:center; gap:8px;
      cursor:pointer; backdrop-filter: blur(4px);
      transition: transform .1s, background .2s, box-shadow .2s;
    }
    .back:hover{ background:rgba(255,255,255,0.5) }
    .back:active{ transform: translateY(1px) }

    .overlay-content {
        padding: 2rem;
        text-align: left;
        color: #333;
        line-height: 1.6;
        font-family: "Noto Sans", sans-serif;
        background: #fff;
        border-radius: 12px;
        height: 100%;
        overflow-y: auto;
    }
    .overlay-content h1, .overlay-content h2 {
        color: var(--text);
    }
    .overlay-content a {
        color: var(--accent);
        text-decoration: none;
    }
    .overlay-content a:hover {
        text-decoration: underline;
    }

    .styled-btn {
      background: var(--panel-2);
      color: var(--text);
      border: 1px solid rgba(0,0,0,0.08);
      border-radius: 999px;
      padding: 8px 12px;
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 500;
      cursor: pointer;
      transition: background .2s, transform .1s, box-shadow .2s;
      text-decoration: none; /* remove underline for links */
      font-size: 1rem;
    }
    .styled-btn:hover {
      background: rgba(0,0,0,0.06);
    }
    .styled-btn:active {
      transform: translateY(1px);
    }
    .styled-btn svg {
      width: 18px;
      height: 18px;
    }

    .styled-btn.download-accent {
      background: var(--accent);
      color: white;
      border-color: rgba(255,255,255,0.1);
    }
    .styled-btn.download-accent svg {
      fill: white;
    }


    /* Helpers */
    .pill{
      color:#001; background:var(--accent); border-radius:999px; padding:4px 8px; font-weight:700; font-size:12px;
    }
    .pill.docx{ background:var(--accent-2) }

    a.clean{ color:inherit; text-decoration:none; cursor: pointer; }
    .muted{ color:var(--muted) }
    .hide{ display:none }

    .icon-only {
      padding: 8px;
    }

    .sort-wrapper {
      position: relative;
    }

    .custom-dropdown {
      position: absolute;
      top: 110%;
      left: 0;
      background: var(--panel);
      border: 1px solid rgba(0,0,0,0.1);
      border-radius: 8px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.15);
      z-index: 20;
      display: flex;
      flex-direction: column;
      min-width: 180px;
      opacity: 0;
      pointer-events: none;
      transform: translateY(10px);
      transition: opacity 0.15s ease, transform 0.15s ease;
    }

    .custom-dropdown.open {
      opacity: 1;
      pointer-events: auto;
      transform: translateY(0);
    }
    
    .custom-dropdown .option {
        padding: 8px 12px;
        cursor: pointer;
        transition: background 0.15s;
    }

    .custom-dropdown .option:hover {
        background: rgba(125,211,252,0.1);
    }
    .custom-dropdown .option.active {
      background: var(--accent);
      color: white;
    }

    /* Footer */
    footer {
      background: var(--footer-bg);
      color: rgba(255,255,255,0.6);
      padding: 18px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: auto;
      font-size: 14px;
    }
    footer .left {
      display: flex;
      gap: 16px;
      align-items: center;
    }
    footer .left a {
      color: inherit;
      text-decoration: none;
      transition: color .2s;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    footer .left a:hover {
      color: rgba(255,255,255,0.9);
    }
    footer .left a .icon {
      width: 18px;
      height: 18px;
      fill: rgba(255,255,255,0.6);
    }
    footer .left a:hover .icon {
      fill: rgba(255,255,255,0.9);
    }
    .total-views {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .total-views .material-symbols-outlined {
      font-size: 20px;
      color: rgba(255,255,255,0.6);
    }
    .total-views span {
      font-weight: 600;
      color: rgba(255,255,255,0.9);
    }


    /* Small screens */
    @media (max-width: 860px){
      .viewer{ grid-template-columns: 1fr; }
      .viewer .right{ border-top:1px solid rgba(0,0,0,0.06) }
    }
  </style>
</head>
<body>

  <header>
    <div class="title-section">
      <div class="logo-container">
        <img src="resources/logo.svg" alt="OpenNotes Logo" class="title-logo" />
        <div class="line"></div>
        <p>
          the open platform for notes by 
          <a href="https://ingenium.rf.gd" target="_blank" rel="noopener">
            <img src="resources/ingenium.png" alt="Ingenium Logo" />
          </a>
        </p>
      </div>
    </div>
    <div class="controls">
      <select id="sortSelect" style="display:none">
        <option value="updated-desc" selected>Last updated ↓</option>
        <option value="updated-asc">Last updated ↑</option>
        <option value="title-asc">Title A→Z</option>
        <option value="title-desc">Title Z→A</option>
        <option value="format-asc">Format A→Z</option>
      </select>

      <select id="formatSelect" style="display:none">
        <option value="all" selected>All formats</option>
        <option value="pdf">PDF</option>
        <option value="docx">DOCX</option>
      </select>

      <div class="left">
        <div class="sort-wrapper">
          <button id="sortBtn" class="btn icon-only" title="Sort (Last Updated)">
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M3 4h18v2H3V4zm4 7h10v2H7v-2zm3 7h4v2h-4v-2z"/></svg>
          </button>
          <div id="sortDropdown" class="custom-dropdown hidden">
            <div data-sort="updated-desc" class="option active">Last updated ↓</div>
            <div data-sort="updated-asc" class="option">Last updated ↑</div>
            <div data-sort="title-asc" class="option">Title A→Z</div>
            <div data-sort="title-desc" class="option">Title Z→A</div>
            <div data-sort="format-asc" class="option">Format A→Z</div>
          </div>
        </div>
        <div class="toggle" role="tablist" aria-label="Type selector">
          <button id="allBtn" class="btn active" data-type="all">ALL</button>
          <button id="pdfBtn" class="btn" data-type="pdf">PDF</button>
          <button id="docxBtn" class="btn" data-type="docx">DOCX</button>
        </div>
        <div class="search" role="search">
          <svg viewBox="0 0 24 24" fill="currentColor"><path d="M15.5 14h-.79l-.28-.27a6.471 6.471 0 0 0 1.57-4.23C15.99 6.01 12.98 3 9.5 3S3.01 6.01 3.01 9.5 6.02 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
          <input id="searchInput" type="text" placeholder="Search notes..." aria-label="Search notes" />
        </div>
      </div>
      <div class="right">
        <button id="uploadBtn" class="btn icon-only" title="How to Upload">
          <span class="material-symbols-outlined">upload</span>
        </button>
        <div class="toggle" role="tablist" aria-label="View mode">
          <button id="gridBtn" class="btn active icon-only" aria-pressed="true" title="Box view">
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M3 3h8v8H3V3zm10 0h8v8h-8V3zM3 13h8v8H3v-8zm10 0h8v8h-8v-8z"/></svg>
          </button>
          <button id="listBtn" class="btn icon-only" aria-pressed="false" title="List view">
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M3 5h18v2H3V5zm0 6h18v2H3v-2zm0 6h18v2H3v-2z"/></svg>
          </button>
        </div>
      </div>
    </div>
  </header>

  <main class="wrap">
    <section id="itemsContainer" class="grid" aria-live="polite"></section>
  </main>

  <div id="overlay" class="overlay" aria-hidden="true">
    <button id="backBtn" class="back" aria-label="Back">
      <svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
      Back
    </button>
    <div class="viewer" role="dialog" aria-modal="true" aria-label="Document viewer">
      <div class="left">
        <iframe id="docFrame" class="docframe" title="Document preview"></iframe>
      </div>
      <div class="right">
        <div class="title" id="ovTitle">Title</div>
        <div class="kv"><span class="pill" id="ovFormat">PDF</span></div>
        <div class="kv">Date: <strong id="ovDate">—</strong></div>
        <div class="kv">Author: <strong id="ovAuthor">—</strong></div>
        <div class="kv">Views: <strong id="ovViews">0</strong></div>
        <div class="kv">Downloads: <strong id="ovDownloads">0</strong></div>
        <div style="margin-top:8px; display:flex; flex-direction:column; gap:10px;">
          <a id="ovOpenRaw" class="styled-btn" target="_blank" rel="noopener">
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M14 3v2h3.59l-9.83 9.83 1.41 1.41L19 6.41V10h2V3z"/><path d="M5 5h5V3H3v7h2z"/></svg>
            View Raw
          </a>
          <button id="ovDownload" class="styled-btn download-accent">
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M5 20h14v-2H5v2zM12 2v12l4-4h-3V2h-2v8H8l4 4z"/></svg>
            Download
          </button>
        </div>
      </div>
    </div>
  </div>

  <div id="infoOverlay" class="overlay" aria-hidden="true">
    <button id="infoBackBtn" class="back" aria-label="Back">
      <svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
      Back
    </button>
    <div class="viewer" style="grid-template-columns: 1fr;">
      <div class="overlay-content" id="infoContent"></div>
    </div>
  </div>

  <footer>
    <div class="left">
      <a href="#" class="info-link" data-md="resources/terms-privacy.md">Terms & Privacy</a>
      <a href="#" class="info-link" data-md="resources/contact.md">Contact Us</a>
      <a href="#" class="info-link" data-md="resources/about.md">About</a>
      <a href="https://github.com/Tebby2008/OpenNotes" target="_blank" rel="noopener">
        <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
          <path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.89 8.207 11.415.6.11.82-.26.82-.577 0-.285-.01-1.04-.015-2.04-3.33...
        </svg> Github 
      </a>
    </div>
    <div class="right total-views">
      <span class="material-symbols-outlined">visibility</span>
      <span id="websiteViews">0</span>
    </div>
  </footer>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
  <script>
    // --- Configuration (set these to your repo) --- 
    const REPO_OWNER = "Tebby2008"; 
    const REPO_NAME = "OpenNotes"; 
    const BRANCH = "main"; 
    const NOTES_PATH = "Notes"; 
    const API_URL = "https://open-notes.tebby2008-li.workers.dev"; 

    (function tryAutoDetect(){ 
      try{ 
        const host = location.hostname; 
        const path = location.pathname.replace(/^\/+/,'').split('/'); 
        const isPages = host.endsWith(".github.io"); 
        if(isPages){ 
          const owner = host.split(".github.io")[0]; 
          const repo = path[0] || REPO_NAME; 
          if(REPO_OWNER.startsWith("<")) window['__owner']=owner; 
          if(REPO_NAME.startsWith("<")) window['__repo']=repo; 
        } 
      }catch(e){} 
    })(); 
    const owner = window.__owner || REPO_OWNER; 
    const repo = window.__repo || REPO_NAME; 
    
    // --- State --- 
    let allItems = []; 
    let viewMode = "grid"; 
    let filterType = "all";

    // --- Elements --- 
    const container = document.getElementById("itemsContainer"); 
    const sortSelect = document.getElementById("sortSelect"); 
    const formatSelect = document.getElementById("formatSelect"); 
    const searchInput = document.getElementById("searchInput"); 
    const gridBtn = document.getElementById("gridBtn"); 
    const listBtn = document.getElementById("listBtn"); 
    const overlay = document.getElementById("overlay"); 
    const backBtn = document.getElementById("backBtn"); 
    const docFrame = document.getElementById("docFrame"); 
    const ovTitle = document.getElementById("ovTitle"); 
    const ovFormat = document.getElementById("ovFormat"); 
    const ovDate = document.getElementById("ovDate"); 
    const ovAuthor = document.getElementById("ovAuthor"); 
    const ovViews = document.getElementById("ovViews"); 
    const ovDownloads = document.getElementById("ovDownloads"); 
    const ovOpenRaw = document.getElementById("ovOpenRaw"); 
    const ovDownload = document.getElementById("ovDownload"); 
    const infoOverlay = document.getElementById("infoOverlay"); 
    const infoBackBtn = document.getElementById("infoBackBtn"); 
    const infoContent = document.getElementById("infoContent"); 
    const uploadBtn = document.getElementById("uploadBtn"); 
    const infoLinks = document.querySelectorAll('.info-link'); 
    const websiteViewsEl = document.getElementById('websiteViews'); 
    
    // New elements for the type selector
    const allBtn = document.getElementById('allBtn');
    const pdfBtn = document.getElementById('pdfBtn');
    const docxBtn = document.getElementById('docxBtn');

    // --- Utils --- 
    const sleep = (ms)=> new Promise(r=>setTimeout(r,ms)); 
    const fmtDate = (iso)=> { 
      if(!iso) return "—"; 
      const d = new Date(iso); 
      const dd = String(d.getDate()).padStart(2,'0'); 
      const mm = String(d.getMonth()+1).padStart(2,'0'); 
      const yyyy = d.getFullYear(); 
      return `${dd}-${mm}-${yyyy}`; 
    }; 
    const stripExt = (name)=> name.replace(/\.[^/.]+$/, ""); 
    const extOf = (name)=> (name.split('.').pop() || "").toLowerCase(); 

    // --- API Calls & Local State Updates --- 
    async function incView(item) { 
      try { 
        const res = await fetch(`${API_URL}?type=note&noteId=${item.path}&counter=views`, { method: 'POST' }); 
        const data = await res.json(); 
        if (data && data.views !== undefined) { 
          item.views = data.views; 
          item.downloads = data.downloads; 
          return { views: item.views, downloads: item.downloads }; 
        } 
      } catch (e) { 
        console.error('Failed to increment view count:', e); 
      } 
      return null; 
    } 
    async function incDownload(item) { 
      try { 
        const res = await fetch(`${API_URL}?type=note&noteId=${item.path}&counter=downloads`, { method: 'POST' }); 
        const data = await res.json(); 
        if (data && data.downloads !== undefined) { 
          item.views = data.views; 
          item.downloads = data.downloads; 
          return { views: item.views, downloads: item.downloads }; 
        } 
      } catch (e) { 
        console.error('Failed to increment download count:', e); 
      } 
      return null; 
    } 
    async function incWebsiteView(){ 
      try { 
        const res = await fetch(`${API_URL}?type=website`, { method: 'POST' }); 
        if (res.ok) { 
          const data = await res.json(); 
          if (data.views !== undefined) { 
            return data.views; 
          } 
        } 
      } catch (e) { 
        console.error('Failed to increment website view count:', e); 
      } 
      return null; 
    } 
    async function getApiKeys(){ 
      const res = await fetch(`${API_URL}?list=true`, { method: 'GET' }); 
      if(!res.ok) return []; 
      return await res.json(); 
    } 

    // --- Data fetch --- 
    async function getFileContent(filePath){ 
      const url = `https://raw.githubusercontent.com/${owner}/${repo}/${BRANCH}/${encodeURI(filePath)}`; 
      try { 
        const response = await fetch(url); 
        const data = await response.text();
        return data; 
      }catch(e){ 
        console.error("Error fetching file content:", e); 
      } 
      return null; 
    } 
    
    // --- Rendering functions --- 
    const renderThumbnail = async (item, canvas, size = 180) => {
        const ext = extOf(item.name);
        if (ext === "pdf") {
            try {
                const pdfjsLib = window['pdfjs-dist/build/pdf'];
                pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js`;

                const loadingTask = pdfjsLib.getDocument(item.download_url);
                const pdf = await loadingTask.promise;
                const page = await pdf.getPage(1);
                const scale = size / (page.getViewport({ scale: 1 }).width);
                const viewport = page.getViewport({ scale: scale });

                const context = canvas.getContext('2d');
                canvas.height = viewport.height;
                canvas.width = viewport.width;

                await page.render({ canvasContext: context, viewport: viewport }).promise;
            } catch (e) {
                console.error("Error rendering PDF thumbnail:", e);
                // Fallback to default icon
                canvas.parentElement.innerHTML = '<span class="material-symbols-outlined" style="font-size: 80px; color: var(--muted);">description</span>';
            }
        } else if (ext === "docx") {
            // Cannot programmatically render DOCX preview, fallback to icon
            canvas.parentElement.innerHTML = '<span class="material-symbols-outlined" style="font-size: 80px; color: var(--muted);">description</span>';
        } else {
            // Generic file icon for other types
            canvas.parentElement.innerHTML = '<span class="material-symbols-outlined" style="font-size: 80px; color: var(--muted);">description</span>';
        }
    };

    function createCard(item){
      const card = document.createElement("a");
      card.href = "#";
      card.className = "card clean";
      card.onclick = (e) => {
        e.preventDefault();
        openViewer(item);
      };

      const thumbContainer = document.createElement("div");
      thumbContainer.className = "thumb";
      const canvas = document.createElement("canvas");
      thumbContainer.appendChild(canvas);
      renderThumbnail(item, canvas, 240); // Render thumbnail for card view

      const badge = document.createElement("div");
      badge.className = `fmt-badge fmt-${extOf(item.name)}`;
      badge.textContent = extOf(item.name).toUpperCase();
      thumbContainer.appendChild(badge);

      const body = document.createElement("div");
      body.className = "body";
      body.innerHTML = `
        <h3 class="title-line">${stripExt(item.name)}</h3>
        <div class="meta">
          <span>${fmtDate(item.last_updated)}</span>
          <span class="dot"></span>
          <a class="clean" href="https://github.com/${owner}/${repo}/commits/${BRANCH}/${item.path}" target="_blank" rel="noopener">${item.author}</a>
        </div>
        <div class="stats">
          <span class="stat">
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zM12 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
            <span class="views-count">${item.views || 0}</span>
          </span>
          <span class="stat">
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 14.5c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5z"/></svg>
            <span class="downloads-count">${item.downloads || 0}</span>
          </span>
        </div>
      `;

      card.appendChild(thumbContainer);
      card.appendChild(body);
      return card;
    }

    function createRow(item){
      const row = document.createElement("a");
      row.href = "#";
      row.className = "row clean";
      row.onclick = (e) => {
        e.preventDefault();
        openViewer(item);
      };

      const thumbContainer = document.createElement("div");
      thumbContainer.className = "thumb";
      const canvas = document.createElement("canvas");
      thumbContainer.appendChild(canvas);
      renderThumbnail(item, canvas, 86); // Render thumbnail for list view

      const main = document.createElement("div");
      main.className = "main";
      main.innerHTML = `
        <div class="cell">
          <h3 class="title-line">${stripExt(item.name)}</h3>
          <div class="pill ${extOf(item.name)}">${extOf(item.name).toUpperCase()}</div>
        </div>
        <div class="cell muted">${fmtDate(item.last_updated)}</div>
        <div class="cell muted">${item.author}</div>
        <div class="cell muted"><span class="material-symbols-outlined" style="font-size: 16px;">visibility</span> <span class="views-count">${item.views || 0}</span></div>
        <div class="cell muted"><span class="material-symbols-outlined" style="font-size: 16px;">download</span> <span class="downloads-count">${item.downloads || 0}</span></div>
      `;

      const rightEnd = document.createElement("div");
      rightEnd.className = "right-end";
      rightEnd.innerHTML = `
        <div class="download-btn">
          <svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18"><path d="M19.35 10.04C18.67 6.59 15.64 4 12 4c-3.72 0-6.75 2.7-7.23 6.22C2.79 10.74 1 13.06 1 16c0 3.31 2.69 6 6 6h12c3.31 0 6-2.69 6-6 0-2.94-1.79-5.26-4.65-5.96zM17 18H7v-2h10v2zm-4-4v-4h-2v4h-3l4 4 4-4h-3z"/></svg>
        </div>
      `;

      row.appendChild(thumbContainer);
      row.appendChild(main);
      row.appendChild(rightEnd);
      return row;
    }
    
    function render(notes = allItems){
      container.innerHTML = "";
      container.className = viewMode;

      const filteredNotes = notes.filter(item => {
        const itemExt = extOf(item.name);
        return filterType === 'all' || itemExt === filterType;
      });

      if(filteredNotes.length === 0){
        container.innerHTML = `
          <div style="background:var(--panel);border:1px solid rgba(0,0,0,0.06);border-radius:var(--radius);padding:18px;">
            <p style="margin:0; text-align:center; color:var(--muted)">No notes found matching your criteria.</p>
          </div>
        `;
        return;
      }

      // Sort logic
      const sortValue = sortSelect.value;
      filteredNotes.sort((a,b)=>{
        if(sortValue === "updated-desc") return new Date(b.last_updated) - new Date(a.last_updated);
        if(sortValue === "updated-asc") return new Date(a.last_updated) - new Date(b.last_updated);
        if(sortValue === "title-asc") return stripExt(a.name).localeCompare(stripExt(b.name));
        if(sortValue === "title-desc") return stripExt(b.name).localeCompare(stripExt(a.name));
        if(sortValue === "format-asc") return extOf(a.name).localeCompare(extOf(b.name));
        return 0;
      });

      filteredNotes.forEach(item=>{
        if(viewMode === "grid"){
          container.appendChild(createCard(item));
        } else {
          container.appendChild(createRow(item));
        }
      });
    }

    // --- Overlay & Viewer logic ---
    function openViewer(item){
      const rawUrl = item.download_url;
      const viewerUrl = `https://tebby2008.github.io/OpenNotes/view.html?file=${encodeURIComponent(rawUrl)}`;

      docFrame.src = viewerUrl;
      ovTitle.textContent = stripExt(item.name);
      ovFormat.textContent = extOf(item.name).toUpperCase();
      ovDate.textContent = fmtDate(item.last_updated);
      ovAuthor.textContent = item.author;
      ovViews.textContent = item.views || 0;
      ovDownloads.textContent = item.downloads || 0;
      ovOpenRaw.href = rawUrl;
      ovDownload.onclick = () => {
        incDownload(item).then(updated => {
          if (updated) {
            ovViews.textContent = updated.views;
            ovDownloads.textContent = updated.downloads;
          }
        });
        window.open(item.download_url, '_blank');
      };

      incView(item).then(updated => {
        if (updated) {
          ovViews.textContent = updated.views;
          ovDownloads.textContent = updated.downloads;
          render(); // Re-render the main grid/list to update counts
        }
      });
      overlay.classList.add("open");
    }

    function closeOverlay(event, overlayEl) {
      if (event.target === overlayEl) {
        overlayEl.classList.remove("open");
        setTimeout(() => {
          overlayEl.style.display = "none";
        }, 200); // Wait for the transition to finish
      }
    }

    // --- Event Listeners ---
    gridBtn.addEventListener("click", ()=>{
      viewMode = "grid";
      gridBtn.classList.add("active");
      listBtn.classList.remove("active");
      render();
    });

    listBtn.addEventListener("click", ()=>{
      viewMode = "list";
      listBtn.classList.add("active");
      gridBtn.classList.remove("active");
      render();
    });

    backBtn.addEventListener("click", ()=>{
      overlay.classList.remove("open");
      setTimeout(() => {
        overlay.style.display = "none";
      }, 200);
    });

    document.getElementById('typeBtn').addEventListener('click', (e) => {
        const type = e.target.dataset.type;
        filterType = type;
        document.querySelectorAll('.controls .toggle .btn').forEach(btn => btn.classList.remove('active'));
        e.target.classList.add('active');
        render();
    });

    allBtn.addEventListener('click', () => {
        filterType = 'all';
        allBtn.classList.add('active');
        pdfBtn.classList.remove('active');
        docxBtn.classList.remove('active');
        render();
    });

    pdfBtn.addEventListener('click', () => {
        filterType = 'pdf';
        allBtn.classList.remove('active');
        pdfBtn.classList.add('active');
        docxBtn.classList.remove('active');
        render();
    });

    docxBtn.addEventListener('click', () => {
        filterType = 'docx';
        allBtn.classList.remove('active');
        pdfBtn.classList.remove('active');
        docxBtn.classList.add('active');
        render();
    });

    searchInput.addEventListener("input", (e)=>{
      const query = e.target.value.toLowerCase();
      const filtered = allItems.filter(item => stripExt(item.name).toLowerCase().includes(query));
      render(filtered);
    });

    const sortBtn = document.getElementById('sortBtn');
    const sortDropdown = document.getElementById('sortDropdown');

    sortBtn.addEventListener('click', () => {
        sortDropdown.classList.toggle('open');
    });

    sortDropdown.addEventListener('click', (e) => {
        const newSort = e.target.dataset.sort;
        if (newSort) {
            sortSelect.value = newSort;
            document.querySelectorAll('#sortDropdown .option').forEach(opt => opt.classList.remove('active'));
            e.target.classList.add('active');
            sortDropdown.classList.remove('open');
            render();
        }
    });

    document.addEventListener('click', (e) => {
        if (!sortBtn.contains(e.target) && !sortDropdown.contains(e.target)) {
            sortDropdown.classList.remove('open');
        }
    });

    overlay.addEventListener("click", (event) => closeOverlay(event, overlay));
    infoOverlay.addEventListener("click", (event) => closeOverlay(event, infoOverlay));
    infoBackBtn.addEventListener("click", () => {
      infoOverlay.classList.remove("open");
      setTimeout(() => {
        infoOverlay.style.display = "none";
      }, 200);
    });

    uploadBtn.addEventListener('click', () => {
        fetchMarkdownFile('resources/upload.md');
    });

    infoLinks.forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            const mdFile = e.target.dataset.md;
            fetchMarkdownFile(mdFile);
        });
    });

    async function fetchMarkdownFile(filePath) {
        try {
            const content = await getFileContent(filePath);
            if (content) {
                infoContent.innerHTML = marked.parse(content);
                infoOverlay.style.display = 'block';
                setTimeout(() => infoOverlay.classList.add('open'), 10);
            } else {
                infoContent.innerHTML = '<h1>Error</h1><p>Could not load the file.</p>';
                infoOverlay.style.display = 'block';
                setTimeout(() => infoOverlay.classList.add('open'), 10);
            }
        } catch (e) {
            console.error("Error fetching markdown:", e);
        }
    }

    // --- Init ---
    async function init(){
      try{
        const notes_metadata = [
          {
            "name": "AP Calculus AB Notes.pdf",
            "path": "Notes/AP Calculus AB Notes.pdf",
            "download_url": "https://raw.githubusercontent.com/Tebby2008/OpenNotes/main/Notes/AP%20Calculus%20AB%20Notes.pdf",
            "author": "tebby",
            "last_updated": "2025-08-17T02:06:16Z",
            "is_ai_generated": false
          },
          {
            "name": "AP Calculus AB Review Sheet.pdf",
            "path": "Notes/AP Calculus AB Review Sheet.pdf",
            "download_url": "https://raw.githubusercontent.com/Tebby2008/OpenNotes/main/Notes/AP%20Calculus%20AB%20Review%20Sheet.pdf",
            "author": "Tebby2008",
            "last_updated": "2025-08-17T01:29:18Z",
            "is_ai_generated": false
          },
          {
            "name": "AP Calculus BC Exclusive.pdf",
            "path": "Notes/AP Calculus BC Exclusive.pdf",
            "download_url": "https://raw.githubusercontent.com/Tebby2008/OpenNotes/main/Notes/AP%20Calculus%20BC%20Exclusive.pdf",
            "author": "Tebby2008",
            "last_updated": "2025-08-17T01:29:18Z",
            "is_ai_generated": false
          },
          {
            "name": "AP Macroeconomics Notes.pdf",
            "path": "Notes/AP Macroeconomics Notes.pdf",
            "download_url": "https://raw.githubusercontent.com/Tebby2008/OpenNotes/main/Notes/AP%20Macroeconomics%20Notes.pdf",
            "author": "tebby",
            "last_updated": "2025-08-17T01:35:00Z",
            "is_ai_generated": false
          },
          {
            "name": "IB Chemistry Yr 1 Study Guide (AI).docx",
            "path": "Notes/IB Chemistry Yr 1 Study Guide (AI).docx",
            "download_url": "https://raw.githubusercontent.com/Tebby2008/OpenNotes/main/Notes/IB%20Chemistry%20Yr%201%20Study%20Guide%20(AI).docx",
            "author": "tebby",
            "last_updated": "2025-08-17T01:57:26Z",
            "is_ai_generated": true
          },
          {
            "name": "IB Economics Real World Examples.pdf",
            "path": "Notes/IB Economics Real World Examples.pdf",
            "download_url": "https://raw.githubusercontent.com/Tebby2008/OpenNotes/main/Notes/IB%20Economics%20Real%20World%20Examples.pdf",
            "author": "Tebby2008",
            "last_updated": "2025-08-17T01:29:18Z",
            "is_ai_generated": false
          },
          {
            "name": "IB Economics Yr 1 Study Guide (AI).docx",
            "path": "Notes/IB Economics Yr 1 Study Guide (AI).docx",
            "download_url": "https://raw.githubusercontent.com/Tebby2008/OpenNotes/main/Notes/IB%20Economics%20Yr%201%20Study%20Guide%20(AI).docx",
            "author": "tebby",
            "last_updated": "2025-08-17T01:57:26Z",
            "is_ai_generated": true
          },
          {
            "name": "Python Guide (AI).docx",
            "path": "Notes/Python Guide (AI).docx",
            "download_url": "https://raw.githubusercontent.com/Tebby2008/OpenNotes/main/Notes/Python%20Guide%20(AI).docx",
            "author": "tebby",
            "last_updated": "2025-08-17T02:42:25Z",
            "is_ai_generated": true
          },
          {
            "name": "SAT Reading & Writing Notes.pdf",
            "path": "Notes/SAT Reading & Writing Notes.pdf",
            "download_url": "https://raw.githubusercontent.com/Tebby2008/OpenNotes/main/Notes/SAT%20Reading%20%26%20Writing%20Notes.pdf",
            "author": "Tebby2008",
            "last_updated": "2025-08-17T01:29:18Z",
            "is_ai_generated": false
          }
        ];
        
        allItems = notes_metadata;

        const allNoteKeys = allItems.map(n => n.path);
        const apiKeys = await getApiKeys();
        const noteKeysToDelete = apiKeys.filter(k => !allNoteKeys.includes(k));
        for (const key of noteKeysToDelete) {
          console.log(`Deleting counter for removed note: ${key}`);
          await fetch(`${API_URL}?noteId=${key}`, { method: 'DELETE' });
        }

        const notePromises = allItems.map(async (note) => {
          try {
            const res = await fetch(`${API_URL}?noteId=${note.path}`, { method: 'GET' });
            if (res.ok) {
              const data = await res.json();
              note.views = data.views || 0;
              note.downloads = data.downloads || 0;
            } else {
              note.views = 0;
              note.downloads = 0;
            }
          } catch (e) {
            console.error('Failed to fetch count for note:', note.path, e);
            note.views = 0;
            note.downloads = 0;
          }
        });
        await Promise.all(notePromises);

        const newViews = await incWebsiteView();
        if (newViews !== null) {
          websiteViewsEl.textContent = newViews;
        }

        render();

      }catch(e){
        console.error(e);
        container.innerHTML = `
          <div style="background:var(--panel);border:1px solid rgba(255,255,255,0.08);border-radius:16px;padding:18px;">
            <div style="font-weight:600; font-size:18px; color:var(--text);">Error loading notes.</div>
            <p style="color:var(--muted); font-size:14px; margin-top:6px;">An error occurred while trying to fetch the notes. This could be due to a network issue or an incorrect configuration.</p>
          </div>
        `;
      }
    }
    
    init();

  </script>
</body>
</html>

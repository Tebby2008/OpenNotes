<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>OpenNotes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Noto Sans -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- PDF.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.4.168/pdf.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script>
    if (window['pdfjsLib']) {
      pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.4.168/pdf.worker.min.js";
    }
  </script>

  <style>
    :root {
      --bg: #0b0c0f;
      --panel: #12151a;
      --panel-2: #161a21;
      --text: #eef2f6;
      --muted: #a6b1bf;
      --line: rgba(255,255,255,0.08);
      --accent: #7dd3fc;   /* sky pastel blue */
      --accent-2: #a7f3d0; /* neon pastel green */
      --shadow: 0 10px 30px rgba(0,0,0,0.25);
      --radius: 16px; --radius-lg: 22px;
    }
    :root[data-theme="light"] {
      --bg: #f7fafc; --panel: #ffffff; --panel-2:#f3f6fa;
      --text:#0b1420; --muted:#5e6b7a; --line: rgba(0,0,0,0.08);
      --shadow: 0 10px 30px rgba(0,0,0,0.09);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font-family:"Noto Sans", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }

    /* Header */
    .banner{
      position:sticky; top:0; z-index:30; backdrop-filter: blur(8px);
      background:linear-gradient(180deg, color-mix(in oklab, var(--panel) 92%, transparent) 0%, transparent 100%);
      padding:56px 18px 28px; /* taller */
    }
    .title{
      display:flex; align-items:center; justify-content:center; font-weight:700; font-size:34px; letter-spacing:.2px; margin-bottom:14px;
    }
    .title .dot{width:10px;height:10px;border-radius:50%;background:var(--accent);margin-left:10px;box-shadow:0 0 20px var(--accent)}
    .controls{
      display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;
      background:var(--panel); border:1px solid var(--line); border-radius:var(--radius); padding:10px; box-shadow:var(--shadow);
    }
    .left,.right{display:flex;align-items:center;gap:10px}

    /* Icon buttons */
    .icon-btn{
      position:relative; background:var(--panel-2); border:1px solid var(--line); color:var(--text);
      border-radius:999px; padding:8px; cursor:pointer; display:inline-flex; align-items:center; justify-content:center;
      transition: background .2s, transform .1s, box-shadow .2s, color .2s;
    }
    .icon-btn:hover{ background: color-mix(in oklab, var(--panel-2) 75%, var(--accent) 25%) }
    .icon-btn:active{ transform: translateY(1px) }
    .icon-btn svg{ width:18px; height:18px }
    .icon-btn.active{
      background: linear-gradient(90deg, color-mix(in oklab, var(--accent) 18%, transparent), color-mix(in oklab, var(--accent-2) 14%, transparent));
      box-shadow:0 0 0 2px color-mix(in oklab, var(--accent) 18%, transparent) inset;
    }

    /* Search */
    .search{
      display:flex; align-items:center; gap:8px; background:var(--panel-2);
      border:1px solid var(--line); border-radius:999px; padding:8px 12px; transition: box-shadow .2s;
    }
    .search:hover{ box-shadow: 0 0 0 2px color-mix(in oklab, var(--accent) 25%, transparent) inset; }
    .search svg{ width:18px; height:18px; color:var(--muted) }
    .search input{
      width:110px; background:transparent; border:none; outline:none; color:var(--text); transition: width .25s ease; font:inherit;
    }
    .search input::placeholder{ color:var(--muted) }
    .search:focus-within input{ width:240px }

    /* Format toggle shows text */
    .fmt-toggle{
      display:inline-flex; align-items:center; gap:8px; background:var(--panel-2);
      border:1px solid var(--line); border-radius:999px; padding:8px 12px; cursor:pointer;
    }
    .fmt-label{ font-weight:700; letter-spacing:.5px; font-size:12px }

    /* Dropdown (Sort) */
    .dropdown{ position:relative }
    .menu{
      position:absolute; top:calc(100% + 8px); left:0; min-width:220px; background:var(--panel);
      border:1px solid var(--line); border-radius:14px; box-shadow:var(--shadow);
      padding:8px; display:none; z-index:100;
    }
    .menu.open{ display:block; animation: fadeIn .12s ease }
    @keyframes fadeIn{from{opacity:0; transform: translateY(-4px)} to{opacity:1; transform: translateY(0)}}
    .menu button{
      width:100%; text-align:left; background:transparent; border:none; color:var(--text);
      padding:10px; border-radius:10px; cursor:pointer; display:flex; align-items:center; gap:10px;
    }
    .menu button:hover{ background:var(--panel-2) }
    .menu button .radio{
      width:16px; height:16px; border-radius:999px; border:2px solid var(--muted); display:inline-flex; align-items:center; justify-content:center;
    }
    .menu button[aria-checked="true"] .radio{ border-color: var(--accent) }
    .menu button[aria-checked="true"] .radio::after{ content:""; width:8px; height:8px; border-radius:999px; background:var(--accent) }

    /* Content layout */
    .wrap{ padding:18px }
    .grid{ display:grid; grid-template-columns:repeat(auto-fill, minmax(240px,1fr)); gap:18px; align-items:stretch }
    .list{ display:flex; flex-direction:column; gap:12px }

    /* Cards */
    .card{
      background:var(--panel); border:1px solid var(--line); border-radius:var(--radius-lg); box-shadow:var(--shadow);
      overflow:hidden; position:relative; transition: transform .18s ease, box-shadow .2s ease;
    }
    .card:hover{ transform: translateY(-2px) }
    .thumb{
      background: linear-gradient(180deg, color-mix(in oklab, var(--panel-2) 70%, #0f1320) 0%, var(--panel-2) 100%);
      height:180px; display:flex; align-items:center; justify-content:center; position:relative; overflow:hidden;
    }
    .thumb canvas, .thumb img{ width:100%; height:100%; object-fit:cover; border-radius:12px }
    .fmt-badge{
      position:absolute; bottom:10px; left:10px; padding:6px 10px; font-size:12px; font-weight:700; border-radius:999px;
      background: rgba(0,0,0,0.6); color:#fff; border:1px solid rgba(255,255,255,0.2); backdrop-filter: blur(4px);
    }
    .body{ padding:12px 14px 16px }
    .title-line{ font-weight:600; font-size:16px; margin:6px 0 6px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis }
    .meta{ display:flex; align-items:center; gap:8px; color:var(--muted); font-size:12px }
    .meta .dot{ width:4px; height:4px; border-radius:50%; background:var(--muted) }
    .stats{ margin-top:10px; display:flex; align-items:center; gap:12px; font-size:12px; color:var(--text) }
    .stat{ display:inline-flex; align-items:center; gap:6px }
    .stat svg{ width:16px; height:16px; color:var(--text); opacity:.9 }

    /* Hover reveal */
    .reveal{
      position:absolute; left:10px; right:10px; bottom:-14px; background:var(--panel); border:1px solid var(--line);
      border-radius:14px; padding:10px; display:flex; justify-content:flex-end; gap:10px; opacity:0; transform: translateY(6px) scale(0.98);
      pointer-events:none; box-shadow:0 16px 36px rgba(0,0,0,0.28); transition: opacity .18s, transform .18s;
      z-index:5;
    }
    .card.peek .reveal{ opacity:1; transform: translateY(0) scale(1); pointer-events:auto }

    .download-btn{
      background:var(--accent); color:#061016; border:none; padding:10px 12px; border-radius:999px; display:inline-flex; align-items:center; gap:8px;
      cursor:pointer; font-weight:700; box-shadow:0 8px 20px color-mix(in oklab, var(--accent) 30%, transparent);
      transition: transform .1s, filter .2s, box-shadow .2s;
    }
    .download-btn:hover{ filter:brightness(1.05); box-shadow:0 10px 24px color-mix(in oklab, var(--accent) 40%, transparent) }
    .download-btn:active{ transform: translateY(1px) }
    .download-btn svg{ width:18px; height:18px; color:currentColor }

    /* List rows */
    .row{
      display:grid; grid-template-columns:86px 1fr auto; gap:14px; align-items:center;
      background:var(--panel); border:1px solid var(--line); border-radius:var(--radius); padding:10px; box-shadow:var(--shadow);
      transition: transform .18s, box-shadow .2s; position:relative;
    }
    .row:hover{ transform: translateY(-1px) }
    .row .thumb{ height:66px; border-radius:12px }
    .row .main{ display:grid; grid-template-columns:minmax(200px,2fr) repeat(4, minmax(90px,1fr)); gap:10px; align-items:center }
    .row .cell{ display:flex; align-items:center; gap:6px; min-width:0 }
    .row .title-line{ margin:0; font-size:15px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis }
    .right-end{ display:flex; align-items:center; gap:8px }

    /* Overlay */
    .overlay{ position:fixed; inset:0; background:rgba(2,4,8,0.72); backdrop-filter: blur(8px); display:none; z-index:1000; padding:20px }
    .overlay.open{ display:block; animation: fadeIn .18s ease }
    .viewer{
      position:relative; background:var(--panel); border:1px solid var(--line); box-shadow:var(--shadow);
      border-radius:var(--radius-lg); height:100%; display:grid; grid-template-columns:1fr minmax(280px,360px); overflow:hidden;
    }
    .viewer .left{ padding:12px; background:var(--panel-2); border-right:1px solid var(--line); overflow:hidden }
    .viewer .right{ padding:16px; display:flex; flex-direction:column; gap:10px }
    .viewer .right .title{ justify-content:flex-start; padding:0; font-size:22px }
    .back{
      position:absolute; top:26px; left:26px; z-index:1001; background:rgba(0,0,0,0.4); color:#fff;
      border:1px solid rgba(255,255,255,0.18); padding:8px 12px; border-radius:999px; display:inline-flex; align-items:center; gap:8px;
      cursor:pointer; backdrop-filter: blur(4px); transition: transform .1s, background .2s;
    }
    .back:hover{ background:rgba(0,0,0,0.5) }
    .back:active{ transform: translateY(1px) }

    .pdfScroll{ width:100%; height:100%; overflow:auto; border-radius:12px; background:var(--panel); display:flex; flex-direction:column; align-items:center; gap:12px; padding:12px }
    .pdfPage{ background:var(--panel-2); border:1px solid var(--line); border-radius:12px; overflow:hidden }
    .docframe{ width:100%; height:100%; border:none; border-radius:12px; background:#0c0f14 }

    .pill{ color:#001; background:var(--accent); border-radius:999px; padding:4px 8px; font-weight:700; font-size:12px }
    .pill.docx{ background:var(--accent-2) }

    /* Warning banner */
    .warn{ margin:12px 18px 0; padding:10px 12px; border-radius:12px; border:1px solid var(--line); background:color-mix(in oklab, var(--accent) 12%, var(--panel-2) 88%); color:var(--text) }

    @media (max-width: 860px){
      .viewer{ grid-template-columns:1fr }
      .viewer .right{ border-top:1px solid var(--line) }
    }
  </style>
</head>
<body>
  <header class="banner">
    <div class="title">OpenNotes <span class="dot"></span></div>

    <div id="configWarn" class="warn" style="display:none;">
      Set REPO_OWNER, REPO_NAME, BRANCH in the script to load Notes/.
    </div>

    <div class="controls">
      <div class="left">
        <!-- Filter (sort) funnel icon + dropdown -->
        <div class="dropdown">
          <button id="filterBtn" class="icon-btn" aria-haspopup="menu" aria-expanded="false" title="Filter & sort">
            <!-- funnel icon -->
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M3 4h18v2l-7 7v6l-4 3v-9L3 6V4z"/></svg>
          </button>
          <div id="filterMenu" class="menu" role="menu" aria-label="Sort">
            <button role="menuitemradio" data-sort="updated-desc" aria-checked="true"><span class="radio"></span> Last updated ↓</button>
            <button role="menuitemradio" data-sort="updated-asc" aria-checked="false"><span class="radio"></span> Last updated ↑</button>
            <button role="menuitemradio" data-sort="title-asc" aria-checked="false"><span class="radio"></span> Title A→Z</button>
            <button role="menuitemradio" data-sort="title-desc" aria-checked="false"><span class="radio"></span> Title Z→A</button>
            <button role="menuitemradio" data-sort="format-asc" aria-checked="false"><span class="radio"></span> Format A→Z</button>
          </div>
        </div>

        <!-- Format toggle with text -->
        <button id="fmtToggle" class="fmt-toggle" title="Format">
          <svg id="fmtIcon" viewBox="0 0 24 24" fill="currentColor"><path d="M4 6h16v2H4V6zm0 5h10v2H4v-2zm0 5h16v2H4v-2z"/></svg>
          <span id="fmtLabel" class="fmt-label">ALL</span>
        </button>

        <!-- Search (keep text) -->
        <div class="search" role="search">
          <svg viewBox="0 0 24 24" fill="currentColor"><path d="M15.5 14h-.79l-.28-.27a6.471 6.471 0 0 0 1.57-4.23C15.99 6.01 12.98 3 9.5 3S3.01 6.01 3.01 9.5 6.02 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
          <input id="searchInput" type="text" placeholder="Search notes..." aria-label="Search notes" />
        </div>
      </div>

      <div class="right">
        <!-- View toggle (icons only) -->
        <button id="gridBtn" class="icon-btn active" aria-pressed="true" title="Box view">
          <svg viewBox="0 0 24 24" fill="currentColor"><path d="M3 3h8v8H3V3zm10 0h8v8h-8V3zM3 13h8v8H3v-8zm10 0h8v8h-8v-8z"/></svg>
        </button>
        <button id="listBtn" class="icon-btn" aria-pressed="false" title="List view">
          <svg viewBox="0 0 24 24" fill="currentColor"><path d="M3 5h18v2H3V5zm0 6h18v2H3v-2zm0 6h18v2H3v-2z"/></svg>
        </button>

        <!-- Theme toggle -->
        <button id="themeBtn" class="icon-btn" title="Toggle theme">
          <svg id="themeIcon" viewBox="0 0 24 24" fill="currentColor"><path d="M20 15.31A8 8 0 0 1 8.69 4 8.001 8.001 0 1 0 20 15.31z"/></svg>
        </button>
      </div>
    </div>
  </header>

  <main class="wrap">
    <section id="itemsContainer" class="grid" aria-live="polite"></section>
  </main>

  <!-- Overlay -->
  <div id="overlay" class="overlay" aria-hidden="true">
    <button id="backBtn" class="back" aria-label="Back">
      <svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
      Back
    </button>
    <div class="viewer" role="dialog" aria-modal="true" aria-label="Document viewer">
      <div class="left">
        <div id="pdfScroll" class="pdfScroll" hidden></div>
        <iframe id="docFrame" class="docframe" title="Document preview" hidden></iframe>
      </div>
      <div class="right">
        <div class="title" id="ovTitle">Title</div>
        <div><span class="pill" id="ovFormat">PDF</span></div>
        <div class="meta">Date: <strong id="ovDate" style="color:var(--text); margin-left:6px">—</strong></div>
        <div class="meta">Author: <strong id="ovAuthor" style="color:var(--text); margin-left:6px">—</strong></div>
        <div class="meta">Views: <strong id="ovViews" style="color:var(--text); margin-left:6px">0</strong></div>
        <div class="meta">Downloads: <strong id="ovDownloads" style="color:var(--text); margin-left:6px">0</strong></div>
        <div style="margin-top:8px; display:flex; gap:10px; flex-wrap:wrap;">
          <a id="ovOpenBlob" class="icon-btn" target="_blank" rel="noopener" title="Open on GitHub">
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M14 3v2h3.59l-9.83 9.83 1.41 1.41L19 6.41V10h2V3z"/><path d="M5 5h5V3H3v7h2z"/></svg>
          </a>
          <button id="ovDownload" class="download-btn" title="Direct download">
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M5 20h14v-2H5v2zM12 2v12l4-4h-3V2h-2v8H8l4 4z"/></svg>
            Download
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // --- REQUIRED: set these to your repo ---
    const REPO_OWNER = "<your-username-or-org>";
    const REPO_NAME  = "<your-repo>";
    const BRANCH     = "main"; // or "master"
    const NOTES_PATH = "Notes";

    // Show config warning if placeholders still present
    const configWarn = document.getElementById("configWarn");
    const configSet = !REPO_OWNER.startsWith("<") && !REPO_NAME.startsWith("<") && BRANCH;
    if(!configSet){ configWarn.style.display = "block"; }

    // --- State ---
    let allItems = []; // {name,title,path,download_url,html_url,format,updatedAt,author}
    let viewMode = "grid";         // grid | list
    let sortMode = "updated-desc"; // default
    let fmtMode  = "all";          // all | pdf | docx
    const countsKey = "opennotes-counts-v3";
    let counts = JSON.parse(localStorage.getItem(countsKey) || "{}");

    function saveCounts(){ localStorage.setItem(countsKey, JSON.stringify(counts)); }
    function getCounts(path){ counts[path] ||= {views:0, downloads:0}; return counts[path]; }
    function incView(path){ const c=getCounts(path); c.views++; saveCounts(); return c.views; }
    function incDownload(path){ const c=getCounts(path); c.downloads++; saveCounts(); return c.downloads; }

    // Elements
    const container = document.getElementById("itemsContainer");
    const searchInput = document.getElementById("searchInput");
    const gridBtn = document.getElementById("gridBtn");
    const listBtn = document.getElementById("listBtn");
    const themeBtn = document.getElementById("themeBtn");
    const themeIcon = document.getElementById("themeIcon");
    const filterBtn = document.getElementById("filterBtn");
    const filterMenu = document.getElementById("filterMenu");
    const fmtToggle = document.getElementById("fmtToggle");
    const fmtIcon = document.getElementById("fmtIcon");
    const fmtLabel = document.getElementById("fmtLabel");

    const overlay = document.getElementById("overlay");
    const backBtn = document.getElementById("backBtn");
    const pdfScroll = document.getElementById("pdfScroll");
    const docFrame = document.getElementById("docFrame");
    const ovTitle = document.getElementById("ovTitle");
    const ovFormat = document.getElementById("ovFormat");
    const ovDate = document.getElementById("ovDate");
    const ovAuthor = document.getElementById("ovAuthor");
    const ovViews = document.getElementById("ovViews");
    const ovDownloads = document.getElementById("ovDownloads");
    const ovOpenBlob = document.getElementById("ovOpenBlob");
    const ovDownload = document.getElementById("ovDownload");

    // Theme
    const themeKey = "opennotes-theme";
    (function initTheme(){
      const saved = localStorage.getItem(themeKey);
      if(saved) document.documentElement.setAttribute("data-theme", saved);
      updateThemeIcon();
    })();
    function toggleTheme(){
      const cur = document.documentElement.getAttribute("data-theme");
      const next = cur === "light" ? "dark" : (cur === "dark" ? "" : "light");
      if(next) document.documentElement.setAttribute("data-theme", next);
      else document.documentElement.removeAttribute("data-theme");
      localStorage.setItem(themeKey, next || "");
      updateThemeIcon();
    }
    function updateThemeIcon(){
      const theme = document.documentElement.getAttribute("data-theme");
      themeIcon.innerHTML = theme === "light"
        ? '<path d="M6.76 4.84l-1.8-1.79L3.17 4.84l1.79 1.79 1.8-1.79zM1 13h3v-2H1v2zm10 10h2v-3h-2v3zm7.03-20.97l-1.79 1.79 1.8 1.79 1.79-1.79-1.8-1.79zM20 11v2h3v-2h-3zM17.24 19.16l1.79 1.79 1.79-1.79-1.79-1.8-1.79 1.8zM4.84 17.24l-1.79 1.8 1.79 1.79 1.79-1.79-1.79-1.8zM12 5a7 7 0 0 0 0 14 7 7 0 0 0 0-14z"/>'
        : '<path d="M20 15.31A8 8 0 0 1 8.69 4 8.001 8.001 0 1 0 20 15.31z"/>';
    }
    themeBtn.addEventListener("click", toggleTheme);

    // Helpers
    const extOf = (n)=> (n.split('.').pop() || "").toLowerCase();
    const stripExt = (n)=> n.replace(/\.[^/.]+$/,"");
    const fmtDate = (iso)=> {
      if(!iso) return "—";
      const d = new Date(iso);
      return String(d.getDate()).padStart(2,'0') + "-" + String(d.getMonth()+1).padStart(2,'0') + "-" + d.getFullYear();
    };
    async function fetchArrayBuffer(url){
      const r = await fetch(url);
      if(!r.ok) throw new Error("Fetch failed");
      return await r.arrayBuffer();
    }

    // Data
    async function fetchNotes(){
      if(!configSet) throw new Error("Repo config not set");
      const url = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${encodeURIComponent(NOTES_PATH)}?ref=${encodeURIComponent(BRANCH)}`;
      const res = await fetch(url, { headers: { 'Accept': 'application/vnd.github+json' }});
      if(!res.ok){ throw new Error("Failed to load Notes/"); }
      const data = await res.json();
      const files = data.filter(x => x.type==="file" && ["pdf","docx"].includes(extOf(x.name)));

      const items = files.map(f => ({
        name: f.name,
        title: stripExt(f.name),
        path: f.path,
        download_url: f.download_url,
        html_url: f.html_url,
        format: extOf(f.name),
        updatedAt: null,
        author: null
      }));

      await Promise.all(items.map(async it=>{
        try{
          const commitsUrl = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/commits?path=${encodeURIComponent(it.path)}&per_page=1&sha=${encodeURIComponent(BRANCH)}`;
          const r = await fetch(commitsUrl, { headers: { 'Accept': 'application/vnd.github+json' }});
          if(r.ok){
            const arr = await r.json();
            if(arr && arr.length){
              const c = arr[0];
              it.updatedAt = c.commit?.author?.date || null;
              it.author = c.author?.login || c.commit?.author?.name || "Unknown";
            }
          }
        }catch(_){}
      }));

      return items;
    }

    // UI render
    function render(){
      const q = searchInput.value.trim().toLowerCase();
      let list = allItems.filter(x => fmtMode==="all" ? true : x.format===fmtMode);
      if(q) list = list.filter(x => x.title.toLowerCase().includes(q));

      list.sort((a,b)=>{
        switch(sortMode){
          case "title-asc": return a.title.localeCompare(b.title);
          case "title-desc": return b.title.localeCompare(a.title);
          case "format-asc": return a.format.localeCompare(b.format) || a.title.localeCompare(b.title);
          case "updated-asc": return (new Date(a.updatedAt||0)) - (new Date(b.updatedAt||0));
          case "updated-desc":
          default: return (new Date(b.updatedAt||0)) - (new Date(a.updatedAt||0));
        }
      });

      container.innerHTML = "";
      container.className = viewMode === "grid" ? "grid" : "list";
      list.forEach(it => container.appendChild(viewMode==="grid" ? renderCard(it) : renderRow(it)));
    }

    function renderFormatBadge(fmt){
      const span = document.createElement("span");
      span.className = "fmt-badge";
      span.textContent = fmt.toUpperCase();
      return span;
    }

    function fileIcon(fmt){
      const label = fmt.toUpperCase();
      const bg = fmt === "pdf" ? "color-mix(in oklab, var(--accent) 18%, transparent)" : "color-mix(in oklab, var(--accent-2) 22%, transparent)";
      return `
        <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;width:100%;height:100%;background:${bg}">
          <svg viewBox="0 0 24 24" fill="currentColor" width="42" height="42" aria-hidden="true" style="color: var(--text); opacity: .9;">
            <path d="M14 2H6a2 2 0 0 0-2 2v16c0 1.1.9 2 2 2h12a2 2 0 0 0 2-2V8l-6-6zM6 4h7v5h5v11H6V4z"/>
          </svg>
          <div class="pill ${fmt==='docx'?'docx':''}" style="margin-top:8px;">${label}</div>
        </div>
      `;
    }

    async function renderPdfThumb(url, canvas){
      const data = await fetchArrayBuffer(url);
      const pdf = await pdfjsLib.getDocument({ data }).promise;
      const page = await pdf.getPage(1);
      const base = page.getViewport({ scale: 1 });
      const targetW = canvas.parentElement.clientWidth || 240;
      const scale = Math.max(0.6, Math.min(1.6, targetW / (base.width * 1.2)));
      const vp = page.getViewport({ scale });
      canvas.width = vp.width; canvas.height = vp.height;
      await page.render({ canvasContext: canvas.getContext('2d'), viewport: vp }).promise;
    }

    function makeThumb(it){
      const holder = document.createElement("div");
      holder.className = "thumb";
      if(it.format === "pdf" && window['pdfjsLib']){
        const canvas = document.createElement("canvas");
        holder.appendChild(canvas);
        renderPdfThumb(it.download_url, canvas).catch(()=> holder.innerHTML = fileIcon("pdf"));
      }else{
        holder.innerHTML = fileIcon("docx");
      }
      holder.appendChild(renderFormatBadge(it.format));
      return holder;
    }

    function renderCard(it){
      const card = document.createElement("article");
      card.className = "card";
      card.tabIndex = 0; card.setAttribute("role","button"); card.setAttribute("aria-label", it.title);

      // delayed hover reveal
      let t=null;
      card.addEventListener("mouseenter", ()=> { t=setTimeout(()=> card.classList.add("peek"), 2000); });
      card.addEventListener("mouseleave", ()=> { clearTimeout(t); t=null; card.classList.remove("peek"); });

      const thumb = makeThumb(it);
      card.appendChild(thumb);

      const body = document.createElement("div");
      body.className = "body";
      body.innerHTML = `
        <div class="title-line">${it.title}</div>
        <div class="meta"><span>${it.author||"Unknown"}</span><span class="dot"></span><span>${fmtDate(it.updatedAt)}</span></div>
      `;

      const statsEl = document.createElement("div");
      statsEl.className = "stats";
      const c = getCounts(it.path);
      statsEl.innerHTML = `
        <span class="stat"><svg viewBox="0 0 24 24"><path d="M12 5c-7 0-10 7-10 7s3 7 10 7 10-7 10-7-3-7-10-7zm0 12c-2.8 0-5-2.24-5-5s2.2-5 5-5 5 2.24 5 5-2.2 5-5 5z"/><circle cx="12" cy="12" r="2.5"/></svg> <span data-view>${c.views}</span></span>
        <span class="stat"><svg viewBox="0 0 24 24"><path d="M5 20h14v-2H5v2zM12 2v12l4-4h-3V2h-2v8H8l4 4z"/></svg> <span data-dl>${c.downloads}</span></span>
      `;
      body.appendChild(statsEl);
      card.appendChild(body);

      const reveal = document.createElement("div");
      reveal.className = "reveal";
      const dlBtn = document.createElement("button");
      dlBtn.className = "download-btn";
      dlBtn.innerHTML = `<svg viewBox="0 0 24 24"><path d="M5 20h14v-2H5v2zM12 2v12l4-4h-3V2h-2v8H8l4 4z"/></svg> Download`;
      dlBtn.addEventListener("click",(e)=>{
        e.stopPropagation();
        incDownload(it.path);
        statsEl.querySelector('[data-dl]').textContent = getCounts(it.path).downloads;
        const a = document.createElement("a");
        a.href = it.download_url; a.download = it.name; document.body.appendChild(a); a.click(); a.remove();
      });
      reveal.appendChild(dlBtn);
      card.appendChild(reveal);

      card.addEventListener("click", ()=> openOverlay(it, statsEl));
      card.addEventListener("keydown", (e)=> { if(e.key==="Enter"||e.key===" "){ e.preventDefault(); openOverlay(it, statsEl);} });

      return card;
    }

    function renderRow(it){
      const row = document.createElement("article");
      row.className = "row";
      row.tabIndex = 0; row.setAttribute("role","button"); row.setAttribute("aria-label", it.title);

      const thumb = makeThumb(it); thumb.style.height="66px";
      row.appendChild(thumb);

      const main = document.createElement("div");
      main.className = "main";
      const c = getCounts(it.path);
      main.innerHTML = `
        <div class="cell"><div class="title-line">${it.title}</div></div>
        <div class="cell" style="color:var(--muted)">${it.author||"Unknown"}</div>
        <div class="cell" style="color:var(--muted)">${fmtDate(it.updatedAt)}</div>
        <div class="cell"><span class="pill ${it.format==='docx'?'docx':''}">${it.format.toUpperCase()}</span></div>
        <div class="cell" style="color:var(--text)">
          <span class="stat"><svg viewBox="0 0 24 24"><path d="M12 5c-7 0-10 7-10 7s3 7 10 7 10-7 10-7-3-7-10-7zm0 12c-2.8 0-5-2.24-5-5s2.2-5 5-5 5 2.24 5 5-2.2 5-5 5z"/><circle cx="12" cy="12" r="2.5"/></svg> <span data-view>${c.views}</span></span>
          <span class="stat" style="margin-left:10px;"><svg viewBox="0 0 24 24"><path d="M5 20h14v-2H5v2zM12 2v12l4-4h-3V2h-2v8H8l4 4z"/></svg> <span data-dl>${c.downloads}</span></span>
        </div>
      `;
      row.appendChild(main);

      const rightEnd = document.createElement("div");
      rightEnd.className = "right-end";
      const dlBtn = document.createElement("button");
      dlBtn.className = "icon-btn"; dlBtn.title = "Download";
      dlBtn.innerHTML = `<svg viewBox="0 0 24 24"><path d="M5 20h14v-2H5v2zM12 2v12l4-4h-3V2h-2v8H8l4 4z"/></svg>`;
      dlBtn.addEventListener("click",(e)=>{
        e.stopPropagation();
        incDownload(it.path);
        main.querySelector('[data-dl]').textContent = getCounts(it.path).downloads;
        const a = document.createElement("a");
        a.href = it.download_url; a.download = it.name; document.body.appendChild(a); a.click(); a.remove();
      });
      rightEnd.appendChild(dlBtn);
      row.appendChild(rightEnd);

      row.addEventListener("click", ()=> openOverlay(it, main));
      row.addEventListener("keydown", (e)=> { if(e.key==="Enter"||e.key===" "){ e.preventDefault(); openOverlay(it, main);} });

      return row;
    }

    // Overlay
    async function openOverlay(it, statsNode){
      overlay.classList.add("open"); overlay.setAttribute("aria-hidden","false");
      incView(it.path);
      const c = getCounts(it.path);
      statsNode?.querySelector?.('[data-view]')?.textContent = c.views;

      ovTitle.textContent = it.title;
      ovFormat.textContent = it.format.toUpperCase();
      ovFormat.className = `pill ${it.format==='docx'?'docx':''}`;
      ovDate.textContent = fmtDate(it.updatedAt);
      ovAuthor.textContent = it.author || "Unknown";
      ovViews.textContent = c.views;
      ovDownloads.textContent = c.downloads;

      ovOpenBlob.href = it.html_url;
      ovDownload.onclick = ()=>{
        incDownload(it.path);
        ovDownloads.textContent = getCounts(it.path).downloads;
        const a=document.createElement("a"); a.href=it.download_url; a.download=it.name; document.body.appendChild(a); a.click(); a.remove();
      };

      // viewer
      docFrame.hidden = true; pdfScroll.hidden = true; docFrame.src = "about:blank"; pdfScroll.innerHTML = "";
      if(it.format === "pdf"){
        pdfScroll.hidden = false;
        try { await renderPdfInOverlay(it.download_url, pdfScroll); }
        catch { pdfScroll.innerHTML = `<div style="padding:16px; color:var(--muted)">Could not render PDF.</div>`; }
      }else{
        docFrame.hidden = false;
        docFrame.src = `https://view.officeapps.live.com/op/embed.aspx?src=${encodeURIComponent(it.download_url)}`;
      }
    }
    function closeOverlay(){
      overlay.classList.remove("open"); overlay.setAttribute("aria-hidden","true");
      docFrame.src="about:blank"; pdfScroll.innerHTML="";
    }
    backBtn.addEventListener("click", closeOverlay);
    overlay.addEventListener("click", (e)=> { if(e.target === overlay) closeOverlay(); });
    document.addEventListener("keydown", (e)=> { if(e.key==="Escape" && overlay.classList.contains("open")) closeOverlay(); });

    async function renderPdfInOverlay(url, container){
      const data = await fetchArrayBuffer(url);
      const pdf = await pdfjsLib.getDocument({ data }).promise;
      const pages = [];
      for(let i=1; i<=pdf.numPages; i++){
        const canvas = document.createElement("canvas");
        canvas.className = "pdfPage"; canvas.style.maxWidth = "980px"; canvas.style.width = "100%";
        container.appendChild(canvas);
        pages.push({i, canvas, rendered:false});
      }
      const io = new IntersectionObserver((entries)=>{
        entries.forEach(async entry=>{
          if(!entry.isIntersecting) return;
          const p = pages.find(x=>x.canvas===entry.target);
          if(!p || p.rendered) return;
          p.rendered = true;
          const page = await pdf.getPage(p.i);
          const maxW = Math.min(980, container.clientWidth - 24);
          const base = page.getViewport({ scale: 1 });
          const scale = maxW / base.width;
          const vp = page.getViewport({ scale });
          p.canvas.width = vp.width; p.canvas.height = vp.height;
          await page.render({ canvasContext: p.canvas.getContext('2d'), viewport: vp }).promise;
        });
      }, { root: container, rootMargin: "200px 0px 400px 0px", threshold: 0.01 });
      pages.forEach(p => io.observe(p.canvas));
    }

    // Controls
    searchInput.addEventListener("input", render);
    gridBtn.addEventListener("click", ()=> {
      viewMode="grid"; gridBtn.classList.add("active"); gridBtn.setAttribute("aria-pressed","true");
      listBtn.classList.remove("active"); listBtn.setAttribute("aria-pressed","false"); render();
    });
    listBtn.addEventListener("click", ()=> {
      viewMode="list"; listBtn.classList.add("active"); listBtn.setAttribute("aria-pressed","true");
      gridBtn.classList.remove("active"); gridBtn.setAttribute("aria-pressed","false"); render();
    });

    // Filter dropdown (sort)
    function setSort(mode){
      sortMode = mode;
      filterMenu.querySelectorAll('button[role="menuitemradio"]').forEach(b=>{
        b.setAttribute("aria-checked", b.dataset.sort===mode ? "true" : "false");
      });
      render();
    }
    filterBtn.addEventListener("click", (e)=>{
      e.stopPropagation();
      const open = filterMenu.classList.toggle("open");
      filterBtn.setAttribute("aria-expanded", open ? "true" : "false");
    });
    filterMenu.addEventListener("click", (e)=>{
      const btn = e.target.closest('button[role="menuitemradio"]'); if(!btn) return;
      setSort(btn.dataset.sort);
      filterMenu.classList.remove("open");
      filterBtn.setAttribute("aria-expanded","false");
    });
    document.addEventListener("click", ()=> {
      if(filterMenu.classList.contains("open")){
        filterMenu.classList.remove("open");
        filterBtn.setAttribute("aria-expanded","false");
      }
    });

    // Format toggle cycles text and icon
    const fmtOrder = ["all","pdf","docx"];
    function updateFmtToggle(){
      const idx = fmtOrder.indexOf(fmtMode);
      const label = fmtMode.toUpperCase();
      fmtLabel.textContent = label;
      if(fmtMode==="all"){
        fmtIcon.innerHTML = '<path d="M4 6h16v2H4V6zm0 5h10v2H4v-2zm0 5h16v2H4v-2z"/>';
      }else if(fmtMode==="pdf"){
        fmtIcon.innerHTML = '<path d="M6 2h9l5 5v13a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2zm8 7h4l-4-4v4z"/>';
      }else{
        fmtIcon.innerHTML = '<path d="M14 2H6a2 2 0 0 0-2 2v16c0 1.1.9 2 2 2h12a2 2 0 0 0 2-2V8l-6-6zM6 4h7v5h5v11H6V4z"/>';
      }
    }
    fmtToggle.addEventListener("click", ()=>{
      const idx = fmtOrder.indexOf(fmtMode);
      fmtMode = fmtOrder[(idx + 1) % fmtOrder.length];
      updateFmtToggle();
      render();
    });

    // Init
    (async function init(){
      try{
        if(!configSet) return;
        allItems = await fetchNotes();
        updateFmtToggle();
        render();
      }catch(e){
        container.innerHTML = `
          <div style="background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:18px;">
            <div style="font-weight:700;margin-bottom:6px;">Couldn’t load Notes/</div>
            <div style="color:var(--muted)">Verify REPO_OWNER, REPO_NAME, BRANCH and that Notes/ exists and is public.</div>
          </div>
        `;
        console.error(e);
      }
    })();
  </script>
</body>
</html>

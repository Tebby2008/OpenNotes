<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>OpenNotes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg: #f8f9fa;
      --panel: #ffffff;
      --panel-2: #e9ecef;
      --text: #212529;
      --muted: #6c757d;
      --accent: #339af0;
      --accent-2: #51cf66;
      --shadow:0 10px 30px rgba(0,0,0,0.1);
      --radius:16px;
      --radius-sm:12px;
      --radius-lg:22px;
      --gap:14px;
      --gap-lg:22px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:"Noto Sans", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    /* Header / Banner */
    .banner{
      padding:32px 18px 18px;
      position:sticky; top:0; z-index:30;
      background:rgba(255,255,255,0.6);
      backdrop-filter: blur(12px);
    }
    .title{
      width:100%;
      display:flex; align-items:center; justify-content:center;
      font-weight:700; letter-spacing:0.3px; font-size:28px;
      padding-bottom:10px;
    }
    .title .dot{
      width:10px; height:10px; border-radius:50%;
      background:var(--accent); margin-left:10px;
      box-shadow:0 0 20px var(--accent);
    }

    /* Controls */
    .controls{
      display:flex; align-items:center; justify-content:space-between;
      gap:var(--gap); flex-wrap:wrap;
      background:var(--panel); border-radius:var(--radius);
      padding:10px; box-shadow:0 4px 12px rgba(0,0,0,0.08);
      border:1px solid rgba(0,0,0,0.06);
    }

    .left, .right{display:flex; align-items:center; gap:var(--gap)}
    .chip{
      background:var(--panel-2);
      padding:8px 10px; border-radius:999px; color:var(--text);
      display:flex; align-items:center; gap:8px; border:1px solid rgba(0,0,0,0.06);
    }
    .chip select{
      background:transparent; color:var(--text); border:none; outline:none;
      font:inherit; appearance:none; padding-right:18px; cursor:pointer;
    }
    .chip .dot{
      width:8px; height:8px; border-radius:50%; background:var(--accent);
      box-shadow:0 0 12px var(--accent);
    }

    /* Expanding search */
    .search{
      display:flex; align-items:center; gap:8px;
      background:var(--panel-2); border-radius:999px;
      padding:8px 12px; border:1px solid rgba(0,0,0,0.06);
      transition: box-shadow .2s ease;
    }
    .search:hover{ box-shadow:0 0 0 2px rgba(125,211,252,0.25) inset; }
    .search svg{width:18px; height:18px; opacity:0.9}
    .search input{
      width:110px; background:transparent; border:none; outline:none; color:var(--text);
      transition: width .25s ease; font:inherit;
    }
    .search input::placeholder{ color:var(--muted) }
    .search:focus-within input{ width:240px }

    /* Toggle buttons */
    .toggle{
      display:flex; gap:8px; background:var(--panel-2); padding:6px;
      border-radius:999px; border:1px solid rgba(0,0,0,0.06);
    }
    .btn{
      background:transparent; color:var(--text); border:none; border-radius:999px;
      padding:8px 12px; display:flex; align-items:center; gap:8px;
      cursor:pointer; transition: background .2s, transform .1s, box-shadow .2s;
    }
    .btn:hover{ background:rgba(0,0,0,0.06) }
    .btn:active{ transform: translateY(1px) }
    .btn svg{width:18px; height:18px}
    .btn.active{
      background:linear-gradient(90deg, rgba(125,211,252,0.18), rgba(167,243,208,0.15));
      box-shadow:0 0 0 2px rgba(125,211,252,0.18) inset;
    }

    /* Main content */
    .wrap{ padding:18px }
    .grid{
      display:grid; grid-template-columns:repeat(auto-fill, minmax(240px, 1fr));
      gap:18px; align-items:stretch;
    }
    .list{ display:flex; flex-direction:column; gap:12px }

    /* Card / Item */
    .card {
      position: relative;
      transition: transform .2s ease, box-shadow .2s ease;
      z-index: 0;
      background:var(--panel);
      border-radius:var(--radius);
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      overflow: hidden;
    }
    .card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.15);
      z-index: 10;
    }

    .thumb{
      background:var(--panel-2);
      height:180px; display:flex; align-items:center; justify-content:center;
      overflow:hidden; position:relative;
    }
    .thumb canvas, .thumb img, .thumb iframe, .thumb embed{
      width:100%; height:100%; object-fit:cover; border-radius:12px;
    }
    .fmt-badge{
      position:absolute; bottom:10px; left:10px; padding:6px 10px;
      font-size:12px; font-weight:600; border-radius:999px;
      background:rgba(255,255,255,0.55); color:var(--text); border:1px solid rgba(0,0,0,0.1);
      backdrop-filter: blur(4px);
    }
    .fmt-pdf{ box-shadow:0 0 0 2px rgba(125,211,252,0.35) inset }
    .fmt-docx{ box-shadow:0 0 0 2px rgba(167,243,208,0.35) inset }

    .body{ padding:12px 14px 14px }
    .title-line{
      font-weight:600; font-size:16px; margin:6px 0 6px; line-height:1.2;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .meta{
      display:flex; align-items:center; gap:8px; color:var(--muted); font-size:12px;
    }
    .meta .dot{ width:4px; height:4px; border-radius:50%; background:var(--muted) }

    .stats{
      margin-top:10px; display:flex; align-items:center; gap:12px; color:var(--muted); font-size:12px;
    }
    .stat{ display:inline-flex; align-items:center; gap:6px }
    .stat svg{ width:16px; height:16px; opacity:0.85 }

    .download-btn {
      background: var(--accent);
      color: #fff;
      border: none;
      padding: 6px;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .download-btn svg {
      width: 18px;
      height: 18px;
      fill: #fff;
    }

    /* List view item */
    .row{
      display:grid; grid-template-columns:86px 1fr auto; gap:14px;
      align-items:center; background:var(--panel); border:1px solid rgba(0,0,0,0.06);
      border-radius:var(--radius); padding:10px; box-shadow:0 4px 12px rgba(0,0,0,0.05);
      transition: transform .2s, box-shadow .2s;
    }
    .row:hover{ transform: translateY(-1px) }
    .row .thumb{ height:66px; border-radius:12px }
    .row .main{
      display:grid; grid-template-columns: minmax(200px, 2fr) repeat(4, minmax(90px, 1fr));
      gap:10px; align-items:center;
    }
    .row .main .cell{ display:flex; align-items:center; gap:6px; min-width:0 }
    .row .title-line{ margin:0; font-size:15px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis }
    .row .right-end{ display:flex; align-items:center; gap:8px }

    /* Overlay viewer */
    .overlay{
      position:fixed; inset:0; background:rgba(255,255,255,0.72); backdrop-filter: blur(8px);
      display:none; z-index:1000; padding:20px;
      opacity:0; transition: opacity .2s ease;
    }
    .overlay.open{ display:block; opacity:1; }
    .overlay.closing{ opacity:0; }

    .viewer{
      background:rgba(255,255,255,0.85);
      border:1px solid rgba(0,0,0,0.08);
      box-shadow:var(--shadow);
      border-radius:var(--radius-lg);
      height:100%; display:grid;
      grid-template-columns: 1fr minmax(280px, 360px);
      overflow:hidden;
      backdrop-filter: blur(16px);
    }
    .viewer .left{
      padding:12px; background:var(--panel-2); border-right:1px solid rgba(0,0,0,0.06);
    }
    .docframe{
      width:100%; height:100%; border:none; border-radius:12px; background:var(--panel-2);
    }
    .viewer .right{
      padding:16px; display:flex; flex-direction:column; gap:10px;
    }
    .viewer .right .title{ justify-content:flex-start; padding:0; font-size:22px }
    .kv{ color:var(--muted); font-size:13px; display:flex; gap:8px; align-items:center }
    .kv strong{ color:var(--text); font-weight:600 }
    .back{
      position:absolute; top:26px; left:26px; z-index:1001;
      background:rgba(255,255,255,0.4); color:var(--text); border:1px solid rgba(0,0,0,0.18);
      padding:8px 12px; border-radius:999px; display:flex; align-items:center; gap:8px;
      cursor:pointer; backdrop-filter: blur(4px);
      transition: transform .1s, background .2s, box-shadow .2s;
    }
    .back:hover{ background:rgba(255,255,255,0.5) }
    .back:active{ transform: translateY(1px) }

    /* Helpers */
    .pill{
      color:#001; background:var(--accent); border-radius:999px; padding:4px 8px; font-weight:700; font-size:12px;
    }
    .pill.docx{ background:var(--accent-2) }

    a.clean{ color:inherit; text-decoration:none }
    .muted{ color:var(--muted) }
    .hide{ display:none }

    .icon-only {
      padding: 8px;
    }

    .sort-wrapper {
      position: relative;
    }

    .custom-dropdown {
      position: absolute;
      top: 110%;
      left: 0;
      background: var(--panel);
      border: 1px solid rgba(0,0,0,0.1);
      border-radius: 8px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.15);
      z-index: 20;
      display: flex;
      flex-direction: column;
      min-width: 180px;
      opacity: 0;
      pointer-events: none;
      transform: translateY(10px);
      transition: opacity 0.15s ease, transform 0.15s ease;
    }

    .custom-dropdown.open {
      opacity: 1;
      pointer-events: auto;
      transform: translateY(0);
    }


    /* Small screens */
    @media (max-width: 860px){
      .viewer{ grid-template-columns: 1fr; }
      .viewer .right{ border-top:1px solid rgba(0,0,0,0.06) }
    }
  </style>
</head>
<body>

  <header class="banner">
    <div class="title">OpenNotes <span class="dot"></span></div>
    <div class="controls">
      <select id="sortSelect" style="display:none">
        <option value="updated-desc" selected>Last updated ↓</option>
        <option value="updated-asc">Last updated ↑</option>
        <option value="title-asc">Title A→Z</option>
        <option value="title-desc">Title Z→A</option>
        <option value="format-asc">Format A→Z</option>
      </select>

      <select id="formatSelect" style="display:none">
        <option value="all" selected>All formats</option>
        <option value="pdf">PDF</option>
        <option value="docx">DOCX</option>
      </select>

      <div class="left">
        <div class="sort-wrapper">
          <button id="sortBtn" class="btn icon-only" title="Sort (Last Updated)">
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M3 4h18v2H3V4zm4 7h10v2H7v-2zm3 7h4v2h-4v-2z"/></svg>
          </button>
          <div id="sortDropdown" class="custom-dropdown hidden">
            <div data-sort="updated-desc" class="option active">Last updated ↓</div>
            <div data-sort="updated-asc" class="option">Last updated ↑</div>
            <div data-sort="title-asc" class="option">Title A→Z</div>
            <div data-sort="title-desc" class="option">Title Z→A</div>
            <div data-sort="format-asc" class="option">Format A→Z</div>
          </div>
        </div>
        <button id="typeBtn" class="btn">ALL</button>
        <div class="search" role="search">
          <svg viewBox="0 0 24 24" fill="currentColor"><path d="M15.5 14h-.79l-.28-.27a6.471 6.471 0 0 0 1.57-4.23C15.99 6.01 12.98 3 9.5 3S3.01 6.01 3.01 9.5 6.02 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
          <input id="searchInput" type="text" placeholder="Search notes..." aria-label="Search notes" />
        </div>
      </div>
      <div class="right">
        <div id="totalViewsChip" class="chip" style="display:none">
          <svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
          <strong id="totalViews">0</strong>
        </div>
        <div class="toggle" role="tablist" aria-label="View mode">
          <button id="gridBtn" class="btn active icon-only" aria-pressed="true" title="Box view">
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M3 3h8v8H3V3zm10 0h8v8h-8V3zM3 13h8v8H3v-8zm10 0h8v8h-8v-8z"/></svg>
          </button>
          <button id="listBtn" class="btn icon-only" aria-pressed="false" title="List view">
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M3 5h18v2H3V5zm0 6h18v2H3v-2zm0 6h18v2H3v-2z"/></svg>
          </button>
        </div>
      </div>
    </div>
  </header>

  <main class="wrap">
    <section id="itemsContainer" class="grid" aria-live="polite"></section>
  </main>

  <div id="overlay" class="overlay" aria-hidden="true">
    <button id="backBtn" class="back" aria-label="Back">
      <svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
      Back
    </button>
    <div class="viewer" role="dialog" aria-modal="true" aria-label="Document viewer">
      <div class="left">
        <iframe id="docFrame" class="docframe" title="Document preview"></iframe>
      </div>
      <div class="right">
        <div class="title" id="ovTitle">Title</div>
        <div class="kv"><span class="pill" id="ovFormat">PDF</span></div>
        <div class="kv">Date: <strong id="ovDate">—</strong></div>
        <div class="kv">Author: <strong id="ovAuthor">—</strong></div>
        <div class="kv">Views: <strong id="ovViews">0</strong></div>
        <div class="kv">Downloads: <strong id="ovDownloads">0</strong></div>
        <div style="margin-top:8px; display:flex; gap:10px;">
          <a id="ovOpenRaw" class="btn clean" target="_blank" rel="noopener">
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M14 3v2h3.59l-9.83 9.83 1.41 1.41L19 6.41V10h2V3z"/><path d="M5 5h5V3H3v7h2z"/></svg>
            Open raw
          </a>
          <button id="ovDownload" class="download-btn">
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M5 20h14v-2H5v2zM12 2v12l4-4h-3V2h-2v8H8l4 4z"/></svg>
            Download
          </button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
  <script>
    // --- Configuration (set these to your repo) ---
    const REPO_OWNER = "Tebby2008";
    const REPO_NAME  = "OpenNotes";
    const BRANCH     = "main";
    const NOTES_PATH = "Notes";
    const API_URL = "https://open-notes.tebby2008-li.workers.dev";

    (function tryAutoDetect(){
      try{
        const host = location.hostname;
        const path = location.pathname.replace(/^\/+/,'').split('/');
        const isPages = host.endsWith(".github.io");
        if(isPages){
          const owner = host.split(".github.io")[0];
          const repo = path[0] || REPO_NAME;
          if(REPO_OWNER.startsWith("<")) window['__owner']=owner;
          if(REPO_NAME.startsWith("<")) window['__repo']=repo;
        }
      }catch(e){}
    })();

    const owner = window.__owner || REPO_OWNER;
    const repo  = window.__repo  || REPO_NAME;

    // --- State ---
    let allItems = [];
    let viewMode = "grid";

    // --- Elements ---
    const container = document.getElementById("itemsContainer");
    const sortSelect = document.getElementById("sortSelect");
    const formatSelect = document.getElementById("formatSelect");
    const searchInput = document.getElementById("searchInput");
    const gridBtn = document.getElementById("gridBtn");
    const listBtn = document.getElementById("listBtn");

    const overlay = document.getElementById("overlay");
    const backBtn = document.getElementById("backBtn");
    const docFrame = document.getElementById("docFrame");
    const ovTitle = document.getElementById("ovTitle");
    const ovFormat = document.getElementById("ovFormat");
    const ovDate = document.getElementById("ovDate");
    const ovAuthor = document.getElementById("ovAuthor");
    const ovViews = document.getElementById("ovViews");
    const ovDownloads = document.getElementById("ovDownloads");
    const ovOpenRaw = document.getElementById("ovOpenRaw");
    const ovDownload = document.getElementById("ovDownload");

    const totalViewsChip = document.getElementById("totalViewsChip");
    const totalViewsEl = document.getElementById("totalViews");

    // --- Utils ---
    const sleep = (ms)=> new Promise(r=>setTimeout(r,ms));
    const fmtDate = (iso)=> {
      if(!iso) return "—";
      const d = new Date(iso);
      const dd = String(d.getDate()).padStart(2,'0');
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const yyyy = d.getFullYear();
      return `${dd}-${mm}-${yyyy}`;
    };
    const stripExt = (name)=> name.replace(/\.[^/.]+$/, "");
    const extOf = (name)=> (name.split('.').pop() || "").toLowerCase();

    // --- API Calls & Local State Updates ---
    async function incView(item) {
      try {
        const res = await fetch(`${API_URL}?type=note&noteId=${item.path}&counter=views`, { method: 'POST' });
        const data = await res.json();
        if (data && data.views !== undefined) {
          item.views = data.views;
          item.downloads = data.downloads;
          return { views: item.views, downloads: item.downloads };
        }
      } catch (e) {
        console.error('Failed to increment view count:', e);
      }
      return null;
    }

    async function incDownload(item) {
      try {
        const res = await fetch(`${API_URL}?type=note&noteId=${item.path}&counter=downloads`, { method: 'POST' });
        const data = await res.json();
        if (data && data.downloads !== undefined) {
          item.views = data.views;
          item.downloads = data.downloads;
          return { views: item.views, downloads: item.downloads };
        }
      } catch (e) {
        console.error('Failed to increment download count:', e);
      }
      return null;
    }

    async function fetchWebsiteViews(){
      try {
        const res = await fetch(`${API_URL}?noteId=total-website-visits`);
        if (res.ok) {
          const data = await res.json();
          return data.views;
        }
        return 0;
      } catch (e) {
        console.error('Failed to fetch website views:', e);
        return 0;
      }
    }

    async function incWebsiteView(){
      await fetch(`${API_URL}?type=website`, { method: 'POST' });
    }

    async function getApiKeys(){
      const res = await fetch(`${API_URL}?list=true`, { method: 'GET' });
      if(!res.ok) return [];
      return await res.json();
    }

    // --- Data fetch ---
    async function fetchNotes(){
      const url = `https://api.github.com/repos/${owner}/${repo}/contents/${encodeURIComponent(NOTES_PATH)}?ref=${encodeURIComponent(BRANCH)}`;
      const res = await fetch(url, {headers:{'Accept':'application/vnd.github+json'}});
      if(!res.ok){
        throw new Error("Failed to fetch repo contents. Check repo, owner, branch, and that Notes/ exists.");
      }
      const data = await res.json();
      const files = data.filter(x=>{
        if(x.type !== "file") return false;
        const ext = extOf(x.name);
        return ext === "pdf" || ext === "docx";
      });

      const items = [];
      for(const f of files){
        const item = {
          name: f.name,
          title: stripExt(f.name),
          path: f.path,
          download_url: f.download_url,
          html_url: f.html_url,
          format: extOf(f.name),
          updatedAt: null,
          author: null,
          views: 0,
          downloads: 0,
        };
        items.push(item);
      }

      await Promise.all(items.map(async (it)=>{
        try{
          const commitsUrl = `https://api.github.com/repos/${owner}/${repo}/commits?path=${encodeURIComponent(it.path)}&per_page=1&sha=${encodeURIComponent(BRANCH)}`;
          const r = await fetch(commitsUrl, {headers:{'Accept':'application/vnd.github+json'}});
          if(r.ok){
            const arr = await r.json();
            if(Array.isArray(arr) && arr.length){
              const c = arr[0];
              it.updatedAt = c.commit && c.commit.author ? c.commit.author.date : null;
              it.author = c.author && c.author.login ? c.author.login : (c.commit && c.commit.author ? c.commit.author.name : "Unknown");
            }
          }
        }catch(e){}
      }));

      return items;
    }

    // --- Rendering ---
    function render(){
      const query = searchInput.value.trim().toLowerCase();
      const fmt = formatSelect.value;

      let list = [...allItems];

      // Filter by format
      if(fmt !== "all"){
        list = list.filter(x=> x.format === fmt);
      }
      // Text search (title)
      if(query){
        list = list.filter(x=> x.title.toLowerCase().includes(query));
      }

      // Sort
      const sort = sortSelect.value;
      list.sort((a,b)=>{
        switch(sort){
          case "title-asc": return a.title.localeCompare(b.title);
          case "title-desc": return b.title.localeCompare(a.title);
          case "format-asc": return a.format.localeCompare(b.format) || a.title.localeCompare(b.title);
          case "updated-asc": return (new Date(a.updatedAt||0)) - (new Date(b.updatedAt||0));
          case "updated-desc":
          default: return (new Date(b.updatedAt||0)) - (new Date(a.updatedAt||0));
        }
      });

      // Clear container
      container.innerHTML = "";
      container.className = viewMode === "grid" ? "grid" : "list";

      // Render each item
      for(const it of list){
        if(viewMode === "grid"){
          container.appendChild(renderCard(it));
        }else{
          container.appendChild(renderRow(it));
        }
      }
    }

    function renderFormatBadge(fmt){
      const span = document.createElement("span");
      span.className = `fmt-badge fmt-${fmt}`;
      span.textContent = fmt.toUpperCase();
      return span;
    }

    function makeThumb(fmt, url){
      const holder = document.createElement("div");
      holder.className = "thumb";
      holder.style.borderRadius = "12px";

      if(fmt === "pdf" && window['pdfjsLib']){
        const canvas = document.createElement("canvas");
        holder.appendChild(canvas);
        renderPdfFirstPage(url, canvas).catch(()=>{
          holder.innerHTML = fileIcon("pdf");
        });
      }else{
        holder.innerHTML = fileIcon(fmt);
      }
      return holder;
    }

    function fileIcon(fmt){
      const label = fmt.toUpperCase();
      const color = fmt === "pdf" ? "rgba(125,211,252,0.18)" : "rgba(167,243,208,0.18)";
      return `
        <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;width:100%;height:100%;background:${color}">
          <svg viewBox="0 0 24 24" fill="currentColor" width="42" height="42" aria-hidden="true">
            <path d="M14 2H6a2 2 0 0 0-2 2v16c0 1.1.9 2 2 2h12a2 2 0 0 0 2-2V8l-6-6zM6 4h7v5h5v11H6V4z"/>
          </svg>
          <div class="pill ${fmt==='docx'?'docx':''}" style="margin-top:8px;">${label}</div>
        </div>
      `;
    }

    async function renderPdfFirstPage(url, canvas){
      const pdf = await pdfjsLib.getDocument({url}).promise;
      const page = await pdf.getPage(1);
      const viewport = page.getViewport({scale: 0.5});
      const scale = Math.min(1.2, Math.max(0.6, canvas.parentElement.clientWidth / (viewport.width*1.2)));
      const vp = page.getViewport({scale});
      const ctx = canvas.getContext('2d');
      canvas.width = vp.width; canvas.height = vp.height;
      await page.render({canvasContext: ctx, viewport: vp}).promise;
    }

    function renderCard(it){
      const card = document.createElement("article");
      card.className = "card";
      card.tabIndex = 0;
      card.setAttribute("role", "button");
      card.setAttribute("aria-label", `${it.title}`);

      const thumb = makeThumb(it.format, it.download_url);
      thumb.appendChild(renderFormatBadge(it.format));

      const body = document.createElement("div");
      body.className = "body";
      const title = document.createElement("div");
      title.className = "title-line";
      title.textContent = it.title;

      const meta = document.createElement("div");
      meta.className = "meta";
      meta.innerHTML = `
        <span>${it.author || 'Unknown'}</span>
        <span class="dot"></span>
        <span>${fmtDate(it.updatedAt)}</span>
      `;

      const stats = document.createElement("div");
      stats.className = "stats";
      stats.innerHTML = `
        <span class="stat"><svg viewBox="0 0 24 24"><path d="M12 5c-7 0-10 7-10 7s3 7 10 7 10-7 10-7-3-7-10-7zm0 12c-2.8 0-5-2.24-5-5s2.2-5 5-5 5 2.24 5 5-2.2 5-5 5z"/><circle cx="12" cy="12" r="2.5"/></svg> <span data-view>${it.views || 0}</span></span>
        <span class="stat"><svg viewBox="0 0 24 24"><path d="M5 20h14v-2H5v2zM12 2v12l4-4h-3V2h-2v8H8l4 4z"/></svg> <span data-dl>${it.downloads || 0}</span></span>
      `;

      const dlBtn = document.createElement("button");
      dlBtn.className = "download-btn";
      dlBtn.innerHTML = `<svg viewBox="0 0 24 24"><path d="M5 20h14v-2H5v2zM12 2v12l4-4h-3V2h-2v8H8l4 4z"/></svg>`;
      dlBtn.addEventListener("click", async (e)=> {
          e.stopPropagation();
          const data = await incDownload(it);
          if (data) {
              stats.querySelector('[data-view]').textContent = data.views;
              stats.querySelector('[data-dl]').textContent = data.downloads;
          }
          const a = document.createElement("a");
          a.href = it.download_url;
          a.download = it.name;
          document.body.appendChild(a);
          a.click();
          a.remove();
      });
      stats.appendChild(dlBtn);

      const thumbWrap = document.createElement("div");
      thumbWrap.className = "thumb";
      thumbWrap.replaceWith(thumb);

      card.appendChild(thumb);
      body.appendChild(title);
      body.appendChild(meta);
      body.appendChild(stats);
      card.appendChild(body);

      card.addEventListener("click", ()=> openOverlay(it));
      card.addEventListener("keydown", (e)=> { if(e.key === "Enter" || e.key === " "){ e.preventDefault(); openOverlay(it);} });

      return card;
    }

    // SORT dropdown logic
    const sortBtn = document.getElementById("sortBtn");
    const sortDropdown = document.getElementById("sortDropdown");
    sortBtn.addEventListener("click", () => {
      sortDropdown.classList.toggle("open");
    });
    sortDropdown.querySelectorAll(".option").forEach(opt => {
      opt.addEventListener("click", () => {
        sortDropdown.querySelectorAll(".option").forEach(o => o.classList.remove("active"));
        opt.classList.add("active");
        sortSelect.value = opt.dataset.sort;
        render();
        sortDropdown.classList.remove("open");
        if (opt.dataset.sort !== "updated-desc") {
          sortBtn.classList.add("active");
        } else {
          sortBtn.classList.remove("active");
        }
      });
    });
    document.addEventListener("click", e => {
      if (!sortBtn.contains(e.target) && !sortDropdown.contains(e.target)) {
        sortDropdown.classList.remove("open");
      }
    });

    // FILE TYPE toggle logic
    const typeBtn = document.getElementById("typeBtn");
    const types = ["ALL", "PDF", "DOCX"];
    let idx = 0;
    typeBtn.addEventListener("click", () => {
      idx = (idx + 1) % types.length;
      typeBtn.textContent = types[idx];
      formatSelect.value = types[idx] === "ALL" ? "all" : types[idx].toLowerCase();
      render();
      if (types[idx] !== "ALL") {
        typeBtn.classList.add("active");
      } else {
        typeBtn.classList.remove("active");
      }
    });

    function renderRow(it){
      const row = document.createElement("article");
      row.className = "row";
      row.tabIndex = 0;
      row.setAttribute("role", "button");
      row.setAttribute("aria-label", `${it.title}`);

      const thumb = makeThumb(it.format, it.download_url);
      thumb.style.height = "66px";
      row.appendChild(thumb);

      const main = document.createElement("div");
      main.className = "main";

      const cellTitle = document.createElement("div");
      cellTitle.className = "cell";
      cellTitle.innerHTML = `<div class="title-line">${it.title}</div>`;

      const cellAuthor = document.createElement("div");
      cellAuthor.className = "cell muted";
      cellAuthor.textContent = it.author || "Unknown";

      const cellDate = document.createElement("div");
      cellDate.className = "cell muted";
      cellDate.textContent = fmtDate(it.updatedAt);

      const cellFmt = document.createElement("div");
      cellFmt.className = "cell";
      const pill = document.createElement("span");
      pill.className = `pill ${it.format==='docx'?'docx':''}`;
      pill.textContent = it.format.toUpperCase();
      cellFmt.appendChild(pill);

      const cellStats = document.createElement("div");
      cellStats.className = "cell muted";
      cellStats.innerHTML = `
        <span class="stat"><svg viewBox="0 0 24 24"><path d="M12 5c-7 0-10 7-10 7s3 7 10 7 10-7 10-7-3-7-10-7zm0 12c-2.8 0-5-2.24-5-5s2.2-5 5-5 5 2.24 5 5-2.2 5-5 5z"/><circle cx="12" cy="12" r="2.5"/></svg> <span data-view>${it.views || 0}</span></span>
        <span class="stat" style="margin-left:10px;"><svg viewBox="0 0 24 24"><path d="M5 20h14v-2H5v2zM12 2v12l4-4h-3V2h-2v8H8l4 4z"/></svg> <span data-dl>${it.downloads || 0}</span></span>
      `;

      main.appendChild(cellTitle);
      main.appendChild(cellAuthor);
      main.appendChild(cellDate);
      main.appendChild(cellFmt);
      main.appendChild(cellStats);
      row.appendChild(main);

      const rightEnd = document.createElement("div");
      rightEnd.className = "right-end";
      const dlCircle = document.createElement("button");
      dlCircle.className = "btn";
      dlCircle.title = "Download";
      dlCircle.innerHTML = `<svg viewBox="0 0 24 24"><path d="M5 20h14v-2H5v2zM12 2v12l4-4h-3V2h-2v8H8l4 4z"/></svg>`;
      dlCircle.addEventListener("click", async (e)=> {
        e.stopPropagation();
        const data = await incDownload(it);
        if (data) {
          cellStats.querySelector('[data-view]').textContent = data.views;
          cellStats.querySelector('[data-dl]').textContent = data.downloads;
        }
        const a = document.createElement("a");
        a.href = it.download_url; a.download = it.name; document.body.appendChild(a); a.click(); a.remove();
      });
      rightEnd.appendChild(dlCircle);
      row.appendChild(rightEnd);

      row.addEventListener("click", ()=> openOverlay(it));
      row.addEventListener("keydown", (e)=> { if(e.key === "Enter" || e.key === " "){ e.preventDefault(); openOverlay(it);} });

      return row;
    }

    function openOverlay(item){
      overlay.classList.add("open");
      overlay.setAttribute("aria-hidden", "false");

      ovTitle.textContent = item.title;
      ovFormat.textContent = item.format.toUpperCase();
      ovFormat.className = `pill ${item.format==='docx' ? 'docx' : ''}`;
      ovDate.textContent = fmtDate(item.updatedAt);
      ovAuthor.textContent = item.author || "Unknown";
      ovOpenRaw.href = `view.html?file=${encodeURIComponent(item.download_url)}`;
      ovOpenRaw.target = "_blank";

      docFrame.src = `view.html?file=${encodeURIComponent(item.download_url)}`;

      ovViews.textContent = item.views || 0;
      ovDownloads.textContent = item.downloads || 0;

      incView(item).then(data => {
        if(data) {
          ovViews.textContent = data.views;
          ovDownloads.textContent = data.downloads;
          render(); // Re-render to update the stats on the main page
        }
      }).catch(e => {
        console.error('Failed to increment view count:', e);
      });

      ovDownload.onclick = async ()=>{
        const data = await incDownload(item);
        if (data) {
          ovViews.textContent = data.views;
          ovDownloads.textContent = data.downloads;
          render(); // Re-render to update the stats on the main page
        }
        const a = document.createElement("a");
        a.href = item.download_url; a.download = item.name;
        document.body.appendChild(a); a.click(); a.remove();
      };
    }

    function closeOverlay(){
      overlay.classList.add("closing");
      overlay.addEventListener("transitionend", function handler() {
        overlay.classList.remove("open", "closing");
        overlay.setAttribute("aria-hidden", "true");
        docFrame.src = "about:blank";
        overlay.removeEventListener("transitionend", handler);
      });
    }

    backBtn.addEventListener("click", closeOverlay);
    overlay.addEventListener("click", (e)=> { if(e.target === overlay) closeOverlay(); });
    document.addEventListener("keydown", (e)=> { if(e.key === "Escape" && overlay.classList.contains("open")) closeOverlay(); });

    // --- Events ---
    sortSelect.addEventListener("change", render);
    formatSelect.addEventListener("change", render);
    searchInput.addEventListener("input", render);
    gridBtn.addEventListener("click", ()=>{
      viewMode = "grid";
      gridBtn.classList.add("active"); gridBtn.setAttribute("aria-pressed","true");
      listBtn.classList.remove("active"); listBtn.setAttribute("aria-pressed","false");
      render();
    });
    listBtn.addEventListener("click", ()=>{
      viewMode = "list";
      listBtn.classList.add("active"); listBtn.setAttribute("aria-pressed","true");
      gridBtn.classList.remove("active"); gridBtn.setAttribute("aria-pressed","false");
      render();
    });

    // --- Init ---
    (async function init(){
      try{
        allItems = await fetchNotes();
        const githubPaths = new Set(allItems.map(item => item.path));

        const dbKeys = await getApiKeys();

        const noteKeysToDelete = dbKeys.filter(key => key !== 'total-website-visits' && !githubPaths.has(key));

        for (const key of noteKeysToDelete) {
          console.log(`Deleting counter for removed note: ${key}`);
          await fetch(`${API_URL}?noteId=${key}`, { method: 'DELETE' });
        }

        const notePromises = allItems.map(async (note) => {
          try {
            const res = await fetch(`${API_URL}?noteId=${note.path}`, { method: 'GET' });
            if (res.ok) {
              const data = await res.json();
              note.views = data.views || 0;
              note.downloads = data.downloads || 0;
            } else {
              note.views = 0;
              note.downloads = 0;
            }
          } catch (e) {
            console.error('Failed to fetch count for note:', note.path, e);
            note.views = 0;
            note.downloads = 0;
          }
        });
        await Promise.all(notePromises);

        const totalViews = await fetchWebsiteViews();
        if (totalViews > 0) {
          totalViewsChip.style.display = 'flex';
          totalViewsEl.textContent = totalViews;
        }

        render();

        incWebsiteView();

      }catch(e){
        console.error(e);
        container.innerHTML = `
          <div style="background:var(--panel);border:1px solid rgba(255,255,255,0.08);border-radius:16px;padding:18px;">
            <div style="font-weight:700;margin-bottom:6px;">Couldn’t load Notes/</div>
            <div class="muted">Check that the repository, branch, and Notes folder exist and are public.</div>
          </div>
        `;
      }
    })();
  </script>
</body>
</html>

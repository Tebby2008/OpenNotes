<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>OpenNotes - Notes made open</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/Tebby2008/OpenNotes/main/resources/favicon.png">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Condensed:wght@700&family=Noto+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    :root {
      --bg: #f8f9fa;
      --panel: #ffffff;
      --panel-2: #e9ecef;
      --text: #212529;
      --muted: #6c757d;
      --accent: #96bfea;
      --accent-2: #b9d9f9;
      --pdf-color: #f9dde8;
      --pdf-color-2: #e91e63;
      --docx-color: #e2effc;
      --docx-color-2: var(--accent);
      --gold: #ffc107;
      --shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      --shadow-sm: 0 4px 12px rgba(0, 0, 0, 0.08);
      --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.15);
      --radius: 16px;
      --radius-sm: 12px;
      --radius-lg: 22px;
      --gap: 14px;
      --gap-lg: 22px;
      --dark-header: #12171d;
      --footer-bg: #1e252e;
      --icon-size-lg: 28px;
      --icon-size-sm: 20px;
      --trans-hover: transform .2s ease, box-shadow .2s ease;
      --trans-press: transform .1s;
      --trans-bg: background .2s;
      --box-inset-accent: 0 0 0 2px rgba(125, 211, 252, 0.25) inset;
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: "Noto Sans", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      display: flex;
      flex-direction: column;
    }

    .material-symbols-outlined {
      font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
      font-size: var(--icon-size-lg);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .icon-sm .material-symbols-outlined { font-size: var(--icon-size-sm); }
    .search .material-symbols-outlined,
    .footer .material-symbols-outlined,
    .download-btn .material-symbols-outlined,
    .back .material-symbols-outlined { font-size: var(--icon-size-sm); }

    .title-section {
      height: 50vh;
      background: var(--dark-header);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      z-index: 1;
    }
    .title-logo { width: 75vw; height: auto; max-width: 600px; }
    .logo-container { display: flex; flex-direction: column; align-items: center; margin-bottom: 20px; }
    .logo-container p { color: rgba(255, 255, 255, 0.8); font-size: 14px; margin-top: 10px; display: flex; align-items: center; gap: 6px; }
    .logo-container p img { height: 23.4px; width: auto; }
    .line { width: 33vw; height: 2px; background: rgba(255, 255, 255, 0.8); margin: 20px auto; }
    @media (max-width: 860px) {
      .title-logo { width: 90vw; }
    }

    .controls {
      display: flex; align-items: center; justify-content: space-between;
      gap: var(--gap); flex-wrap: wrap;
      background: var(--panel);
      border-bottom-left-radius: 40px;
      border-bottom-right-radius: 40px;
      padding: 10px 18px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      position: relative;
      z-index: 2;
    }

    .left, .right { display: flex; align-items: center; gap: 8px; }
    .chip {
      background: var(--panel-2);
      padding: 8px 10px; border-radius: 999px; color: var(--text);
      display: flex; align-items: center; gap: 8px; border: 1px solid rgba(0, 0, 0, 0.06);
      cursor: pointer;
    }
    .chip:hover { background: rgba(125, 211, 252, 0.1); }
    .chip select { background: transparent; color: var(--text); border: none; outline: none; font: inherit; appearance: none; padding-right: 18px; cursor: pointer; }
    .chip .dot { width: 8px; height: 8px; border-radius: 50%; background: var(--accent); box-shadow: 0 0 12px var(--accent); }

    .search {
      display: flex; align-items: center; gap: 8px;
      background: var(--panel-2); border-radius: 999px;
      padding: 8px 12px; border: 1px solid rgba(0, 0, 0, 0.06);
      transition: box-shadow .2s ease;
    }
    .search:hover { box-shadow: var(--box-inset-accent); }
    .search .material-symbols-outlined { opacity: 0.9; }
    .search input {
      width: 140px; background: transparent; border: none; outline: none; color: var(--text);
      transition: width .25s ease; font: inherit;
    }
    .search input::placeholder { color: var(--muted); }
    .search:focus-within input { width: 280px; }

    .toggle { display: flex; gap: 8px; background: var(--panel-2); padding: 6px; border-radius: 999px; border: 1px solid rgba(0, 0, 0, 0.06); }
    .btn, .styled-btn {
      background: transparent;
      color: var(--text);
      border: none;
      border-radius: 999px;
      padding: 8px 12px;
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      transition: var(--trans-bg), var(--trans-press), var(--trans-hover);
      text-decoration: none;
      font-weight: 500;
      font-size: 1rem;
    }
    .btn:hover, .styled-btn:hover { background: rgba(0, 0, 0, 0.06); }
    .btn:active, .styled-btn:active { transform: translateY(1px); }
    .btn .material-symbols-outlined, .styled-btn .material-symbols-outlined { font-size: var(--icon-size-sm); }
    .btn b { font-weight: 700; font-family: "Noto Sans", sans-serif; }
    .btn.active { background: linear-gradient(90deg, rgba(125, 211, 252, 0.18), rgba(167, 243, 208, 0.15)); box-shadow: 0 0 0 2px rgba(125, 211, 252, 0.18) inset; }
    .btn.active-ai { background: #fffbeb; box-shadow: 0 0 0 2px var(--gold) inset; }
    #aiToggleBtn.btn.active-ai .material-symbols-outlined { color: var(--gold); }
    .btn.active-ai b { color: #b38600; }
    #aiToggleBtn .material-symbols-outlined { font-variation-settings: 'FILL' 1, 'wght' 700; }
    #gridBtn svg, #listBtn .material-symbols-outlined { width: 20px; height: 20px; font-size: var(--icon-size-sm); }
    .btn.active-pdf { background: #fdf2f7; box-shadow: 0 0 0 2px var(--pdf-color-2) inset; }
    .btn.active-docx { background: #f2f8fd; box-shadow: 0 0 0 2px var(--docx-color-2) inset; }

    .wrap { padding: 18px; z-index: 0; position: relative; margin: 36px 0; flex: 1; }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 18px; align-items: stretch; }
    .list { display: flex; flex-direction: column; gap: 12px; }

    .card { position: relative; transition: var(--trans-hover); z-index: 0; background: var(--panel); border-radius: var(--radius); box-shadow: var(--shadow-sm); overflow: hidden; cursor: pointer; }
    .card:hover { transform: translateY(-4px); box-shadow: var(--shadow-lg); z-index: 10; }

    .thumb { background: var(--panel-2); height: 180px; display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative; flex-direction: column; gap: 8px; }
    .thumb canvas { width: 100%; height: 100%; object-fit: cover; border-radius: 12px; }
    .thumb span.material-symbols-outlined { font-size: 80px; }
    .thumb .fmt-text { font-family: 'Noto Sans Condensed', sans-serif; font-size: 16px; font-weight: 700; text-transform: uppercase; }
    .fmt-badge { position: absolute; bottom: 10px; left: 10px; padding: 6px 10px; font-size: 12px; font-weight: 600; border-radius: 999px; background: rgba(255, 255, 255, 0.55); color: var(--text); border: 1px solid rgba(0, 0, 0, 0.1); backdrop-filter: blur(4px); }
    .fmt-pdf { box-shadow: 0 0 0 2px var(--pdf-color-2) inset; background: rgba(252, 228, 236, 0.7); }
    .fmt-docx { box-shadow: 0 0 0 2px var(--docx-color-2) inset; background: rgba(185, 217, 249, 0.7); }
    .thumb.fmt-pdf { background: var(--pdf-color); }
    .thumb.fmt-docx { background: var(--docx-color); }

    .body { padding: 12px 14px 14px; }
    .title-line { font-weight: 600; font-size: 16px; margin: 6px 0 6px; line-height: 1.2; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .meta { display: flex; align-items: center; gap: 8px; color: var(--muted); font-size: 12px; }
    .meta .dot { width: 4px; height: 4px; border-radius: 50%; background: var(--muted); }

    .ai-tag { background: #fffbeb; color: #b38600; font-size: 10px; font-weight: 600; padding: 3px 6px; border-radius: 6px; margin-left: 6px; vertical-align: middle; display: inline-flex; align-items: center; gap: 4px; border: 1px solid var(--gold); }
    .ai-tag .material-symbols-outlined { font-size: 14px; color: var(--gold); font-variation-settings: 'FILL' 1, 'wght' 700; }

    .verified-tag { color: var(--text); background: transparent; border: none; height: auto; width: auto; display: inline-flex; align-items: center; justify-content: center; margin-left: 4px; vertical-align: middle; }
    .verified-tag .material-symbols-outlined { font-size: 16px; color: var(--accent); font-variation-settings: 'FILL' 1, 'wght' 400; }

    .stats { margin-top: 10px; display: flex; align-items: center; gap: 12px; color: var(--muted); font-size: 12px; }
    .stat { display: inline-flex; align-items: center; gap: 6px; }
    .stat .material-symbols-outlined { font-size: 20px; opacity: 0.85; }

    .download-btn {
      background: var(--accent);
      color: #fff;
      border: none;
      padding: 6px;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      cursor: pointer;
    }
    .download-btn .material-symbols-outlined { font-size: var(--icon-size-sm); color: #fff; }

    .row {
      display: grid; grid-template-columns: 86px 1fr auto; gap: 14px;
      align-items: center; background: var(--panel); border: 1px solid rgba(0, 0, 0, 0.06);
      border-radius: var(--radius); padding: 10px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      transition: var(--trans-hover); cursor: pointer; overflow: hidden;
    }
    .row:hover { transform: translateY(-1px); }
    .row .thumb { height: 66px; border-radius: 12px; display: flex; align-items: center; justify-content: center; }
    .list .thumb .fmt-text, .list .fmt-badge { display: none; }
    .row .main { display: grid; grid-template-columns: minmax(200px, 2fr) repeat(4, minmax(90px, 1fr)); gap: 10px; align-items: center; }
    .row .main .cell { display: flex; align-items: center; gap: 6px; min-width: 0; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
    .row .title-line { margin: 0; font-size: 15px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .row .right-end { display: flex; align-items: center; gap: 8px; }

    .overlay {
      position: fixed; inset: 0; background: rgba(255, 255, 255, 0.72); backdrop-filter: blur(8px);
      display: none; z-index: 1000; padding: 20px;
      opacity: 0; transition: opacity .2s ease;
    }
    .overlay.open { display: block; opacity: 1; }
    .viewer {
      background: rgba(255, 255, 255, 0.85);
      border: 1px solid rgba(0, 0, 0, 0.08);
      box-shadow: var(--shadow);
      border-radius: var(--radius-lg);
      height: 100%; display: grid;
      grid-template-columns: 1fr minmax(280px, 360px);
      overflow: hidden;
      backdrop-filter: blur(16px);
    }
    .viewer .left { padding: 12px; background: var(--panel-2); border-right: 1px solid rgba(0, 0, 0, 0.06); }
    .docframe { width: 100%; height: 100%; border: none; border-radius: 12px; background: var(--panel-2); }
    .viewer .right { padding: 16px; display: flex; flex-direction: column; gap: 10px; }
    .viewer .right .title { justify-content: flex-start; padding: 0; font-size: 22px; }
    .kv { color: var(--muted); font-size: 13px; display: flex; gap: 8px; align-items: center; }
    .kv strong { color: var(--text); font-weight: 600; }

    .back {
      position: absolute; bottom: 26px; left: 26px; z-index: 1001;
      background: rgba(255, 255, 255, 0.4); color: var(--text); border: 1px solid rgba(0, 0, 0, 0.18);
      padding: 12px 18px; font-size: 16px; border-radius: 999px; display: flex; align-items: center; gap: 8px;
      cursor: pointer; backdrop-filter: blur(4px); transition: var(--trans-press), var(--trans-bg), var(--trans-hover);
    }
    .back:hover { background: rgba(255, 255, 255, 0.5); }
    .back:active { transform: translateY(1px); }

    .overlay-content { padding: 2rem; text-align: left; color: #333; line-height: 1.6; font-family: "Noto Sans", sans-serif; background: #fff; border-radius: 12px; height: 100%; overflow-y: auto; }
    .overlay-content h1, .overlay-content h2 { color: var(--text); }
    .overlay-content a { color: var(--accent); text-decoration: none; }
    .overlay-content a:hover { text-decoration: underline; }
    
    .styled-btn.download-accent {
      background: var(--accent);
      color: white;
      border-color: rgba(255, 255, 255, 0.1);
    }
    .styled-btn.download-accent .material-symbols-outlined { color: white; }

    .pill { color: #001; background: var(--accent); border-radius: 999px; padding: 4px 8px; font-weight: 700; font-size: 12px; }
    .pill.docx { background: var(--docx-color-2); color: white; }
    .pill.pdf { background: var(--pdf-color-2); color: white; }

    a.clean { color: inherit; text-decoration: none; cursor: pointer; }
    .muted { color: var(--muted); }
    .hide { display: none; }

    .icon-only { padding: 8px; }

    .sort-wrapper { position: relative; }
    .custom-dropdown {
      position: absolute; top: 110%; left: 0; background: var(--panel); border: 1px solid rgba(0, 0, 0, 0.1);
      border-radius: 8px; box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15); z-index: 20; display: flex;
      flex-direction: column; min-width: 180px; opacity: 0; pointer-events: none;
      transform: translateY(10px); transition: opacity 0.15s ease, transform 0.15s ease;
    }
    .custom-dropdown.open { opacity: 1; pointer-events: auto; transform: translateY(0); }
    .custom-dropdown .option { padding: 8px 12px; cursor: pointer; transition: background 0.15s; }
    .custom-dropdown .option:hover { background: rgba(125, 211, 252, 0.1); }
    .custom-dropdown .option.active { background: var(--accent); color: white; }

    footer {
      background: var(--footer-bg);
      color: rgba(255, 255, 255, 0.6);
      padding: 18px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: auto;
      font-size: 14px;
    }
    footer .left, .total-views {
      display: flex;
      gap: 16px; /* Adjust as needed */
      align-items: center;
    }
    footer a, footer svg {
      color: inherit;
      fill: currentColor;
      text-decoration: none;
      transition: color .2s;
    }
    footer a:hover, footer a:hover svg {
      color: rgba(255, 255, 255, 0.9);
      fill: rgba(255, 255, 255, 0.9);
    }
    footer a, .total-views {
      font-weight: 550;
    }
    footer .left a {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    footer .left a svg {
      height: 18px;
      width: 18px;
      vertical-align: middle;
    }
    .total-views .material-symbols-outlined {
      font-size: 20px;
    }
    
    @media (max-width: 860px) {
      .viewer { grid-template-columns: 1fr; }
      .viewer .right { border-top: 1px solid rgba(0, 0, 0, 0.06); }
    }
  </style>
</head>
<body>

  <header>
    <div class="title-section">
      <div class="logo-container">
        <img src="resources/logo.svg" alt="OpenNotes Logo" class="title-logo" />
        <div class="line"></div>
        <p>
          the open platform for notes by 
          <a href="https://ingenium.rf.gd" target="_blank" rel="noopener">
            <img src="resources/ingenium.png" alt="Ingenium Logo" />
          </a>
        </p>
      </div>
    </div>
    <div class="controls">
      <select id="sortSelect" style="display:none">
        <option value="updated-desc" selected>Last updated ↓</option>
        <option value="updated-asc">Last updated ↑</option>
        <option value="title-asc">Title A→Z</option>
        <option value="title-desc">Title Z→A</option>
        <option value="format-asc">Format A→Z</option>
      </select>

      <select id="formatSelect" style="display:none">
        <option value="all" selected>All formats</option>
        <option value="pdf">PDF</option>
        <option value="docx">DOCX</option>
      </select>

      <div class="left">
        <div class="sort-wrapper">
          <button id="sortBtn" class="btn icon-only" title="Sort (Last Updated)">
            <span class="material-symbols-outlined">filter_list</span>
          </button>
          <div id="sortDropdown" class="custom-dropdown hidden">
            <div data-sort="updated-desc" class="option active">Last updated ↓</div>
            <div data-sort="updated-asc" class="option">Last updated ↑</div>
            <div data-sort="title-asc" class="option">Title A→Z</div>
            <div data-sort="title-desc" class="option">Title Z→A</div>
            <div data-sort="format-asc" class="option">Format A→Z</div>
          </div>
        </div>
        <button id="typeBtn" class="btn"><b>ALL</b></button>
        <button id="aiToggleBtn" class="btn active-ai" title="Toggle AI Content">
          <span class="material-symbols-outlined">auto_awesome</span>
          <b>Show AI</b>
        </button>
        <div class="search" role="search">
          <span class="material-symbols-outlined">search</span>
          <input id="searchInput" type="text" placeholder="Search notes..." aria-label="Search notes" />
        </div>
      </div>
      <div class="right">
        <button id="uploadBtn" class="btn icon-only" title="How to Upload" data-md="resources/upload.md">
          <span class="material-symbols-outlined">upload</span>
        </button>
        <div class="toggle" role="tablist" aria-label="View mode">
          <button id="gridBtn" class="btn active icon-only" aria-pressed="true" title="Box view">
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M3 3h8v8H3V3zm10 0h8v8h-8V3zM3 13h8v8H3v-8zm10 0h8v8h-8v-8z"></path></svg>
          </button>
          <button id="listBtn" class="btn icon-only" aria-pressed="false" title="List view">
            <span class="material-symbols-outlined">lists</span>
          </button>
        </div>
      </div>
    </div>
  </header>

  <main class="wrap">
    <section id="itemsContainer" class="grid" aria-live="polite"></section>
  </main>

  <div id="overlay" class="overlay" aria-hidden="true">
    <button id="backBtn" class="back" aria-label="Back">
      <span class="material-symbols-outlined">arrow_back</span>
      Back
    </button>
    <div class="viewer" role="dialog" aria-modal="true" aria-label="Document viewer">
      <div class="left">
        <iframe id="docFrame" class="docframe" title="Document preview"></iframe>
      </div>
      <div class="right">
        <div class="title" id="ovTitle">Title</div>
        <div class="kv"><span class="pill" id="ovFormat">PDF</span></div>
        <div class="kv">Date: <strong id="ovDate">—</strong></div>
        <div class="kv">Author: <strong id="ovAuthor">—</strong></div>
        <div class="kv">Views: <strong id="ovViews">0</strong></div>
        <div class="kv">Downloads: <strong id="ovDownloads">0</strong></div>
        <div style="margin-top:8px; display:flex; flex-direction:column; gap:10px;">
          <a id="ovOpenRaw" class="styled-btn" target="_blank" rel="noopener">
            <span class="material-symbols-outlined">open_in_new</span>
            View Raw
          </a>
          <button id="ovDownload" class="styled-btn download-accent">
            <span class="material-symbols-outlined">download</span>
            Download
          </button>
        </div>
      </div>
    </div>
  </div>

  <div id="infoOverlay" class="overlay" aria-hidden="true">
    <button id="infoBackBtn" class="back" aria-label="Back">
      <span class="material-symbols-outlined">arrow_back</span>
      Back
    </button>
    <div class="viewer" style="grid-template-columns: 1fr;">
      <div class="overlay-content" id="infoContent"></div>
    </div>
  </div>

  <footer>
    <div class="left">
      <a href="#" class="info-link" data-md="resources/terms-privacy.md">Terms & Privacy</a>
      <a href="#" class="info-link" data-md="resources/contact.md">Contact Us</a>
      <a href="#" class="info-link" data-md="resources/about.md">About</a>
      <a href="https://github.com/Tebby2008/OpenNotes" target="_blank" rel="noopener">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 96" fill="currentColor" class="icon">
          <path fill-rule="evenodd" clip-rule="evenodd" d="M48.854 0C21.839 0 0 22 0 49.217c0 21.756 13.993 40.172 33.405 46.69 2.427.49 3.316-1.059 3.316-2.362 0-1.141-.08-5.052-.08-9.127-13.59 2.934-16.42-5.867-16.42-5.867-2.184-5.704-5.42-7.17-5.42-7.17-4.448-3.015.324-3.015.324-3.015 4.934.326 7.523 5.052 7.523 5.052 4.367 7.496 11.404 5.378 14.235 4.074.404-3.178 1.699-5.378 3.074-6.6-10.839-1.141-22.243-5.378-22.243-24.283 0-5.378 1.94-9.778 5.014-13.2-.485-1.222-2.184-6.275.486-13.038 0 0 4.125-1.304 13.426 5.052a46.97 46.97 0 0 1 12.214-1.63c4.125 0 8.33.571 12.213 1.63 9.302-6.356 13.427-5.052 13.427-5.052 2.67 6.763.97 11.816.485 13.038 3.155 3.422 5.015 7.822 5.015 13.2 0 18.905-11.404 23.06-22.324 24.283 1.78 1.548 3.316 4.481 3.316 9.126 0 6.6-.08 11.897-.08 13.526 0 1.304.89 2.853 3.316 2.364 19.412-6.52 33.405-24.935 33.405-46.691C97.707 22 75.788 0 48.854 0z"/>
        </svg>
        Github
      </a>
    </div>
    <div class="right total-views">
      <span class="material-symbols-outlined">visibility</span>
      <span id="websiteViews">0</span>
    </div>
  </footer>


  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
  <script>
      const REPO_OWNER = "Tebby2008";
      const REPO_NAME  = "OpenNotes";
      const BRANCH     = "main";
      const API_URL = "https://open-notes.tebby2008-li.workers.dev";
  
      (function tryAutoDetect() {
        try {
          const host = location.hostname;
          const path = location.pathname.replace(/^\/+/,'').split('/');
          const isPages = host.endsWith(".github.io");
          if (isPages) {
            const owner = host.split(".github.io")[0];
            const repo = path[0] || REPO_NAME;
            if (REPO_OWNER.startsWith("<")) window['__owner'] = owner;
            if (REPO_NAME.startsWith("<")) window['__repo'] = repo;
          }
        } catch(e) {}
      })();
  
      const owner = window.__owner || REPO_OWNER;
      const repo  = window.__repo  || REPO_NAME;
  
      let allItems = [];
      let viewMode = "grid";
      let showAI = true;
  
      const container = document.getElementById("itemsContainer");
      const sortSelect = document.getElementById("sortSelect");
      const formatSelect = document.getElementById("formatSelect");
      const searchInput = document.getElementById("searchInput");
      const gridBtn = document.getElementById("gridBtn");
      const listBtn = document.getElementById("listBtn");
      const typeBtn = document.getElementById("typeBtn");
      const aiToggleBtn = document.getElementById("aiToggleBtn");
  
      const overlay = document.getElementById("overlay");
      const backBtn = document.getElementById("backBtn");
      const docFrame = document.getElementById("docFrame");
      const ovTitle = document.getElementById("ovTitle");
      const ovFormat = document.getElementById("ovFormat");
      const ovDate = document.getElementById("ovDate");
      const ovAuthor = document.getElementById("ovAuthor");
      const ovViews = document.getElementById("ovViews");
      const ovDownloads = document.getElementById("ovDownloads");
      const ovOpenRaw = document.getElementById("ovOpenRaw");
      const ovDownload = document.getElementById("ovDownload");
  
      const infoOverlay = document.getElementById("infoOverlay");
      const infoBackBtn = document.getElementById("infoBackBtn");
      const infoContent = document.getElementById("infoContent");
      const infoLinks = document.querySelectorAll('.info-link, #uploadBtn');
      const websiteViewsEl = document.getElementById('websiteViews');
  
      const fmtDate = (iso) => {
        if (!iso) return "—";
        const d = new Date(iso);
        return `${String(d.getDate()).padStart(2,'0')}-${String(d.getMonth()+1).padStart(2,'0')}-${d.getFullYear()}`;
      };
      const stripExt = (name) => name.replace(/\.[^/.]+$/, "");
      const extOf = (name) => (name.split('.').pop() || "").toLowerCase();
      const toggleOverlay = (el, state, callback) => {
        document.body.style.overflow = state ? 'hidden' : '';
        el.style.display = state ? 'block' : 'none';
        el.setAttribute("aria-hidden", !state);
        requestAnimationFrame(() => el.classList.toggle("open", state));
        if (callback) callback();
      };
      
      const updateCounter = async (itemPath, counterType) => {
        try {
          const res = await fetch(`${API_URL}?type=note&noteId=${itemPath}&counter=${counterType}`, { method: 'POST' });
          if (res.ok) return await res.json();
        } catch (e) {
          console.error(`Failed to increment ${counterType} count:`, e);
        }
        return null;
      };
      
      async function getNoteStats(noteIds) {
        try {
          const res = await fetch(`${API_URL}?type=stats&noteIds=${noteIds.join(',')}`);
          if (res.ok) return await res.json();
        } catch (e) {
          console.error('Failed to fetch note stats:', e);
        }
        return {};
      }
  
      async function fetchNotes() {
        const url = `https://raw.githubusercontent.com/${owner}/${repo}/${BRANCH}/notes_metadata.json`;
        const res = await fetch(url);
        if (!res.ok) throw new Error("Failed to fetch notes_metadata.json.");
        const metadata = await res.json();
        
        return metadata.map(meta => {
          const format = extOf(meta.name);
          if (format !== "pdf" && format !== "docx") return null;
          return {
            name: meta.name,
            title: stripExt(meta.name),
            path: meta.path,
            download_url: meta.download_url,
            html_url: `https://github.com/${owner}/${repo}/blob/${BRANCH}/${encodeURIComponent(meta.path)}`,
            format: format,
            updatedAt: meta.last_updated,
            author: meta.author,
            author_username: meta.author_username,
            is_ai_generated: meta.is_ai_generated,
            views: 0,
            downloads: 0,
          };
        }).filter(Boolean);
      }
  
      function render() {
        const query = searchInput.value.trim().toLowerCase();
        const fmt = formatSelect.value;
  
        let list = allItems.filter(x => (showAI || !x.is_ai_generated) && (fmt === "all" || x.format === fmt) && x.title.toLowerCase().includes(query));
  
        const sort = sortSelect.value;
        list.sort((a,b) => {
          switch(sort) {
            case "title-asc": return a.title.localeCompare(b.title);
            case "title-desc": return b.title.localeCompare(a.title);
            case "format-asc": return a.format.localeCompare(b.format) || a.title.localeCompare(b.title);
            case "updated-asc": return (new Date(a.updatedAt || 0)) - (new Date(b.updatedAt || 0));
            default: return (new Date(b.updatedAt || 0)) - (new Date(a.updatedAt || 0));
          }
        });
  
        container.innerHTML = "";
        container.className = viewMode === "grid" ? "grid" : "list";
  
        list.forEach(it => {
          container.appendChild(viewMode === "grid" ? renderCard(it) : renderRow(it));
        });
      }
      
      const getAuthorHtml = (item) => {
        let authorName = item.author || 'Unknown';
        if (item.author_username && item.author_username.toLowerCase() === 'tebby2008') {
          authorName = "Chenyu Li";
          return `${authorName} <span class="verified-tag"><span class="material-symbols-outlined">verified</span></span>`;
        }
        return authorName;
      };
  
      function renderCard(it) {
        const card = document.createElement("article");
        card.className = "card";
        card.tabIndex = 0;
        card.setAttribute("role", "button");
        card.setAttribute("aria-label", `${it.title}`);
  
        const thumb = makeThumb(it.format, it.download_url);
        thumb.appendChild(renderFormatBadge(it.format));
  
        const body = document.createElement("div");
        body.className = "body";
        const title = document.createElement("div");
        title.className = "title-line";
        title.textContent = it.title;
  
        const meta = document.createElement("div");
        meta.className = "meta";
        const aiTagHtml = it.is_ai_generated ? `<span class="ai-tag"><span class="material-symbols-outlined">auto_awesome</span>AI</span>` : '';
        meta.innerHTML = `
          <span>${getAuthorHtml(it)} ${aiTagHtml}</span>
          <span class="dot"></span>
          <span>${fmtDate(it.updatedAt)}</span>
        `;
  
        const stats = document.createElement("div");
        stats.className = "stats";
        stats.innerHTML = `
          <span class="stat"><span class="material-symbols-outlined">visibility</span> <span data-view>${it.views || 0}</span></span>
          <span class="stat"><span class="material-symbols-outlined">download</span> <span data-dl>${it.downloads || 0}</span></span>
        `;
  
        const dlBtn = document.createElement("button");
        dlBtn.className = "download-btn";
        dlBtn.title = "Download";
        dlBtn.innerHTML = `<span class="material-symbols-outlined">download</span>`;
        dlBtn.addEventListener("click", async (e) => {
            e.stopPropagation();
            const data = await updateCounter(it.path, 'downloads');
            if (data) {
                it.views = data.views;
                it.downloads = data.downloads;
                stats.querySelector('[data-view]').textContent = data.views;
                stats.querySelector('[data-dl]').textContent = data.downloads;
            }
            const a = document.createElement("a");
            a.href = it.download_url;
            a.download = it.name;
            document.body.appendChild(a);
            a.click();
            a.remove();
        });
        stats.appendChild(dlBtn);
  
        card.append(thumb, body);
        body.append(title, meta, stats);
        card.addEventListener("click", () => openOverlay(it));
        card.addEventListener("keydown", (e) => { if (e.key === "Enter" || e.key === " ") { e.preventDefault(); openOverlay(it); } });
  
        return card;
      }
      
      function renderRow(it) {
        const row = document.createElement("article");
        row.className = "row";
        row.tabIndex = 0;
        row.setAttribute("role", "button");
        row.setAttribute("aria-label", `${it.title}`);
  
        const thumb = makeThumb(it.format, it.download_url);
        thumb.style.height = "66px";
        thumb.classList.add('icon-sm');
        const fmtBadge = thumb.querySelector('.fmt-badge');
        if (fmtBadge) fmtBadge.style.display = 'none';
        
        const main = document.createElement("div");
        main.className = "main";
  
        const cellTitle = document.createElement("div");
        cellTitle.className = "cell";
        cellTitle.innerHTML = `<div class="title-line">${it.title}</div>`;
  
        const cellAuthor = document.createElement("div");
        cellAuthor.className = "cell muted";
        cellAuthor.innerHTML = getAuthorHtml(it);
        if (it.is_ai_generated) {
            const aiTag = document.createElement("span");
            aiTag.className = "ai-tag";
            aiTag.innerHTML = `<span class="material-symbols-outlined">auto_awesome</span>AI`;
            cellAuthor.appendChild(aiTag);
        }
  
        const cellDate = document.createElement("div");
        cellDate.className = "cell muted";
        cellDate.textContent = fmtDate(it.updatedAt);
  
        const cellFmt = document.createElement("div");
        cellFmt.className = "cell";
        const pill = document.createElement("span");
        pill.className = `pill ${it.format === 'docx' ? 'docx' : 'pdf'}`;
        pill.textContent = it.format.toUpperCase();
        cellFmt.appendChild(pill);
  
        const cellStats = document.createElement("div");
        cellStats.className = "cell muted";
        cellStats.innerHTML = `
          <span class="stat"><span class="material-symbols-outlined">visibility</span> <span data-view>${it.views || 0}</span></span>
          <span class="stat" style="margin-left:10px;"><span class="material-symbols-outlined">download</span> <span data-dl>${it.downloads || 0}</span></span>
        `;
  
        const rightEnd = document.createElement("div");
        rightEnd.className = "right-end";
        const dlCircle = document.createElement("button");
        dlCircle.className = "btn";
        dlCircle.title = "Download";
        dlCircle.innerHTML = `<span class="material-symbols-outlined">download</span>`;
        dlCircle.addEventListener("click", async (e) => {
          e.stopPropagation();
          const data = await updateCounter(it.path, 'downloads');
          if (data) {
            it.views = data.views;
            it.downloads = data.downloads;
            cellStats.querySelector('[data-view]').textContent = data.views;
            cellStats.querySelector('[data-dl]').textContent = data.downloads;
          }
          const a = document.createElement("a");
          a.href = it.download_url; a.download = it.name; document.body.appendChild(a); a.click(); a.remove();
        });
        
        row.append(thumb, main, rightEnd);
        main.append(cellTitle, cellAuthor, cellDate, cellFmt, cellStats);
        rightEnd.appendChild(dlCircle);
  
        row.addEventListener("click", () => openOverlay(it));
        row.addEventListener("keydown", (e) => { if (e.key === "Enter" || e.key === " ") { e.preventDefault(); openOverlay(it); } });
  
        return row;
      }
  
      function renderFormatBadge(fmt) {
        const span = document.createElement("span");
        span.className = `fmt-badge fmt-${fmt}`;
        span.textContent = fmt.toUpperCase();
        return span;
      }
  
      function makeThumb(fmt, url) {
        const holder = document.createElement("div");
        holder.className = `thumb fmt-${fmt}`;
        holder.style.borderRadius = "16px";
  
        if (fmt === "pdf" && window.pdfjsLib) {
          const canvas = document.createElement("canvas");
          holder.appendChild(canvas);
          renderPdfFirstPage(url, canvas).catch(() => {
            holder.innerHTML = fileIcon(fmt);
          });
        } else {
          holder.innerHTML = fileIcon(fmt);
        }
        return holder;
      }
        
      function fileIcon(fmt) {
        const iconName = "docs";
        const rootStyles = getComputedStyle(document.documentElement);
        const color = fmt === "pdf" ? rootStyles.getPropertyValue('--pdf-color-2') : rootStyles.getPropertyValue('--docx-color-2');
        const text = fmt.toUpperCase();
        return `
          <span class="material-symbols-outlined" style="font-size: 42px; color: ${color};">${iconName}</span>
          <span class="fmt-text" style="color: ${color};">${text}</span>
        `;
      }
  
      async function renderPdfFirstPage(url, canvas) {
        const pdf = await pdfjsLib.getDocument({url}).promise;
        const page = await pdf.getPage(1);
        const viewport = page.getViewport({scale: 0.5});
        const scale = Math.min(1.2, Math.max(0.6, canvas.parentElement.clientWidth / (viewport.width * 1.2)));
        const vp = page.getViewport({scale});
        const ctx = canvas.getContext('2d');
        canvas.width = vp.width; canvas.height = vp.height;
        await page.render({canvasContext: ctx, viewport: vp}).promise;
      }
  
      function openOverlay(item) {
        toggleOverlay(overlay, true, () => {
          ovTitle.textContent = item.title;
          ovFormat.textContent = item.format.toUpperCase();
          ovFormat.className = `pill ${item.format === 'docx' ? 'docx' : 'pdf'}`;
          ovDate.textContent = fmtDate(item.updatedAt);
          const aiTagHtml = item.is_ai_generated ? ` <span class="ai-tag"><span class="material-symbols-outlined">auto_awesome</span>AI</span>` : '';
          ovAuthor.innerHTML = `${getAuthorHtml(item)}${aiTagHtml}`;
          ovOpenRaw.href = `view.html?file=${encodeURIComponent(item.download_url)}`;
          docFrame.src = `view.html?file=${encodeURIComponent(item.download_url)}`;
          ovViews.textContent = item.views || 0;
          ovDownloads.textContent = item.downloads || 0;
          
          updateCounter(item.path, 'views').then(data => {
            if (data) {
              item.views = data.views;
              item.downloads = data.downloads;
              ovViews.textContent = data.views;
              ovDownloads.textContent = data.downloads;
              render();
            }
          });
  
          ovDownload.onclick = async () => {
            const data = await updateCounter(item.path, 'downloads');
            if (data) {
              item.views = data.views;
              item.downloads = data.downloads;
              ovViews.textContent = data.views;
              ovDownloads.textContent = data.downloads;
              render();
            }
            const a = document.createElement("a");
            a.href = item.download_url;
            a.download = item.name;
            document.body.appendChild(a);
            a.click();
            a.remove();
          };
        });
      }
  
      function closeOverlay() {
        toggleOverlay(overlay, false, () => {
          docFrame.src = "about:blank";
        });
      }
  
      function openInfoOverlay(mdFile) {
          toggleOverlay(infoOverlay, true, async () => {
              infoContent.innerHTML = "Loading...";
              try {
                  const url = `https://raw.githubusercontent.com/${owner}/${repo}/${BRANCH}/${mdFile}`;
                  const response = await fetch(url);
                  const mdContent = await response.text();
                  infoContent.innerHTML = marked.parse(mdContent);
              } catch (e) {
                  infoContent.innerHTML = `Failed to load content: ${e.message}`;
              }
          });
      }
  
      function closeInfoOverlay() {
        toggleOverlay(infoOverlay, false);
      }
  
      sortSelect.addEventListener("change", render);
      formatSelect.addEventListener("change", render);
      searchInput.addEventListener("input", render);
  
      gridBtn.addEventListener("click", () => {
        viewMode = "grid";
        gridBtn.classList.add("active"); gridBtn.setAttribute("aria-pressed", "true");
        listBtn.classList.remove("active"); listBtn.setAttribute("aria-pressed", "false");
        render();
      });
      listBtn.addEventListener("click", () => {
        viewMode = "list";
        listBtn.classList.add("active"); listBtn.setAttribute("aria-pressed", "true");
        gridBtn.classList.remove("active"); gridBtn.setAttribute("aria-pressed", "false");
        render();
      });
  
      aiToggleBtn.addEventListener("click", () => {
        showAI = !showAI;
        aiToggleBtn.classList.toggle("active-ai");
        aiToggleBtn.innerHTML = showAI ? `<span class="material-symbols-outlined">auto_awesome</span><b>Show AI</b>` : `<span class="material-symbols-outlined">auto_awesome</b></span><b>Hide AI</b>`;
        render();
      });
      
      // FILE TYPE toggle logic
      const types = ["ALL", "PDF", "DOCX"];
      let idx = 0;
      typeBtn.addEventListener("click", () => {
        idx = (idx + 1) % types.length;
        const currentType = types[idx];
        typeBtn.innerHTML = `<b>${currentType}</b>`;
        formatSelect.value = currentType.toLowerCase();
        
        typeBtn.classList.remove("active", "active-pdf", "active-docx");
        if (currentType === "PDF") {
            typeBtn.classList.add("active-pdf");
        } else if (currentType === "DOCX") {
            typeBtn.classList.add("active-docx");
        } else {
            typeBtn.classList.add("btn");
        }
        
        render();
      });
  
      backBtn.addEventListener("click", closeOverlay);
      overlay.addEventListener("click", (e) => { if (e.target === overlay) closeOverlay(); });
      infoBackBtn.addEventListener("click", closeInfoOverlay);
      infoOverlay.addEventListener("click", (e) => { if (e.target === infoOverlay) closeInfoOverlay(); });
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape" && overlay.classList.contains("open")) closeOverlay();
        if (e.key === "Escape" && infoOverlay.classList.contains("open")) closeInfoOverlay();
      });

      infoLinks.forEach(link => {
          link.addEventListener('click', (e) => {
              e.preventDefault();
              openInfoOverlay(link.dataset.md);
          });
      });
  
      const sortBtn = document.getElementById("sortBtn");
      const sortDropdown = document.getElementById("sortDropdown");
      sortBtn.addEventListener("click", () => sortDropdown.classList.toggle("open"));
      sortDropdown.querySelectorAll(".option").forEach(opt => {
        opt.addEventListener("click", () => {
          sortDropdown.querySelectorAll(".option").forEach(o => o.classList.remove("active"));
          opt.classList.add("active");
          sortSelect.value = opt.dataset.sort;
          render();
          sortDropdown.classList.remove("open");
          sortBtn.classList.toggle("active", opt.dataset.sort !== "updated-desc");
        });
      });
      document.addEventListener("click", e => {
        if (!sortBtn.contains(e.target) && !sortDropdown.contains(e.target)) {
          sortDropdown.classList.remove("open");
        }
      });
      
      async function incWebsiteView() {
          try {
              const res = await fetch(`${API_URL}?type=website`, { method: 'POST' });
              if (res.ok) {
                  const data = await res.json();
                  return data.views;
              }
          } catch(e) {
              console.error("Failed to increment website view count:", e);
          }
          return null;
      }
  
      (async function init() {
        try {
          allItems = await fetchNotes();
          const noteIds = allItems.map(item => item.path);
          if (noteIds.length > 0) {
              const stats = await getNoteStats(noteIds);
              allItems.forEach(item => {
                  if (stats[item.path]) {
                      item.views = stats[item.path].views;
                      item.downloads = stats[item.path].downloads;
                  }
              });
          }
          const newViews = await incWebsiteView();
          if (newViews !== null) websiteViewsEl.textContent = newViews;
          render();
        } catch(e) {
          console.error(e);
          container.innerHTML = `<div style="background:var(--panel);border:1px solid rgba(255,255,255,0.08);border-radius:16px;padding:18px;"><div style="font-weight:700;margin-bottom:6px;">Couldn’t load Notes/</div><div class="muted">Check that the repository, branch, and Notes folder exist and are public.</div></div>`;
        }
      })();
  </script>
</body>
</html>

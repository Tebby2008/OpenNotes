<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>OpenNotes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="icon" type="image/png" href="resources/favicon.png">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    :root{
      --bg:#f8f9fa;
      --panel:#fff;
      --panel-2:#e9ecef;
      --text:#212529;
      --muted:#6c757d;
      --accent:#96bfea;
      --accent-2:#b9d9f9;
      --gold:#ffc107;
      --shadow:0 10px 30px rgba(0,0,0,.1);
      --radius:16px;
      --radius-sm:12px;
      --radius-lg:22px;
      --gap:14px;
      --gap-lg:22px;
      --dark-header:#12171d;
      --footer-bg:#1e252e;
    }
    *,:after,:before{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:"Noto Sans",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      display:flex;
      flex-direction:column;
    }
    .material-symbols-outlined{
      font-variation-settings:'FILL' 0,'wght' 400,'GRAD' 0,'opsz' 24;
      font-size:24px;
      display:flex;
    }
    .title-section{
      height:50vh;
      background:var(--dark-header);
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      box-shadow:0 10px 30px rgba(0,0,0,.1);
      z-index:1;
    }
    .title-logo{
      width:75vw;
      height:auto;
      max-width:600px;
    }
    .logo-container{
      display:flex;
      flex-direction:column;
      align-items:center;
      margin-bottom:20px;
    }
    .logo-container p{
      color:rgba(255,255,255,.8);
      font-size:14px;
      margin-top:10px;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .logo-container p img{
      height:23.4px;
      width:auto;
    }
    .line{
      width:33vw;
      height:2px;
      background:rgba(255,255,255,.8);
      margin:20px auto;
    }
    @media (max-width:860px){
      .title-logo{width:90vw}
    }
    .controls{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:var(--gap);
      flex-wrap:wrap;
      background:var(--panel);
      border-bottom-left-radius:40px;
      border-bottom-right-radius:40px;
      padding:10px 18px;
      box-shadow:0 4px 12px rgba(0,0,0,.08);
      position:relative;
      z-index:2;
    }
    .left,.right{
      display:flex;
      align-items:center;
      gap:8px;
    }
    .chip{
      background:var(--panel-2);
      padding:8px 10px;
      border-radius:999px;
      color:var(--text);
      display:flex;
      align-items:center;
      gap:8px;
      border:1px solid rgba(0,0,0,.06);
      cursor:pointer;
    }
    .chip:hover{
      background:rgba(125,211,252,.1);
    }
    .chip select{
      background:transparent;
      color:var(--text);
      border:none;
      outline:0;
      font:inherit;
      appearance:none;
      padding-right:18px;
      cursor:pointer;
    }
    .chip .dot{
      width:8px;
      height:8px;
      border-radius:50%;
      background:var(--accent);
      box-shadow:0 0 12px var(--accent);
    }
    .search{
      display:flex;
      align-items:center;
      gap:8px;
      background:var(--panel-2);
      border-radius:999px;
      padding:8px 12px;
      border:1px solid rgba(0,0,0,.06);
      transition:box-shadow .2s ease;
    }
    .search:hover{
      box-shadow:0 0 0 2px rgba(125,211,252,.25) inset;
    }
    .search svg{
      width:18px;
      height:18px;
      opacity:.9;
    }
    .search input{
      width:140px;
      background:transparent;
      border:none;
      outline:0;
      color:var(--text);
      transition:width .25s ease;
      font:inherit;
    }
    .search input::placeholder{
      color:var(--muted);
    }
    .search:focus-within input{
      width:280px;
    }
    .toggle{
      display:flex;
      gap:8px;
      background:var(--panel-2);
      padding:6px;
      border-radius:999px;
      border:1px solid rgba(0,0,0,.06);
    }
    .btn{
      background:transparent;
      color:var(--text);
      border:none;
      border-radius:999px;
      padding:8px 12px;
      display:flex;
      align-items:center;
      gap:8px;
      cursor:pointer;
      transition:background .2s,transform .1s,box-shadow .2s;
    }
    .btn:hover{
      background:rgba(0,0,0,.06);
    }
    .btn:active{
      transform:translateY(1px);
    }
    .btn svg{
      width:18px;
      height:18px;
    }
    .btn.active{
      background:linear-gradient(90deg,rgba(125,211,252,.18),rgba(167,243,208,.15));
      box-shadow:0 0 0 2px rgba(125,211,252,.18) inset;
    }
    .btn.active-ai{
      background:#fffbeb;
      color:#b38600;
      box-shadow:0 0 0 2px var(--gold) inset;
    }
    .wrap{
      padding:18px;
      z-index:0;
      position:relative;
      margin-top:36px;
      margin-bottom:36px;
      flex:1;
    }
    .grid{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(240px,1fr));
      gap:18px;
      align-items:stretch;
    }
    .list{
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .card{
      position:relative;
      transition:transform .2s ease,box-shadow .2s ease;
      z-index:0;
      background:var(--panel);
      border-radius:var(--radius);
      box-shadow:0 4px 12px rgba(0,0,0,.08);
      overflow:hidden;
      cursor:pointer;
    }
    .card:hover{
      transform:translateY(-4px);
      box-shadow:0 8px 24px rgba(0,0,0,.15);
      z-index:10;
    }
    .thumb{
      background:var(--panel-2);
      height:180px;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      position:relative;
    }
    .thumb canvas,.thumb embed,.thumb iframe,.thumb img{
      width:100%;
      height:100%;
      object-fit:cover;
      border-radius:12px;
    }
    .fmt-badge{
      position:absolute;
      bottom:10px;
      left:10px;
      padding:6px 10px;
      font-size:12px;
      font-weight:600;
      border-radius:999px;
      background:rgba(255,255,255,.55);
      color:var(--text);
      border:1px solid rgba(0,0,0,.1);
      backdrop-filter:blur(4px);
    }
    .fmt-pdf{
      box-shadow:0 0 0 2px rgba(125,211,252,.35) inset;
    }
    .fmt-docx{
      box-shadow:0 0 0 2px rgba(167,243,208,.35) inset;
    }
    .body{
      padding:12px 14px 14px;
    }
    .title-line{
      font-weight:600;
      font-size:16px;
      margin:6px 0 6px;
      line-height:1.2;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .meta{
      display:flex;
      align-items:center;
      gap:8px;
      color:var(--muted);
      font-size:12px;
    }
    .meta .dot{
      width:4px;
      height:4px;
      border-radius:50%;
      background:var(--muted);
    }
    .ai-tag{
      background:#fffbeb;
      color:#b38600;
      font-size:10px;
      font-weight:600;
      padding:3px 6px;
      border-radius:6px;
      margin-left:6px;
      vertical-align:middle;
      display:inline-flex;
      align-items:center;
      gap:4px;
      border:1px solid var(--gold);
    }
    .ai-tag .material-symbols-outlined{
      font-size:12px;
      color:var(--gold);
      font-variation-settings:'FILL' 1,'wght' 700;
    }
    .stats{
      margin-top:10px;
      display:flex;
      align-items:center;
      gap:12px;
      color:var(--muted);
      font-size:12px;
    }
    .stat{
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .stat svg{
      width:16px;
      height:16px;
      opacity:.85;
    }
    .download-btn{
      background:var(--accent);
      color:#fff;
      border:none;
      padding:6px;
      border-radius:50%;
      width:36px;
      height:36px;
      display:flex;
      align-items:center;
      justify-content:center;
      flex-shrink:0;
      cursor:pointer;
    }
    .download-btn svg{
      width:18px;
      height:18px;
      fill:#fff;
    }
    .row{
      display:grid;
      grid-template-columns:86px 1fr auto;
      gap:14px;
      align-items:center;
      background:var(--panel);
      border:1px solid rgba(0,0,0,.06);
      border-radius:var(--radius);
      padding:10px;
      box-shadow:0 4px 12px rgba(0,0,0,.05);
      transition:transform .2s,box-shadow .2s;
      cursor:pointer;
    }
    .row:hover{
      transform:translateY(-1px);
    }
    .row .thumb{
      height:66px;
      border-radius:12px;
    }
    .row .main{
      display:grid;
      grid-template-columns:minmax(200px,2fr) repeat(4,minmax(90px,1fr));
      gap:10px;
      align-items:center;
    }
    .row .main .cell{
      display:flex;
      align-items:center;
      gap:6px;
      min-width:0;
    }
    .row .title-line{
      margin:0;
      font-size:15px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .row .right-end{
      display:flex;
      align-items:center;
      gap:8px;
    }
    .overlay{
      position:fixed;
      inset:0;
      background:rgba(255,255,255,.72);
      backdrop-filter:blur(8px);
      display:none;
      z-index:1000;
      padding:20px;
      opacity:0;
      transition:opacity .2s ease;
    }
    .overlay.open{
      display:block;
      opacity:1;
    }
    .viewer{
      background:rgba(255,255,255,.85);
      border:1px solid rgba(0,0,0,.08);
      box-shadow:var(--shadow);
      border-radius:var(--radius-lg);
      height:100%;
      display:grid;
      grid-template-columns:1fr minmax(280px,360px);
      overflow:hidden;
      backdrop-filter:blur(16px);
    }
    .viewer .left{
      padding:12px;
      background:var(--panel-2);
      border-right:1px solid rgba(0,0,0,.06);
    }
    .docframe{
      width:100%;
      height:100%;
      border:none;
      border-radius:12px;
      background:var(--panel-2);
    }
    .viewer .right{
      padding:16px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .viewer .right .title{
      justify-content:flex-start;
      padding:0;
      font-size:22px;
    }
    .kv{
      color:var(--muted);
      font-size:13px;
      display:flex;
      gap:8px;
      align-items:center;
    }
    .kv strong{
      color:var(--text);
      font-weight:600;
    }
    .back{
      position:absolute;
      bottom:26px;
      left:26px;
      z-index:1001;
      background:rgba(255,255,255,.4);
      color:var(--text);
      border:1px solid rgba(0,0,0,.18);
      padding:12px 18px;
      font-size:16px;
      border-radius:999px;
      display:flex;
      align-items:center;
      gap:8px;
      cursor:pointer;
      backdrop-filter:blur(4px);
      transition:transform .1s,background .2s,box-shadow .2s;
    }
    .back svg{
      width:22px;
      height:22px;
    }
    .back:hover{
      background:rgba(255,255,255,.5);
    }
    .back:active{
      transform:translateY(1px);
    }
    .overlay-content{
      padding:2rem;
      text-align:left;
      color:#333;
      line-height:1.6;
      font-family:"Noto Sans",sans-serif;
      background:#fff;
      border-radius:12px;
      height:100%;
      overflow-y:auto;
    }
    .overlay-content a{
      color:var(--accent);
      text-decoration:none;
    }
    .overlay-content a:hover{
      text-decoration:underline;
    }
    .styled-btn{
      background:var(--panel-2);
      color:var(--text);
      border:1px solid rgba(0,0,0,.08);
      border-radius:999px;
      padding:8px 12px;
      display:flex;
      align-items:center;
      gap:8px;
      font-weight:500;
      cursor:pointer;
      transition:background .2s,transform .1s,box-shadow .2s;
      text-decoration:none;
      font-size:1rem;
    }
    .styled-btn:hover{
      background:rgba(0,0,0,.06);
    }
    .styled-btn:active{
      transform:translateY(1px);
    }
    .styled-btn svg{
      width:18px;
      height:18px;
    }
    .styled-btn.download-accent{
      background:var(--accent);
      color:#fff;
      border-color:rgba(255,255,255,.1);
    }
    .styled-btn.download-accent svg{
      fill:#fff;
    }
    .pill{
      color:#001;
      background:var(--accent);
      border-radius:999px;
      padding:4px 8px;
      font-weight:700;
      font-size:12px;
    }
    .pill.docx{
      background:var(--accent-2);
    }
    a.clean{
      color:inherit;
      text-decoration:none;
      cursor:pointer;
    }
    .muted{
      color:var(--muted);
    }
    .hide{
      display:none;
    }
    .icon-only{
      padding:8px;
    }
    .sort-wrapper{
      position:relative;
    }
    .custom-dropdown{
      position:absolute;
      top:110%;
      left:0;
      background:var(--panel);
      border:1px solid rgba(0,0,0,.1);
      border-radius:8px;
      box-shadow:0 6px 20px rgba(0,0,0,.15);
      z-index:20;
      display:flex;
      flex-direction:column;
      min-width:180px;
      opacity:0;
      pointer-events:none;
      transform:translateY(10px);
      transition:opacity .15s ease,transform .15s ease;
    }
    .custom-dropdown.open{
      opacity:1;
      pointer-events:auto;
      transform:translateY(0);
    }
    .custom-dropdown .option{
      padding:8px 12px;
      cursor:pointer;
      transition:background .15s;
    }
    .custom-dropdown .option:hover{
      background:rgba(125,211,252,.1);
    }
    .custom-dropdown .option.active{
      background:var(--accent);
      color:#fff;
    }
    footer{
      background:var(--footer-bg);
      color:rgba(255,255,255,.6);
      padding:18px 24px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-top:auto;
      font-size:14px;
    }
    footer .left{
      display:flex;
      gap:16px;
      align-items:center;
    }
    footer .left a{
      color:inherit;
      text-decoration:none;
      transition:color .2s;
      font-weight:500;
      display:flex;
      align-items:center;
      gap:6px;
    }
    footer .left a:hover{
      color:rgba(255,255,255,.9);
    }
    footer .left a .icon{
      width:18px;
      height:18px;
      fill:rgba(255,255,255,.6);
    }
    footer .left a:hover .icon{
      fill:rgba(255,255,255,.9);
    }
    .total-views{
      display:flex;
      align-items:center;
      gap:8px;
    }
    .total-views .material-symbols-outlined{
      font-size:20px;
      color:rgba(255,255,255,.6);
    }
    .total-views span{
      font-weight:600;
      color:rgba(255,255,255,.9);
    }
    @media (max-width:860px){
      .viewer{grid-template-columns:1fr}
      .viewer .right{border-top:1px solid rgba(0,0,0,.06)}
    }
  </style>
</head>
<body>

  <header>
    <div class="title-section">
      <div class="logo-container">
        <img src="resources/logo.svg" alt="OpenNotes Logo" class="title-logo" />
        <div class="line"></div>
        <p>
          the open platform for notes by 
          <a href="https://ingenium.rf.gd" target="_blank" rel="noopener">
            <img src="resources/ingenium.png" alt="Ingenium Logo" />
          </a>
        </p>
      </div>
    </div>
    <div class="controls">
      <select id="sortSelect" style="display:none">
        <option value="updated-desc" selected>Last updated ↓</option>
        <option value="updated-asc">Last updated ↑</option>
        <option value="title-asc">Title A→Z</option>
        <option value="title-desc">Title Z→A</option>
        <option value="format-asc">Format A→Z</option>
      </select>

      <select id="formatSelect" style="display:none">
        <option value="all" selected>All formats</option>
        <option value="pdf">PDF</option>
        <option value="docx">DOCX</option>
      </select>

      <div class="left">
        <div class="sort-wrapper">
          <button id="sortBtn" class="btn icon-only" title="Sort (Last Updated)">
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M3 4h18v2H3V4zm4 7h10v2H7v-2zm3 7h4v2h-4v-2z"/></svg>
          </button>
          <div id="sortDropdown" class="custom-dropdown hidden">
            <div data-sort="updated-desc" class="option active">Last updated ↓</div>
            <div data-sort="updated-asc" class="option">Last updated ↑</div>
            <div data-sort="title-asc" class="option">Title A→Z</div>
            <div data-sort="title-desc" class="option">Title Z→A</div>
            <div data-sort="format-asc" class="option">Format A→Z</div>
          </div>
        </div>
        <button id="typeBtn" class="btn">ALL</button>
        <button id="aiToggleBtn" class="btn active-ai" title="Toggle AI Content">Show AI</button>
        <div class="search" role="search">
          <svg viewBox="0 0 24 24" fill="currentColor"><path d="M15.5 14h-.79l-.28-.27a6.471 6.471 0 0 0 1.57-4.23C15.99 6.01 12.98 3 9.5 3S3.01 6.01 3.01 9.5 6.02 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
          <input id="searchInput" type="text" placeholder="Search notes..." aria-label="Search notes" />
        </div>
      </div>
      <div class="right">
        <button id="uploadBtn" class="btn icon-only" title="How to Upload">
          <span class="material-symbols-outlined">upload</span>
        </button>
        <div class="toggle" role="tablist" aria-label="View mode">
          <button id="gridBtn" class="btn active icon-only" aria-pressed="true" title="Box view">
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M3 3h8v8H3V3zm10 0h8v8h-8V3zM3 13h8v8H3v-8zm10 0h8v8h-8v-8z"/></svg>
          </button>
          <button id="listBtn" class="btn icon-only" aria-pressed="false" title="List view">
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M3 5h18v2H3V5zm0 6h18v2H3v-2zm0 6h18v2H3v-2z"/></svg>
          </button>
        </div>
      </div>
    </div>
  </header>

  <main class="wrap">
    <section id="itemsContainer" class="grid" aria-live="polite"></section>
  </main>

  <div id="overlay" class="overlay" aria-hidden="true">
    <button id="backBtn" class="back" aria-label="Back">
      <svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
      Back
    </button>
    <div class="viewer" role="dialog" aria-modal="true" aria-label="Document viewer">
      <div class="left">
        <iframe id="docFrame" class="docframe" title="Document preview"></iframe>
      </div>
      <div class="right">
        <div class="title" id="ovTitle">Title</div>
        <div class="kv"><span class="pill" id="ovFormat">PDF</span></div>
        <div class="kv">Date: <strong id="ovDate">—</strong></div>
        <div class="kv">Author: <strong id="ovAuthor">—</strong></div>
        <div class="kv">Views: <strong id="ovViews">0</strong></div>
        <div class="kv">Downloads: <strong id="ovDownloads">0</strong></div>
        <div style="margin-top:8px; display:flex; flex-direction:column; gap:10px;">
          <a id="ovOpenRaw" class="styled-btn" target="_blank" rel="noopener">
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M14 3v2h3.59l-9.83 9.83 1.41 1.41L19 6.41V10h2V3z"/><path d="M5 5h5V3H3v7h2z"/></svg>
            View Raw
          </a>
          <button id="ovDownload" class="styled-btn download-accent">
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M5 20h14v-2H5v2zM12 2v12l4-4h-3V2h-2v8H8l4 4z"/></svg>
            Download
          </button>
        </div>
      </div>
    </div>
  </div>

  <div id="infoOverlay" class="overlay" aria-hidden="true">
    <button id="infoBackBtn" class="back" aria-label="Back">
      <svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
      Back
    </button>
    <div class="viewer" style="grid-template-columns: 1fr;">
      <div class="overlay-content" id="infoContent"></div>
    </div>
  </div>

  <footer>
    <div class="left">
      <a href="#" class="info-link" data-md="resources/terms-privacy.md">Terms & Privacy</a>
      <a href="#" class="info-link" data-md="resources/contact.md">Contact Us</a>
      <a href="#" class="info-link" data-md="resources/about.md">About</a>
      <a href="https://github.com/Tebby2008/OpenNotes" target="_blank" rel="noopener">
        <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
          <path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.89 8.207 11.415.6.11.82-.26.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.043-1.61-4.043-1.61C4.425 18.043 3.6 17.062 3.6 17.062c-1.087-.744.084-.73.084-.73 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.493.996.108-.775.418-1.305.762-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.046.138 3.003.404 2.29-1.552 3.297-1.23 3.297-1.23.645 1.653.24 2.873.105 3.176.77.84 1.235 1.91 1.235 3.22 0 4.61-2.801 5.626-5.476 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.95 24 18.363 24 13.297c0-6.627-5.373-12-12-12"/>
        </svg>
        Github
      </a>
    </div>
    <div class="right total-views">
      <span class="material-symbols-outlined">visibility</span>
      <span id="websiteViews">0</span>
    </div>
  </footer>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
  <script>
    const REPO_OWNER = "Tebby2008",REPO_NAME="OpenNotes",BRANCH="main",NOTES_PATH="Notes",API_URL="https://open-notes.tebby2008-li.workers.dev";
    (function(){
      try{
        const host=location.hostname,path=location.pathname.replace(/^\/+/,"").split("/"),isPages=host.endsWith(".github.io");
        if(isPages){
          const owner=host.split(".github.io")[0],repo=path[0]||REPO_NAME;
          if(REPO_OWNER.startsWith("<"))window.owner=owner;
          if(REPO_NAME.startsWith("<"))window.repo=repo
        }
      }catch(e){}
    })();
    const owner=window.owner||REPO_OWNER,repo=window.repo||REPO_NAME;
    let allItems=[],viewMode="grid",showAI=!0;
    const container=document.getElementById("itemsContainer"),sortSelect=document.getElementById("sortSelect"),formatSelect=document.getElementById("formatSelect"),searchInput=document.getElementById("searchInput"),gridBtn=document.getElementById("gridBtn"),listBtn=document.getElementById("listBtn"),aiToggleBtn=document.getElementById("aiToggleBtn"),overlay=document.getElementById("overlay"),backBtn=document.getElementById("backBtn"),docFrame=document.getElementById("docFrame"),ovTitle=document.getElementById("ovTitle"),ovFormat=document.getElementById("ovFormat"),ovDate=document.getElementById("ovDate"),ovAuthor=document.getElementById("ovAuthor"),ovViews=document.getElementById("ovViews"),ovDownloads=document.getElementById("ovDownloads"),ovOpenRaw=document.getElementById("ovOpenRaw"),ovDownload=document.getElementById("ovDownload"),infoOverlay=document.getElementById("infoOverlay"),infoBackBtn=document.getElementById("infoBackBtn"),infoContent=document.getElementById("infoContent"),uploadBtn=document.getElementById("uploadBtn"),infoLinks=document.querySelectorAll(".info-link"),websiteViewsEl=document.getElementById("websiteViews"),sleep=ms=>new Promise(r=>setTimeout(r,ms)),fmtDate=iso=>{if(!iso)return"—";const d=new Date(iso),dd=String(d.getDate()).padStart(2,"0"),mm=String(d.getMonth()+1).padStart(2,"0"),yyyy=d.getFullYear();return`${dd}-${mm}-${yyyy}`},stripExt=name=>name.replace(/\.[^/.]+$/,""),extOf=name=>(name.split(".").pop()||"").toLowerCase();
    async function incView(item){
      try{
        const res=await fetch(`${API_URL}?type=note&noteId=${item.path}&counter=views`,{method:"POST"}),data=await res.json();
        if(data&&void 0!==data.views){
          item.views=data.views,item.downloads=data.downloads;
          return{views:item.views,downloads:item.downloads}
        }
      }catch(e){
        console.error("Failed to increment view count:",e)
      }
      return null
    }
    async function incDownload(item){
      try{
        const res=await fetch(`${API_URL}?type=note&noteId=${item.path}&counter=downloads`,{method:"POST"}),data=await res.json();
        if(data&&void 0!==data.downloads){
          item.views=data.views,item.downloads=data.downloads;
          return{views:item.views,downloads:item.downloads}
        }
      }catch(e){
        console.error("Failed to increment download count:",e)
      }
      return null
    }
    async function incWebsiteView(){
      try{
        const res=await fetch(`${API_URL}?type=website`,{method:"POST"});
        if(res.ok){
          const data=await res.json();
          if(void 0!==data.views)return data.views
        }
      }catch(e){
        console.error("Failed to increment website view count:",e)
      }
      return null
    }
    async function getApiKeys(){
      const res=await fetch(`${API_URL}?list=true`,{method:"GET"});
      return res.ok?await res.json():[]
    }
    async function fetchNotes(){
      const url=`https://raw.githubusercontent.com/${owner}/${repo}/${BRANCH}/notes_metadata.json`,res=await fetch(url);
      if(!res.ok)throw new Error("Failed to fetch notes_metadata.json. Check that the file exists and the repository is public.");
      const metadata=await res.json();
      return metadata.map(meta=>{
        const format=extOf(meta.name);
        if("pdf"!==format&&"docx"!==format)return null;
        return{
          name:meta.name,
          title:stripExt(meta.name),
          path:meta.path,
          download_url:meta.download_url,
          html_url:`https://github.com/${owner}/${repo}/blob/${BRANCH}/${encodeURIComponent(meta.path)}`,
          format:format,
          updatedAt:meta.last_updated,
          author:meta.author,
          is_ai_generated:meta.is_ai_generated,
          views:0,
          downloads:0
        }
      }).filter(Boolean)
    }
    async function fetchMarkdownFile(path){
      try{
        const url=`https://raw.githubusercontent.com/${owner}/${repo}/${BRANCH}/${path}`,response=await fetch(url);
        return response.ok?await response.text():`Failed to fetch markdown file from: ${url}`
      }catch(e){
        return`Error fetching markdown file: ${e.message}`
      }
    }
    function render(){
      const query=searchInput.value.trim().toLowerCase(),fmt=formatSelect.value;
      let list=[...allItems];
      !showAI&&(list=list.filter(x=>!x.is_ai_generated)),"all"!==fmt&&(list=list.filter(x=>x.format===fmt)),query&&(list=list.filter(x=>x.title.toLowerCase().includes(query)));
      const sort=sortSelect.value;
      list.sort((a,b)=>{
        switch(sort){
          case"title-asc":return a.title.localeCompare(b.title);
          case"title-desc":return b.title.localeCompare(a.title);
          case"format-asc":return a.format.localeCompare(b.format)||a.title.localeCompare(b.title);
          case"updated-asc":return new Date(a.updatedAt||0)-new Date(b.updatedAt||0);
          case"updated-desc":
          default:return new Date(b.updatedAt||0)-new Date(a.updatedAt||0)
        }
      }),container.innerHTML="",container.className="grid"===viewMode?"grid":"list";
      for(const it of list)container.appendChild("grid"===viewMode?renderCard(it):renderRow(it))
    }
    function renderFormatBadge(fmt){
      const span=document.createElement("span");
      return span.className=`fmt-badge fmt-${fmt}`,span.textContent=fmt.toUpperCase(),span
    }
    function makeThumb(fmt,url){
      const holder=document.createElement("div");
      return holder.className="thumb",holder.style.borderRadius="12px",fmt==="pdf"&&window.pdfjsLib? (holder.innerHTML=`<canvas></canvas>`,renderPdfFirstPage(url,holder.querySelector("canvas")).catch(()=>holder.innerHTML=fileIcon("pdf"))):holder.innerHTML=fileIcon(fmt),holder
    }
    function fileIcon(fmt){
      const label=fmt.toUpperCase(),color="pdf"===fmt?"rgba(125,211,252,.18)":"rgba(167,243,208,.18)";
      return`
        <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;width:100%;height:100%;background:${color}">
          <svg viewBox="0 0 24 24" fill="currentColor" width="42" height="42" aria-hidden="true">
            <path d="M14 2H6a2 2 0 0 0-2 2v16c0 1.1.9 2 2 2h12a2 2 0 0 0 2-2V8l-6-6zM6 4h7v5h5v11H6V4z"/>
          </svg>
          <div class="pill ${"docx"===fmt?"docx":""}" style="margin-top:8px;">${label}</div>
        </div>
      `
    }
    async function renderPdfFirstPage(url,canvas){
      const pdf=await pdfjsLib.getDocument({url}).promise,page=await pdf.getPage(1),viewport=page.getViewport({scale:.5}),scale=Math.min(1.2,Math.max(.6,canvas.parentElement.clientWidth/(1.2*viewport.width))),vp=page.getViewport({scale}),ctx=canvas.getContext("2d");
      canvas.width=vp.width,canvas.height=vp.height,await page.render({canvasContext:ctx,viewport:vp}).promise
    }
    function renderCard(it){
      const card=document.createElement("article");
      card.className="card",card.tabIndex=0,card.setAttribute("role","button"),card.setAttribute("aria-label",`${it.title}`);
      const thumb=makeThumb(it.format,it.download_url);
      thumb.appendChild(renderFormatBadge(it.format));
      const body=document.createElement("div");
      body.className="body";
      const title=document.createElement("div");
      title.className="title-line",title.textContent=it.title;
      const authorName=(it.author||"").toLowerCase(),displayAuthor="tebby2008"===authorName||"tebby"===authorName?"Chenyu Li":it.author,meta=document.createElement("div");
      meta.className="meta";
      const aiTagHtml=it.is_ai_generated?`<span class="ai-tag"><span class="material-symbols-outlined">auto_awesome</span>AI</span>`:"";
      meta.innerHTML=`<span>${displayAuthor||"Unknown"} ${aiTagHtml}</span><span class="dot"></span><span>${fmtDate(it.updatedAt)}</span>`;
      const stats=document.createElement("div");
      stats.className="stats",stats.innerHTML=`<span class="stat"><svg viewBox="0 0 24 24"><path d="M12 5c-7 0-10 7-10 7s3 7 10 7 10-7 10-7-3-7-10-7zm0 12c-2.8 0-5-2.24-5-5s2.2-5 5-5 5 2.24 5 5-2.2 5-5 5z"/><circle cx="12" cy="12" r="2.5"/></svg> <span data-view>${it.views||0}</span></span><span class="stat"><svg viewBox="0 0 24 24"><path d="M5 20h14v-2H5v2zM12 2v12l4-4h-3V2h-2v8H8l4 4z"/></svg> <span data-dl>${it.downloads||0}</span></span>`;
      const dlBtn=document.createElement("button");
      return dlBtn.className="download-btn",dlBtn.title="Download",dlBtn.innerHTML=`<svg viewBox="0 0 24 24"><path d="M5 20h14v-2H5v2zM12 2v12l4-4h-3V2h-2v8H8l4 4z"/></svg>`,dlBtn.addEventListener("click",async e=>{
        e.stopPropagation();
        const data=await incDownload(it);
        data&&(stats.querySelector("[data-view]").textContent=data.views,stats.querySelector("[data-dl]").textContent=data.downloads);
        const a=document.createElement("a");
        a.href=it.download_url,a.download=it.name,document.body.appendChild(a),a.click(),a.remove()
      }),card.appendChild(thumb),body.appendChild(title),body.appendChild(meta),body.appendChild(stats),card.appendChild(body),card.addEventListener("click",()=>openOverlay(it)),card.addEventListener("keydown",e=>{("Enter"===e.key||" "===e.key)&&(e.preventDefault(),openOverlay(it))}),card
    }
    const sortBtn=document.getElementById("sortBtn"),sortDropdown=document.getElementById("sortDropdown");
    sortBtn.addEventListener("click",()=>sortDropdown.classList.toggle("open")),sortDropdown.querySelectorAll(".option").forEach(opt=>{opt.addEventListener("click",()=>{sortDropdown.querySelectorAll(".option").forEach(o=>o.classList.remove("active")),opt.classList.add("active"),sortSelect.value=opt.dataset.sort,render(),sortDropdown.classList.remove("open"),"updated-desc"!==opt.dataset.sort?sortBtn.classList.add("active"):sortBtn.classList.remove("active")})}),document.addEventListener("click",e=>{sortBtn.contains(e.target)||sortDropdown.contains(e.target)||sortDropdown.classList.remove("open")});
    const typeBtn=document.getElementById("typeBtn"),types=["ALL","PDF","DOCX"];
    let idx=0;
    function renderRow(it){
      const row=document.createElement("article");
      row.className="row",row.tabIndex=0,row.setAttribute("role","button"),row.setAttribute("aria-label",`${it.title}`);
      const thumb=makeThumb(it.format,it.download_url);
      thumb.style.height="66px";
      const fmtBadge=thumb.querySelector(".fmt-badge");
      fmtBadge&&(fmtBadge.style.display="none"),row.appendChild(thumb);
      const main=document.createElement("div");
      main.className="main";
      const cellTitle=document.createElement("div");
      cellTitle.className="cell",cellTitle.innerHTML=`<div class="title-line">${it.title}</div>`;
      const authorName=(it.author||"").toLowerCase(),displayAuthor="tebby2008"===authorName||"tebby"===authorName?"Chenyu Li":it.author,cellAuthor=document.createElement("div");
      if(cellAuthor.className="cell muted",cellAuthor.textContent=displayAuthor||"Unknown",it.is_ai_generated){
        const aiTag=document.createElement("span");
        aiTag.className="ai-tag",aiTag.innerHTML=`<span class="material-symbols-outlined">auto_awesome</span>AI`,cellAuthor.appendChild(aiTag)
      }
      const cellDate=document.createElement("div");
      cellDate.className="cell muted",cellDate.textContent=fmtDate(it.updatedAt);
      const cellFmt=document.createElement("div");
      cellFmt.className="cell";
      const pill=document.createElement("span");
      pill.className=`pill ${"docx"===it.format?"docx":""}`,pill.textContent=it.format.toUpperCase(),cellFmt.appendChild(pill);
      const cellStats=document.createElement("div");
      cellStats.className="cell muted",cellStats.innerHTML=`<span class="stat"><svg viewBox="0 0 24 24"><path d="M12 5c-7 0-10 7-10 7s3 7 10 7 10-7 10-7-3-7-10-7zm0 12c-2.8 0-5-2.24-5-5s2.2-5 5-5 5 2.24 5 5-2.2 5-5 5z"/><circle cx="12" cy="12" r="2.5"/></svg> <span data-view>${it.views||0}</span></span><span class="stat" style="margin-left:10px;"><svg viewBox="0 0 24 24"><path d="M5 20h14v-2H5v2zM12 2v12l4-4h-3V2h-2v8H8l4 4z"/></svg> <span data-dl>${it.downloads||0}</span></span>`;
      main.appendChild(cellTitle),main.appendChild(cellAuthor),main.appendChild(cellDate),main.appendChild(cellFmt),main.appendChild(cellStats),row.appendChild(main);
      const rightEnd=document.createElement("div");
      return rightEnd.className="right-end",rightEnd.innerHTML=`<button class="btn" title="Download"><svg viewBox="0 0 24 24"><path d="M5 20h14v-2H5v2zM12 2v12l4-4h-3V2h-2v8H8l4 4z"/></svg></button>`,rightEnd.querySelector("button").addEventListener("click",async e=>{
        e.stopPropagation();
        const data=await incDownload(it);
        data&&(cellStats.querySelector("[data-view]").textContent=data.views,cellStats.querySelector("[data-dl]").textContent=data.downloads);
        const a=document.createElement("a");
        a.href=it.download_url,a.download=it.name,document.body.appendChild(a),a.click(),a.remove()
      }),row.appendChild(rightEnd),row.addEventListener("click",()=>openOverlay(it)),row.addEventListener("keydown",e=>{("Enter"===e.key||" "===e.key)&&(e.preventDefault(),openOverlay(it))}),row
    }
    function openOverlay(item){
      document.body.style.overflow="hidden",overlay.style.display="block",overlay.setAttribute("aria-hidden","false"),requestAnimationFrame(()=>{overlay.classList.add("open")}),ovTitle.textContent=item.title,ovFormat.textContent=item.format.toUpperCase(),ovFormat.className=`pill ${"docx"===item.format?"docx":""}`,ovDate.textContent=fmtDate(item.updatedAt);
      const authorName=(item.author||"").toLowerCase(),displayAuthor="tebby2008"===authorName||"tebby"===authorName?"Chenyu Li":item.author,aiTagHtml=item.is_ai_generated?` <span class="ai-tag"><span class="material-symbols-outlined">auto_awesome</span>AI</span>`:"";
      ovAuthor.innerHTML=`${displayAuthor}${aiTagHtml}`,ovOpenRaw.href=`view.html?file=${encodeURIComponent(item.download_url)}`,ovOpenRaw.target="_blank",docFrame.src=`view.html?file=${encodeURIComponent(item.download_url)}`,ovViews.textContent=item.views||0,ovDownloads.textContent=item.downloads||0,incView(item).then(data=>{data&&(ovViews.textContent=data.views,ovDownloads.textContent=data.downloads,render())}).catch(e=>console.error("Failed to increment view count:",e)),ovDownload.onclick=async()=>{
        const data=await incDownload(item);
        data&&(ovViews.textContent=data.views,ovDownloads.textContent=data.downloads,render());
        const a=document.createElement("a");
        a.href=item.download_url,a.download=item.name,document.body.appendChild(a),a.click(),a.remove()
      }
    }
    function closeOverlay(){
      overlay.classList.remove("open"),overlay.addEventListener("transitionend",function handler(){overlay.classList.contains("open")||(overlay.style.display="none",overlay.setAttribute("aria-hidden","true"),docFrame.src="about:blank",document.body.style.overflow="",overlay.removeEventListener("transitionend",handler))})
    }
    function openInfoOverlay(mdFile){
      document.body.style.overflow="hidden",infoOverlay.style.display="block",infoOverlay.setAttribute("aria-hidden","false"),requestAnimationFrame(()=>{infoOverlay.classList.add("open")}),infoContent.innerHTML="Loading...",fetchMarkdownFile(mdFile).then(mdContent=>infoContent.innerHTML=marked.parse(mdContent)).catch(e=>infoContent.innerHTML=`Failed to load content: ${e}`)
    }
    function closeInfoOverlay(){
      infoOverlay.classList.remove("open"),infoOverlay.addEventListener("transitionend",function handler(){infoOverlay.classList.contains("open")||(infoOverlay.style.display="none",infoOverlay.setAttribute("aria-hidden","true"),document.body.style.overflow="",infoOverlay.removeEventListener("transitionend",handler))},{once:!0})
    }
    gridBtn.addEventListener("click",()=>{
      viewMode="grid",gridBtn.classList.add("active"),gridBtn.setAttribute("aria-pressed","true"),listBtn.classList.remove("active"),listBtn.setAttribute("aria-pressed","false"),render()
    }),listBtn.addEventListener("click",()=>{
      viewMode="list",listBtn.classList.add("active"),listBtn.setAttribute("aria-pressed","true"),gridBtn.classList.remove("active"),gridBtn.setAttribute("aria-pressed","false"),render()
    }),aiToggleBtn.addEventListener("click",()=>{
      showAI=!showAI,aiToggleBtn.classList.toggle("active-ai"),aiToggleBtn.textContent=showAI?"Show AI":"Hide AI",render()
    }),backBtn.addEventListener("click",closeOverlay),overlay.addEventListener("click",e=>{e.target===overlay&&closeOverlay()}),document.addEventListener("keydown",e=>{"Escape"===e.key&&overlay.classList.contains("open")&&closeOverlay()}),uploadBtn.addEventListener("click",()=>openInfoOverlay("resources/upload.md")),infoBackBtn.addEventListener("click",closeInfoOverlay),infoOverlay.addEventListener("click",e=>{e.target===infoOverlay&&closeInfoOverlay()}),infoLinks.forEach(link=>{link.addEventListener("click",e=>{e.preventDefault(),openInfoOverlay(link.dataset.md)})}),async function init(){
      try{
        allItems=await fetchNotes();
        const githubPaths=new Set(allItems.map(item=>item.path)),dbKeys=await getApiKeys(),noteKeysToDelete=dbKeys.filter(key=>"total-website-visits"!==key&&!githubPaths.has(key));
        for(const key of noteKeysToDelete)console.log(`Deleting counter for removed note: ${key}`),await fetch(`${API_URL}?noteId=${key}`,{method:"DELETE"});
        const notePromises=allItems.map(async note=>{
          try{
            const res=await fetch(`${API_URL}?noteId=${note.path}`,{method:"GET"});
            if(res.ok){
              const data=await res.json();
              note.views=data.views||0,note.downloads=data.downloads||0
            }else note.views=0,note.downloads=0
          }catch(e){
            console.error("Failed to fetch count for note:",note.path,e),note.views=0,note.downloads=0
          }
        });
        await Promise.all(notePromises);
        const newViews=await incWebsiteView();
        null!==newViews&&(websiteViewsEl.textContent=newViews),render()
      }catch(e){
        console.error(e),container.innerHTML=`
          <div style="background:var(--panel);border:1px solid rgba(255,255,255,0.08);border-radius:16px;padding:18px;">
            <div style="font-weight:700;margin-bottom:6px;">Couldn’t load Notes/</div>
            <div class="muted">Check that the repository, branch, and Notes folder exist and are public.</div>
          </div>
        `
      }
    }()
  </script>
</body>
</html>

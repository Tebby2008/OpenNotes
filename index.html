<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>OpenNotes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="icon" type="image/png" href="resources/favicon.png">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <style>
    :root{
      --bg: #f8f9fa;
      --panel: #ffffff;
      --panel-2: #e9ecef;
      --text: #212529;
      --muted: #6c757d;
      --accent: #96bfea;
      --accent-2: #b9d9f9;
      --shadow:0 10px 30px rgba(0,0,0,0.1);
      --radius:16px;
      --radius-sm:12px;
      --radius-lg:22px;
      --gap:14px;
      --gap-lg:22px;
      --dark-header: #12171d;
      --footer-bg: #1e252e;
      --ai-pill: #ffc107;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:"Noto Sans", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      display: flex;
      flex-direction: column;
    }

    .material-symbols-outlined {
      font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
      font-size: 24px;
      display: flex;
    }
    
    /* Redesigned Header */
    .title-section{
      height: 50vh;
      background: var(--dark-header);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      z-index: 1;
    }
    .title-logo {
        width: 75vw;
        height: auto;
        max-width: 600px;
    }
    .logo-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-bottom: 20px;
    }
    .logo-container p {
        color: rgba(255,255,255,0.8);
        font-size: 14px;
        margin-top: 10px;
        display: flex;
        align-items: center;
        gap: 6px;
    }
    .logo-container p img {
        height: 23.4px;
        width: auto;
    }
    .line {
      width: 33vw;
      height: 2px;
      background: rgba(255,255,255,0.8);
      margin: 20px auto;
    }
    @media (max-width: 860px){
      .title-logo { width: 90vw; }
    }

    /* Controls */
    .controls{
      display:flex; align-items:center; justify-content:space-between;
      gap:var(--gap); flex-wrap:wrap;
      background:var(--panel);
      border-bottom-left-radius: 40px;
      border-bottom-right-radius: 40px;
      padding:10px 18px;
      box-shadow:0 4px 12px rgba(0,0,0,0.08);
      position: relative;
      z-index: 2;
    }

    .left, .right{display:flex; align-items:center; gap:8px}
    .chip{
      background:var(--panel-2);
      padding:8px 10px; border-radius:999px; color:var(--text);
      display:flex; align-items:center; gap:8px; border:1px solid rgba(0,0,0,0.06);
      cursor:pointer;
    }
    .chip:hover{
      background: rgba(125,211,252,0.1);
    }
    .chip select{
      background:transparent; color:var(--text); border:none; outline:none;
      font:inherit; appearance:none; padding-right:18px; cursor:pointer;
    }
    .chip .dot{
      width:8px; height:8px; border-radius:50%; background:var(--accent);
      box-shadow:0 0 12px var(--accent);
    }

    /* Expanding search */
    .search{
      display:flex; align-items:center; gap:8px;
      background:var(--panel-2); border-radius:999px;
      padding:8px 12px; border:1px solid rgba(0,0,0,0.06);
      transition: box-shadow .2s ease;
    }
    .search:hover{ box-shadow:0 0 0 2px rgba(125,211,252,0.25) inset; }
    .search svg{width:18px; height:18px; opacity:0.9}
    .search input{
      width:110px; background:transparent; border:none; outline:none; color:var(--text);
      transition: width .25s ease; font:inherit;
    }
    .search input::placeholder{ color:var(--muted) }
    .search:focus-within input{ width:240px }

    /* Toggle buttons */
    .toggle{
      display:flex; gap:8px; background:var(--panel-2); padding:6px;
      border-radius:999px; border:1px solid rgba(0,0,0,0.06);
    }
    .btn{
      background:transparent; color:var(--text); border:none; border-radius:999px;
      padding:8px 12px; display:flex; align-items:center; gap:8px;
      cursor:pointer; transition: background .2s, transform .1s, box-shadow .2s;
    }
    .btn:hover{ background:rgba(0,0,0,0.06) }
    .btn:active{ transform: translateY(1px) }
    .btn svg{width:18px; height:18px}
    .btn.active{
      background:linear-gradient(90deg, rgba(125,211,252,0.18), rgba(167,243,208,0.15));
      box-shadow:0 0 0 2px rgba(125,211,252,0.18) inset;
    }

    /* Main content */
    .wrap{ padding:18px; z-index: 0; position:relative; margin-top: 36px; margin-bottom: 36px; flex: 1; }
    .grid{
      display:grid; grid-template-columns:repeat(auto-fill, minmax(240px, 1fr));
      gap:18px; align-items:stretch;
    }
    .list{ display:flex; flex-direction:column; gap:12px }

    /* Card / Item */
    .card {
      position: relative;
      transition: transform .2s ease, box-shadow .2s ease;
      z-index: 0;
      background:var(--panel);
      border-radius:var(--radius);
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      overflow: hidden;
      cursor: pointer;
    }
    .card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.15);
      z-index: 10;
    }

    .thumb{
      background:var(--panel-2);
      height:180px; display:flex; align-items:center; justify-content:center;
      overflow:hidden; position:relative;
    }
    .thumb canvas, .thumb img, .thumb iframe, .thumb embed{
      width:100%; height:100%; object-fit:cover; border-radius:12px;
    }
    .fmt-badge{
      position:absolute; bottom:10px; left:10px; padding:6px 10px;
      font-size:12px; font-weight:600; border-radius:999px;
      background:rgba(255,255,255,0.55); color:var(--text); border:1px solid rgba(0,0,0,0.1);
      backdrop-filter: blur(4px);
    }
    .fmt-pdf{ box-shadow:0 0 0 2px rgba(125,211,252,0.35) inset }
    .fmt-docx{ box-shadow:0 0 0 2px rgba(167,243,208,0.35) inset }
    .ai-badge {
        position: absolute;
        top: 10px;
        right: 10px;
        padding: 4px 8px;
        font-size: 11px;
        font-weight: 700;
        border-radius: 999px;
        background: var(--ai-pill);
        color: #000;
        box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        border: 1px solid rgba(0,0,0,0.1);
    }


    .body{ padding:12px 14px 14px }
    .title-line{
      font-weight:600; font-size:16px; margin:6px 0 6px; line-height:1.2;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .meta{
      display:flex; align-items:center; gap:8px; color:var(--muted); font-size:12px;
    }
    .meta .dot{ width:4px; height:4px; border-radius:50%; background:var(--muted) }

    .stats{
      margin-top:10px; display:flex; align-items:center; gap:12px; color:var(--muted); font-size:12px;
    }
    .stat{ display:inline-flex; align-items:center; gap:6px }
    .stat svg{ width:16px; height:16px; opacity:0.85 }

    .download-btn {
      background: var(--accent);
      color: #fff;
      border: none;
      padding: 6px;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    .download-btn svg {
      width: 18px;
      height: 18px;
      fill: #fff;
    }

    /* List view item */
    .row{
      display:grid; grid-template-columns:86px 1fr auto; gap:14px;
      align-items:center; background:var(--panel); border:1px solid rgba(0,0,0,0.06);
      border-radius:var(--radius); padding:10px; box-shadow:0 4px 12px rgba(0,0,0,0.05);
      transition: transform .2s, box-shadow .2s;
      cursor: pointer;
    }
    .row:hover{ transform: translateY(-1px) }
    .row .thumb{ height:66px; border-radius:12px }
    .row .main{
      display:grid; grid-template-columns: minmax(200px, 2fr) repeat(4, minmax(90px, 1fr));
      gap:10px; align-items:center;
    }
    .row .main .cell{ display:flex; align-items:center; gap:6px; min-width:0 }
    .row .title-line{ margin:0; font-size:15px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis }
    .row .right-end{ display:flex; align-items:center; gap:8px }

    /* Overlay viewer */
    .overlay{
      position:fixed; inset:0; background:rgba(255,255,255,0.72); backdrop-filter: blur(8px);
      display:none; z-index:1000; padding:20px;
      opacity:0; transition: opacity .2s ease;
    }
    .overlay.open{
      display:block;
      opacity:1;
    }
    .viewer{
      background:rgba(255,255,255,0.85);
      border:1px solid rgba(0,0,0,0.08);
      box-shadow:var(--shadow);
      border-radius:var(--radius-lg);
      height:100%; display:grid;
      grid-template-columns: 1fr minmax(280px, 360px);
      overflow:hidden;
      backdrop-filter: blur(16px);
    }
    .viewer .left{
      padding:12px; background:var(--panel-2); border-right:1px solid rgba(0,0,0,0.06);
    }
    .docframe{
      width:100%; height:100%; border:none; border-radius:12px; background:var(--panel-2);
    }
    .viewer .right{
      padding:16px; display:flex; flex-direction:column; gap:10px;
    }
    .viewer .right .title{ justify-content:flex-start; padding:0; font-size:22px }
    .kv{ color:var(--muted); font-size:13px; display:flex; gap:8px; align-items:center }
    .kv strong{ color:var(--text); font-weight:600 }
    .back{
      position:absolute; bottom:26px; left:26px; z-index:1001;
      background:rgba(255,255,255,0.4); color:var(--text); border:1px solid rgba(0,0,0,0.18);
      padding:8px 12px; border-radius:999px; display:flex; align-items:center; gap:8px;
      cursor:pointer; backdrop-filter: blur(4px);
      transition: transform .1s, background .2s, box-shadow .2s;
    }
    .back:hover{ background:rgba(255,255,255,0.5) }
    .back:active{ transform: translateY(1px) }

    .overlay-content {
        padding: 2rem;
        text-align: left;
        color: #333;
        line-height: 1.6;
        font-family: "Noto Sans", sans-serif;
        background: #fff;
        border-radius: 12px;
        height: 100%;
        overflow-y: auto;
    }
    .overlay-content h1, .overlay-content h2 {
        color: var(--text);
    }
    .overlay-content a {
        color: var(--accent);
        text-decoration: none;
    }
    .overlay-content a:hover {
        text-decoration: underline;
    }

    .styled-btn {
      background: var(--panel-2);
      color: var(--text);
      border: 1px solid rgba(0,0,0,0.08);
      border-radius: 999px;
      padding: 8px 12px;
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 500;
      cursor: pointer;
      transition: background .2s, transform .1s, box-shadow .2s;
      text-decoration: none; /* remove underline for links */
      font-size: 1rem;
    }
    .styled-btn:hover {
      background: rgba(0,0,0,0.06);
    }
    .styled-btn:active {
      transform: translateY(1px);
    }
    .styled-btn svg {
      width: 18px;
      height: 18px;
    }

    .styled-btn.download-accent {
      background: var(--accent);
      color: white;
      border-color: rgba(255,255,255,0.1);
    }
    .styled-btn.download-accent svg {
      fill: white;
    }


    /* Helpers */
    .pill{
      color:#001; background:var(--accent); border-radius:999px; padding:4px 8px; font-weight:700; font-size:12px;
    }
    .pill.docx{ background:var(--accent-2) }
    .pill.ai{ background:var(--ai-pill) }

    a.clean{ color:inherit; text-decoration:none; cursor: pointer; }
    .muted{ color:var(--muted) }
    .hide{ display:none }

    .icon-only {
      padding: 8px;
    }

    .sort-wrapper {
      position: relative;
    }

    .custom-dropdown {
      position: absolute;
      top: 110%;
      left: 0;
      background: var(--panel);
      border: 1px solid rgba(0,0,0,0.1);
      border-radius: 8px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.15);
      z-index: 20;
      display: flex;
      flex-direction: column;
      min-width: 180px;
      opacity: 0;
      pointer-events: none;
      transform: translateY(10px);
      transition: opacity 0.15s ease, transform 0.15s ease;
    }

    .custom-dropdown.open {
      opacity: 1;
      pointer-events: auto;
      transform: translateY(0);
    }
    
    .custom-dropdown .option {
        padding: 8px 12px;
        cursor: pointer;
        transition: background 0.15s;
    }

    .custom-dropdown .option:hover {
        background: rgba(125,211,252,0.1);
    }
    .custom-dropdown .option.active {
      background: var(--accent);
      color: white;
    }

    /* Footer */
    footer {
      background: var(--footer-bg);
      color: rgba(255,255,255,0.6);
      padding: 18px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: auto;
      font-size: 14px;
    }
    footer .left {
      display: flex;
      gap: 16px;
      align-items: center;
    }
    footer .left a {
      color: inherit;
      text-decoration: none;
      transition: color .2s;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    footer .left a:hover {
      color: rgba(255,255,255,0.9);
    }
    footer .left a .icon {
      width: 18px;
      height: 18px;
      fill: rgba(255,255,255,0.6);
    }
    footer .left a:hover .icon {
      fill: rgba(255,255,255,0.9);
    }
    .total-views {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .total-views .material-symbols-outlined {
      font-size: 20px;
      color: rgba(255,255,255,0.6);
    }
    .total-views span {
      font-weight: 600;
      color: rgba(255,255,255,0.9);
    }


    /* Small screens */
    @media (max-width: 860px){
      .viewer{ grid-template-columns: 1fr; }
      .viewer .right{ border-top:1px solid rgba(0,0,0,0.06) }
    }
  </style>
</head>
<body>

  <header>
    <div class="title-section">
      <div class="logo-container">
        <img src="resources/logo.svg" alt="OpenNotes Logo" class="title-logo" />
        <div class="line"></div>
        <p>
          the open platform for notes by 
          <a href="https://ingenium.rf.gd" target="_blank" rel="noopener">
            <img src="resources/ingenium.png" alt="Ingenium Logo" />
          </a>
        </p>
      </div>
    </div>
    <div class="controls">
      <select id="sortSelect" style="display:none">
        <option value="updated-desc" selected>Last updated ↓</option>
        <option value="updated-asc">Last updated ↑</option>
        <option value="title-asc">Title A→Z</option>
        <option value="title-desc">Title Z→A</option>
        <option value="format-asc">Format A→Z</option>
      </select>

      <select id="formatSelect" style="display:none">
        <option value="all" selected>All formats</option>
        <option value="pdf">PDF</option>
        <option value="docx">DOCX</option>
      </select>

      <div class="left">
        <div class="sort-wrapper">
          <button id="sortBtn" class="btn icon-only" title="Sort (Last Updated)">
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M3 4h18v2H3V4zm4 7h10v2H7v-2zm3 7h4v2h-4v-2z"/></svg>
          </button>
          <div id="sortDropdown" class="custom-dropdown hidden">
            <div data-sort="updated-desc" class="option active">Last updated ↓</div>
            <div data-sort="updated-asc" class="option">Last updated ↑</div>
            <div data-sort="title-asc" class="option">Title A→Z</div>
            <div data-sort="title-desc" class="option">Title Z→A</div>
            <div data-sort="format-asc" class="option">Format A→Z</div>
          </div>
        </div>
        <button id="typeBtn" class="btn">ALL</button>
        <div class="search" role="search">
          <svg viewBox="0 0 24 24" fill="currentColor"><path d="M15.5 14h-.79l-.28-.27a6.471 6.471 0 0 0 1.57-4.23C15.99 6.01 12.98 3 9.5 3S3.01 6.01 3.01 9.5 6.02 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
          <input id="searchInput" type="text" placeholder="Search notes..." aria-label="Search notes" />
        </div>
      </div>
      <div class="right">
        <button id="uploadBtn" class="btn icon-only" title="How to Upload">
          <span class="material-symbols-outlined">upload</span>
        </button>
        <div class="toggle" role="tablist" aria-label="View mode">
          <button id="gridBtn" class="btn active icon-only" aria-pressed="true" title="Box view">
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M3 3h8v8H3V3zm10 0h8v8h-8V3zM3 13h8v8H3v-8zm10 0h8v8h-8v-8z"/></svg>
          </button>
          <button id="listBtn" class="btn icon-only" aria-pressed="false" title="List view">
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M3 5h18v2H3V5zm0 6h18v2H3v-2zm0 6h18v2H3v-2z"/></svg>
          </button>
        </div>
      </div>
    </div>
  </header>

  <main class="wrap">
    <section id="itemsContainer" class="grid" aria-live="polite"></section>
  </main>

  <div id="overlay" class="overlay" aria-hidden="true">
    <button id="backBtn" class="back" aria-label="Back">
      <svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
      Back
    </button>
    <div class="viewer" role="dialog" aria-modal="true" aria-label="Document viewer">
      <div class="left">
        <iframe id="docFrame" class="docframe" title="Document preview"></iframe>
      </div>
      <div class="right">
        <div class="title" id="ovTitle">Title</div>
        <div class="kv"><span class="pill" id="ovFormat">PDF</span></div>
        <div class="kv">Date: <strong id="ovDate">—</strong></div>
        <div class="kv">Author: <strong id="ovAuthor">—</strong></div>
        <div class="kv">Views: <strong id="ovViews">0</strong></div>
        <div class="kv">Downloads: <strong id="ovDownloads">0</strong></div>
        <div style="margin-top:8px; display:flex; flex-direction:column; gap:10px;">
          <a id="ovOpenRaw" class="styled-btn" target="_blank" rel="noopener">
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M14 3v2h3.59l-9.83 9.83 1.41 1.41L19 6.41V10h2V3z"/><path d="M5 5h5V3H3v7h2z"/></svg>
            View Raw
          </a>
          <button id="ovDownload" class="styled-btn download-accent">
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M5 20h14v-2H5v2zM12 2v12l4-4h-3V2h-2v8H8l4 4z"/></svg>
            Download
          </button>
        </div>
      </div>
    </div>
  </div>

  <div id="infoOverlay" class="overlay" aria-hidden="true">
    <button id="infoBackBtn" class="back" aria-label="Back">
      <svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
      Back
    </button>
    <div class="viewer" style="grid-template-columns: 1fr;">
      <div class="overlay-content" id="infoContent"></div>
    </div>
  </div>

  <footer>
    <div class="left">
      <a href="#" class="info-link" data-md="resources/terms-privacy.md">Terms & Privacy</a>
      <a href="#" class="info-link" data-md="resources/contact.md">Contact Us</a>
      <a href="#" class="info-link" data-md="resources/about.md">About</a>
      <a href="https://github.com/Tebby2008/OpenNotes" target="_blank" rel="noopener">
        <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
          <path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.89 8.207 11.415.6.11.82-.26.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.043-1.61-4.043-1.61C4.425 18.043 3.6 17.062 3.6 17.062c-1.087-.744.084-.73.084-.73 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.493.996.108-.775.418-1.305.762-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.046.138 3.003.404 2.29-1.552 3.297-1.23 3.297-1.23.645 1.653.24 2.873.105 3.176.77.84 1.235 1.91 1.235 3.22 0 4.61-2.801 5.626-5.476 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.95 24 18.363 24 13.297c0-6.627-5.373-12-12-12"/>
        </svg>
        Github
      </a>
    </div>
    <div class="right total-views">
      <span class="material-symbols-outlined">visibility</span>
      <span id="websiteViews">0</span>
    </div>
  </footer>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
  <script>
    // --- Configuration (set these to your repo) ---
    const REPO_OWNER = "Tebby2008";
    const REPO_NAME = "OpenNotes";
    const BRANCH = "main";
    const NOTES_PATH = "Notes";
    const API_URL = "https://open-notes.tebby2008-li.workers.dev";

    (function tryAutoDetect(){
      try{
        const host = location.hostname;
        const path = location.pathname.replace(/^\/+/,'').split('/');
        const isPages = host.endsWith(".github.io");
        if(isPages){
          const owner = host.split(".github.io")[0];
          const repo = path[0] || REPO_NAME;
          if(REPO_OWNER.startsWith("<")) window['__owner']=owner;
          if(REPO_NAME.startsWith("<")) window['__repo']=repo;
        }
      }catch(e){}
    })();

    const owner = window.__owner || REPO_OWNER;
    const repo = window.__repo || REPO_NAME;

    // --- State ---
    let allItems = [];
    let viewMode = "grid";
    let sortKey = "updated-desc";
    let filterFormat = "all";
    let filterType = "all";
    let searchQuery = "";

    // --- Elements ---
    const container = document.getElementById("itemsContainer");
    const sortSelect = document.getElementById("sortSelect");
    const formatSelect = document.getElementById("formatSelect");
    const searchInput = document.getElementById("searchInput");
    const gridBtn = document.getElementById("gridBtn");
    const listBtn = document.getElementById("listBtn");
    const overlay = document.getElementById("overlay");
    const backBtn = document.getElementById("backBtn");
    const docFrame = document.getElementById("docFrame");
    const ovTitle = document.getElementById("ovTitle");
    const ovFormat = document.getElementById("ovFormat");
    const ovDate = document.getElementById("ovDate");
    const ovAuthor = document.getElementById("ovAuthor");
    const ovViews = document.getElementById("ovViews");
    const ovDownloads = document.getElementById("ovDownloads");
    const ovOpenRaw = document.getElementById("ovOpenRaw");
    const ovDownload = document.getElementById("ovDownload");
    const infoOverlay = document.getElementById("infoOverlay");
    const infoBackBtn = document.getElementById("infoBackBtn");
    const infoContent = document.getElementById("infoContent");
    const uploadBtn = document.getElementById("uploadBtn");
    const infoLinks = document.querySelectorAll('.info-link');
    const websiteViewsEl = document.getElementById('websiteViews');
    const sortBtn = document.getElementById("sortBtn");
    const sortDropdown = document.getElementById("sortDropdown");
    const typeBtn = document.getElementById("typeBtn");

    // --- Utils ---
    const sleep = (ms)=> new Promise(r=>setTimeout(r,ms));
    const fmtDate = (iso)=> {
      if(!iso) return "—";
      const d = new Date(iso);
      const dd = String(d.getDate()).padStart(2,'0');
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const yyyy = d.getFullYear();
      return `${dd}-${mm}-${yyyy}`;
    };
    const stripExt = (name)=> name.replace(/\.[^/.]+$/, "");
    const extOf = (name)=> (name.split('.').pop() || "").toLowerCase();

    // --- API Calls & Local State Updates ---
    async function incView(item) {
      try {
        const res = await fetch(`${API_URL}?type=note&noteId=${item.path}&counter=views`, { method: 'POST' });
        const data = await res.json();
        if (data && data.views !== undefined) {
          item.views = data.views;
          item.downloads = data.downloads;
          return { views: item.views, downloads: item.downloads };
        }
      } catch (e) {
        console.error('Failed to increment view count:', e);
      }
      return null;
    }
    async function incDownload(item) {
      try {
        const res = await fetch(`${API_URL}?type=note&noteId=${item.path}&counter=downloads`, { method: 'POST' });
        const data = await res.json();
        if (data && data.downloads !== undefined) {
          item.views = data.views;
          item.downloads = data.downloads;
          return { views: item.views, downloads: item.downloads };
        }
      } catch (e) {
        console.error('Failed to increment download count:', e);
      }
      return null;
    }
    async function incWebsiteView() {
      try {
        const res = await fetch(`${API_URL}?type=website&counter=views`, { method: 'POST' });
        const data = await res.json();
        if (data && data.views !== undefined) {
          return data.views;
        }
      } catch (e) {
        console.error('Failed to increment website view count:', e);
      }
      return null;
    }

    // --- Core Logic ---
    async function fetchNotes() {
      try {
        const url = `https://raw.githubusercontent.com/${owner}/${repo}/${BRANCH}/${NOTES_PATH}/notes_metadata.json`;
        const res = await fetch(url);
        if (!res.ok) throw new Error("Failed to fetch notes metadata");
        const data = await res.json();
        
        allItems = data.map(note => ({
          name: stripExt(note.name),
          path: note.path,
          url: note.download_url,
          format: extOf(note.name),
          author: note.author,
          updatedAt: note.last_updated,
          is_ai_generated: note.is_ai_generated || false,
          views: 0, // Placeholder
          downloads: 0 // Placeholder
        }));

        // Fetch view/download counts from the API
        const existingNoteKeys = new Set(allItems.map(item => item.path));
        const resCounts = await fetch(`${API_URL}?noteIds=${Array.from(existingNoteKeys).join(',')}`);
        if(resCounts.ok){
          const countsData = await resCounts.json();
          allItems.forEach(item => {
            const count = countsData[item.path];
            if(count){
              item.views = count.views || 0;
              item.downloads = count.downloads || 0;
            }
          });
        }

        render();

      } catch (e) {
        console.error(e);
        container.innerHTML = `
          <div style="background:var(--panel);border:1px solid rgba(255,255,255,0.08);border-radius:16px;padding:18px;">
            <div style="font-weight:600;font-size:18px;">Error Loading Notes</div>
            <p style="color:var(--muted)">We couldn't fetch the notes metadata. Please check the console for more details.</p>
          </div>
        `;
      }
    }

    function sortAndFilter() {
      const items = [...allItems];
      let filteredItems = items;

      // Filter by format
      if (filterFormat !== "all") {
        filteredItems = filteredItems.filter(item => item.format === filterFormat);
      }

      // Filter by AI-generated status
      if (filterType === "ai") {
        filteredItems = filteredItems.filter(item => item.is_ai_generated);
      } else if (filterType === "human") {
        filteredItems = filteredItems.filter(item => !item.is_ai_generated);
      }

      // Filter by search query
      if (searchQuery) {
        const query = searchQuery.toLowerCase();
        filteredItems = filteredItems.filter(item =>
          item.name.toLowerCase().includes(query) ||
          item.author.toLowerCase().includes(query)
        );
      }

      // Sort
      if (sortKey === "updated-asc") {
        filteredItems.sort((a, b) => new Date(a.updatedAt) - new Date(b.updatedAt));
      } else if (sortKey === "updated-desc") {
        filteredItems.sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt));
      } else if (sortKey === "title-asc") {
        filteredItems.sort((a, b) => a.name.localeCompare(b.name));
      } else if (sortKey === "title-desc") {
        filteredItems.sort((a, b) => b.name.localeCompare(a.name));
      } else if (sortKey === "format-asc") {
        filteredItems.sort((a, b) => a.format.localeCompare(b.format));
      }

      return filteredItems;
    }

    function render() {
      const items = sortAndFilter();
      container.innerHTML = items.length === 0 ? `
          <div style="background:var(--panel);border:1px solid rgba(0,0,0,0.06);border-radius:16px;padding:18px;">
            <div style="font-weight:600;font-size:18px;">No Notes Found</div>
            <p style="color:var(--muted)">Your search or filter criteria didn't match any notes. Try adjusting them.</p>
          </div>
        ` : "";

      items.forEach(item => {
        const el = viewMode === "grid" ? createItemCard(item) : createItemRow(item);
        container.appendChild(el);
      });

      container.className = viewMode;
    }

    function createItemCard(item) {
      const card = document.createElement("div");
      card.className = "card";
      card.setAttribute("data-path", item.path);
      card.innerHTML = `
        <div class="thumb">
          <span class="material-symbols-outlined" style="font-size:80px;color:var(--muted)">description</span>
          <span class="fmt-badge fmt-${item.format}">${item.format.toUpperCase()}</span>
          ${item.is_ai_generated ? `<span class="ai-badge">AI</span>` : ''}
        </div>
        <div class="body">
          <h3 class="title-line">${item.name}</h3>
          <div class="meta">
            <span>By ${item.author}</span>
            <span class="dot"></span>
            <span>${fmtDate(item.updatedAt)}</span>
          </div>
          <div class="stats">
            <div class="stat">
              <span class="material-symbols-outlined" style="font-size:16px;opacity:0.85">visibility</span>
              <span>${item.views}</span>
            </div>
            <div class="stat">
              <span class="material-symbols-outlined" style="font-size:16px;opacity:0.85">download</span>
              <span>${item.downloads}</span>
            </div>
          </div>
        </div>
      `;
      card.addEventListener('click', () => openNoteOverlay(item));
      return card;
    }

    function createItemRow(item) {
      const row = document.createElement("a");
      row.className = "row";
      row.setAttribute("data-path", item.path);
      row.innerHTML = `
        <div class="thumb">
          <span class="material-symbols-outlined" style="font-size:48px;color:var(--muted)">description</span>
          <span class="fmt-badge fmt-${item.format}">${item.format.toUpperCase()}</span>
          ${item.is_ai_generated ? `<span class="ai-badge">AI</span>` : ''}
        </div>
        <div class="main">
          <div>
            <div class="title-line">${item.name}</div>
          </div>
          <div class="cell">
            <span class="material-symbols-outlined muted" style="font-size:16px">person</span>
            <div class="muted" style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${item.author}</div>
          </div>
          <div class="cell">
            <span class="material-symbols-outlined muted" style="font-size:16px">calendar_month</span>
            <div class="muted">${fmtDate(item.updatedAt)}</div>
          </div>
          <div class="cell">
            <span class="material-symbols-outlined muted" style="font-size:16px">visibility</span>
            <div class="muted">${item.views}</div>
          </div>
          <div class="cell">
            <span class="material-symbols-outlined muted" style="font-size:16px">download</span>
            <div class="muted">${item.downloads}</div>
          </div>
        </div>
        <div class="right-end">
            <div class="download-btn">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M5 20h14v-2H5v2zM12 2v12l4-4h-3V2h-2v8H8l4 4z"/></svg>
            </div>
        </div>
      `;
      row.addEventListener('click', (e) => {
        if (!e.target.closest('.download-btn')) {
          openNoteOverlay(item);
        }
      });
      row.querySelector('.download-btn').addEventListener('click', (e) => {
        e.preventDefault();
        window.open(item.url, '_blank');
        incDownload(item).then(res => res && render());
      });
      return row;
    }
    
    function openNoteOverlay(item) {
        ovTitle.textContent = item.name;
        ovFormat.textContent = item.format.toUpperCase();
        ovFormat.className = `pill fmt-${item.format}`;
        if (item.is_ai_generated) {
            ovFormat.classList.add("ai");
        }
        ovDate.textContent = fmtDate(item.updatedAt);
        ovAuthor.textContent = item.author;
        ovViews.textContent = item.views;
        ovDownloads.textContent = item.downloads;
        ovOpenRaw.href = item.url;
        ovDownload.onclick = () => {
            window.open(item.url, '_blank');
            incDownload(item).then(res => res && render());
        };

        const gviewerUrl = `https://docs.google.com/gview?url=${encodeURIComponent(item.url)}&embedded=true`;
        docFrame.src = gviewerUrl;

        overlay.classList.add('open');
        overlay.setAttribute('aria-hidden', 'false');

        // Increment view count
        incView(item).then(res => {
            if (res) {
                ovViews.textContent = res.views;
                ovDownloads.textContent = res.downloads;
                render();
            }
        });
    }

    function closeNoteOverlay() {
      overlay.classList.remove('open');
      overlay.setAttribute('aria-hidden', 'true');
      docFrame.src = ""; // Clear iframe to stop playback/memory leak
    }

    function openInfoOverlay(mdFile) {
      infoOverlay.classList.add('open');
      infoOverlay.setAttribute('aria-hidden', 'false');
      fetch(mdFile).then(res => res.text()).then(text => {
        infoContent.innerHTML = marked.parse(text);
      }).catch(e => {
        infoContent.innerHTML = `<p style="color:var(--muted)">Failed to load content. Please try again later.</p>`;
      });
    }

    function closeInfoOverlay() {
      infoOverlay.classList.remove('open');
      infoOverlay.setAttribute('aria-hidden', 'true');
      infoContent.innerHTML = "";
    }

    // --- Event Listeners ---
    searchInput.addEventListener("input", (e) => {
      searchQuery = e.target.value.trim();
      render();
    });

    gridBtn.addEventListener("click", () => {
      viewMode = "grid";
      gridBtn.classList.add("active");
      listBtn.classList.remove("active");
      render();
    });

    listBtn.addEventListener("click", () => {
      viewMode = "list";
      listBtn.classList.add("active");
      gridBtn.classList.remove("active");
      render();
    });

    backBtn.addEventListener('click', closeNoteOverlay);
    infoBackBtn.addEventListener('click', closeInfoOverlay);

    infoLinks.forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        const mdFile = link.getAttribute('data-md');
        if (mdFile) {
          openInfoOverlay(mdFile);
        }
      });
    });

    uploadBtn.addEventListener('click', () => {
      openInfoOverlay('resources/how-to-upload.md');
    });
    
    // Custom dropdown logic
    sortBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        sortDropdown.classList.toggle('open');
    });

    sortDropdown.querySelectorAll('.option').forEach(option => {
        option.addEventListener('click', (e) => {
            sortKey = e.target.dataset.sort;
            sortDropdown.classList.remove('open');
            // Update the active state and button text (optional, but good UX)
            sortDropdown.querySelectorAll('.option').forEach(opt => opt.classList.remove('active'));
            e.target.classList.add('active');
            sortBtn.title = `Sort (${e.target.textContent.trim()})`;
            render();
        });
    });

    document.addEventListener('click', (e) => {
        if (!sortDropdown.contains(e.target) && !sortBtn.contains(e.target)) {
            sortDropdown.classList.remove('open');
        }
    });

    typeBtn.addEventListener('click', () => {
        const types = ["all", "human", "ai"];
        const currentIndex = types.indexOf(filterType);
        const nextIndex = (currentIndex + 1) % types.length;
        filterType = types[nextIndex];

        let buttonText = "ALL";
        if (filterType === "human") {
            buttonText = "HUMAN";
        } else if (filterType === "ai") {
            buttonText = "AI";
        }
        typeBtn.textContent = buttonText;
        render();
    });

    // --- Initialization ---
    document.addEventListener('DOMContentLoaded', () => {
        fetchNotes();
        // incWebsiteView().then(newViews => {
        //     if (newViews !== null) {
        //         websiteViewsEl.textContent = newViews;
        //     }
        // });
    });

  </script>
</body>
</html>
